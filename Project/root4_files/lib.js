function isset(variable){return(typeof(window[variable])!="undefined");}
function parseSize(cssSize){if(cssSize)
return parseFloat(cssSize.replace(/px|em/,""));else return false;}
$.fn.safeHide=function(){return $(this).css({position:'absolute',top:'-9999px',visibility:'hidden'});};$.fn.safeShow=function(){return $(this).css({position:'',top:'',visibility:''});};$.fn.safeSlideUp=function(callback){return $(this).animate({height:0,paddingTop:0,paddingBottom:0,marginTop:0,marginBottom:0},500,function(){$(this).safeHide().css({height:'',paddingTop:'',paddingBottom:'',marginTop:'',marginBottom:''});if(callback){callback.call(this);}});};$.fn.safeSlideDown=function(callback){var paddingTop=$(this).css('paddingTop');var paddingBottom=$(this).css('paddingBottom');var marginTop=$(this).css('marginTop');var marginBottom=$(this).css('marginBottom');var height=$(this).height();return $(this).safeShow().css({height:0,paddingTop:0,paddingBottom:0,marginTop:0,marginBottom:0}).animate({height:height+'px',paddingTop:paddingTop,paddingBottom:paddingBottom,marginTop:marginTop,marginBottom:marginBottom},500,function(){$(this).css({height:'',paddingTop:'',paddingBottom:'',marginTop:'',marginBottom:''}).safeShow();if(callback){callback.call(this);}});};$.fn.safeFadeIn=function(callback){var opacity=$(this).css('opacity');return $(this).safeShow().css({opacity:0}).animate({opacity:opacity},300,function(){$(this).css({opacity:''});if(callback){callback.call(this);}});};$.fn.safeFadeOut=function(callback){return $(this).animate({opacity:0},300,function(){$(this).safeHide().css({opacity:''});if(callback){callback.call(this);}});};(function(){var initializing=false,fnTest=/xyz/.test(function(){xyz;})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(prop){var _super=this.prototype;initializing=true;var prototype=new this();initializing=false;for(var name in prop){prototype[name]=typeof prop[name]=="function"&&typeof _super[name]=="function"&&fnTest.test(prop[name])?(function(name,fn){return function(){var tmp=this._super;this._super=_super[name];var ret=fn.apply(this,arguments);this._super=tmp;return ret;};})(name,prop[name]):prop[name];}
function Class(){if(!initializing&&this.init)
this.init.apply(this,arguments);}
Class.prototype=prototype;Class.constructor=Class;Class.extend=arguments.callee;return Class;};})();var RMUIWidgetRelay=(function(){var _name="RMUIWidgetRelay";var _callbacks={};return{addCallback:function(type,caller,callback,args){if(_callbacks[type]===undefined){_callbacks[type]=new Array();}
if(!this.callbackExists(type,caller,callback,args)){_callbacks[type].push({caller:caller,fn:callback,args:args});}},callbackExists:function(type,caller,callback,args){if(_callbacks[type]===undefined){return false;}
var callbackObj;for(var i=0;i<_callbacks[type];i++){callbackObj=_callbacks[type][i];if(callbackObj.caller==caller&&callbackObj.callback==callback&&callbackObj.args==args){return true;}}
return false;},relayEvent:function(type,args){var callbacks=_callbacks[type];if(callbacks===undefined){debug(_name+'::relayEvent, no callbacks registered for type '+type+'!');return false;}
for(var i=0;i<callbacks.length;i++){try{if(args){callbacks[i]['fn'].call(callbacks[i]['caller'],args,callbacks['args'],RMUIWidgetRelay);}else{callbacks[i]['fn'].call(callbacks[i]['caller'],callbacks[i]['args'],RMUIWidgetRelay);}}catch(err){debug(_name+'::relayEvent, error relaying event type '+type+' to listeners: '+err);}}}};})();var RMUIEvent=(function(){return{EDITOR_MODE_CHANGE:'editor-mode-change',STATE_CHANGE:'state-change',UPDATE:'update',STYLE_CHANGE:'style-change',STYLE_SAVE:'style-save',STYLE_SELECT:'style-select'};})();var RMUIWidget=Class.extend({STATE_DISABLED:'disabled',STATE_ENABLED:'enabled',STATE_ACTIVE:'active',STATE_INACTIVE:'inactive',_name:'RMUIWidget',_domTarget:false,_origDom:false,_active:false,_callbacks:false,_enabled:true,_enableGlobalCallbacks:true,_saveData:{},_saveRuleData:{},init:function(targetElement,options){if(this._name){this._name=this._name;}
this._callbacks={};this._saveData={};this._saveRuleData={};this._enabled=true;this._enableGlobalCallbacks=true;if(options&&options.hasOwnProperty('enableGlobalCallbacks')){this._enableGlobalCallbacks=options.enableGlobalCallbacks;}
if(this._enableGlobalCallbacks){this.addGlobalCallback(RMUIEvent.EDITOR_MODE_CHANGE,this,this.changeMode);}
this.setTarget(targetElement);},setTarget:function(target,copy){if(copy===undefined){copy=false;}
if(typeof(target)==='string'){target=$(target);}
if(!target.selector&&target.length<1){debug(this._name+'::setTarget, invalid target given - either no DOM node or not a valid jQuery object');return false;}
if(this.getTarget()&&!copy){this.uninstall();}
try{this._origDom=target.clone(true);}catch(err){debug(this._name+'::setTarget, an error occurred cloning the original dom: '+err,'warn');}
this._domTarget=target;this.install();},getTarget:function(){return this._domTarget;},install:function(){var target=this.getTarget();if(!target){debug(this._name+'::install: ERROR, attempted install without setting DOM target!');return false;}
var assoc_widgets=target.data('widgets');if(!assoc_widgets){assoc_widgets=new Array();}
assoc_widgets.push(this);target.data('widgets',assoc_widgets).addClass('rm-widget');target.data(this._name,this);},uninstall:function(){var target=this.getTarget();if(!target){debug(this._name+'::uninstall: ERROR, attempted to uninstall before install!');return false;}
var assoc_widgets=target.data('widgets');for(var i=0;i<assoc_widgets.length;i++){if(assoc_widgets[i]==this){assoc_widgets.splice(i,1);}}
target.data('widgets',assoc_widgets).removeClass('rm-widget');if(assoc_widgets.length==0){target.removeData('widgets');}
var insertionPoint=target.next();if(insertionPoint.length){insertionPoint.before(this._origDom);}else{target.parent().append(this._origDom);}
target.remove();return this._origDom;},enable:function(){this._enabled=true;this.getTarget().removeClass('disabled');},disable:function(){this._enabled=false;this.getTarget().addClass('disabled');},isEnabled:function(){return this._enabled;},isActive:function(){return this._active;},activate:function(){if(!this.isEnabled()||this.isActive()||!this.getTarget())return false;this._active=true;return true;},deactivate:function(){if(!this.isEnabled()||!this.isActive()||!this.getTarget()){return false;}
this._active=false;return true;},changeMode:function(mode){switch(mode){case'css':this.disable();break;case'content':this.enable();break;default:break;}},copy:function(){return this._origDom.clone();},setSaveData:function(key,val,rule){var store=this._saveData;if(rule&&typeof(rule)==='string'){if(!this._saveRuleData[rule]){this._saveRuleData[rule]={};}
store=this._saveRuleData[rule];}
store[key]=val;return this;},clearSaveData:function(key){if(this._saveData.hasOwnProperty(key)){delete(this._saveData[key]);}
return this;},getSaveData:function(rule){if(rule&&this._saveRuleData.hasOwnProperty(rule)){return this._saveRuleData[rule];}else if(!rule){return this._saveData;}
return{};},processUserEvent:function(event,doSuper){return false;},addCallback:function(type,caller,callback,args){if(this._callbacks[type]){var len=this._callbacks[type].length;if(this._callbacks[type][len]&&this._callbacks[type][len][caller].fn!=callback){this._callbacks[type][len]={caller:caller,fn:callback,args:args};}else{this._callbacks[type][len]={};this._callbacks[type][len]={caller:caller,fn:callback,args:args};}}else{this._callbacks[type]=new Array();this._callbacks[type][0]={};this._callbacks[type][0]={caller:caller,fn:callback,args:args};}
return this;},addGlobalCallback:function(type,caller,callback,args){RMUIWidgetRelay.addCallback(type,caller,callback,args);return this;},triggerEvent:function(type,args,localized){if(localized===undefined){localized=true;}
if(this._callbacks[type]){debug(this._name+'::triggerEvent('+type+'): triggering event to listeners');for(var i=0;i<this._callbacks[type].length;i++){try{var arg_list=new Array();if(args!==undefined){arg_list.push(args);}
if(this._callbacks[type][i]['args']!==undefined){arg_list.push(this._callbacks[type][i]['args']);}
arg_list.push(this);this._callbacks[type][i]['fn'].apply(this._callbacks[type][i]['caller'],arg_list);}catch(err){debug(err);}}}
if(!localized){RMUIWidgetRelay.relayEvent(type,args);}
return this;},getWidget:function(name,domTarget){if(name===undefined){name=this._name;}
if(domTarget===undefined){domTarget=this._domTarget;}
var assoc_widgets=this.getWidgets(domTarget);if(!assoc_widgets){debug(this._name+'::getWidget, no associated widget data exists!');return false;}
for(var i=0;i<assoc_widgets.length;i++){if(assoc_widgets[i]._name==name){return assoc_widgets[i];}}
return false;},getWidgets:function(target){if(!target){target=this.getTarget();if(!target){debug(this._name+'::getWidgets, ERROR: invalid DOM target node');return false;}}
return target.data('widgets');}});var VideoPlayerWidget=RMUIWidget.extend({_name:'VideoPlayerWidget',VIDEO_TYPE_YOUTUBE:'youtube',VIDEO_TYPE_VIMEO:'vimeo',VIDEO_STATE_UNSTARTED:'state-unstarted',VIDEO_STATE_PLAYING:'state-playing',VIDEO_STATE_PAUSED:'state-paused',DOM:{modal:'<div id="rm-video-modal">'+'<div class="rm-video-container rc-m">'+'<div class="rm-video-wrapper"></div>'+'<p class="rm-video-caption hidden"></p>'+'<div class="rm-video-controls">'+'<a href="#close-video" class="rm-ui-button rc-m small rm-video-close-button" title="Close video?">Close</a>'+'</div>'+'</div>'+'</div>'},CSS:{'#rm-video-modal':{position:'absolute',top:'0px',left:'0px',width:'100%',height:'100%','z-index':10001},'#rm-video-modal .rm-video-container':{'-webkit-box-shadow':'rgba(0, 0, 0, 0.199219) 0px 5px 15px',background:'#ffffff',margin:'30px auto 0',padding:'20px'},'#rm-video-modal .rm-video-controls':{padding:'10px 0 10px','text-align':'center'}},init:function(target,options){this._super(target,options);if(options){this.setOptions(options);}
this.videos={};this.state=this.VIDEO_STATE_UNSTARTED;this.current_video=false;},install:function(){this._super();debug(this._name+'::install, starting install...');var $target=this.getTarget();var $overlay=$target.children('.modal-shade');if($overlay.length<1){$overlay=$('<div class="modal-shade"></div>').hide();}
this.getTarget().prepend($overlay);this.$modal_shade=$overlay;this.$modal=$(this.DOM.modal).safeHide().appendTo($target).delegate('.rm-video-container','click',function(event){event.stopPropagation();return false;}).delegate('.rm-video-close-button','click',$.proxy(function(event){this.deactivate();},this));var youtubeHandler=window['onYouTubePlayerReady'];window['onYouTubePlayerReady']=$.proxy(function(yt_player_id){if(typeof(youtubeHandler)==='function'){youtubeHandler.apply(null,[yt_player_id]);}
var player=document.getElementById(yt_player_id);player.addEventListener('onStateChange','onYouTubeStateChange');},this);window['onYouTubeStateChange']=$.proxy(this,'handleYouTubeStateChange');debug(this._name+'::install, finished install!');this.style();},style:function(){var style_str='';for(var rule in this.CSS){style_str+=rule+'{ ';for(var prop in this.CSS[rule]){style_str+=prop+': '+this.CSS[rule][prop]+';\n';}
style_str+='}';}
var $style=$('style[name=rm-video-player]','head');if($style.length>0){$style.html(style_str);}else{$style=$('<style name="rm-video-player" type="text/css">'+style_str+'</style>').appendTo('head');}},setOptions:function(options,allowed,filters){for(var key in options){if(allowed){if(allowed.indexOf(key)<0){continue;}}
if(filters&&filters[key]){var filter=filters[key];if(typeof(filter)==='function'){if(!filter.apply(this,[options[key],key])){continue;}}}
this[key]=options[key];}},activate:function(){this._super();this.$modal_shade.fadeIn($.proxy(function(){this.$modal.safeFadeIn().find('.rm-video-container').css({width:this.getCurrentVideo().width+'px'});},this));this.getTarget().one('click',$.proxy(function(event){this.deactivate();},this));},deactivate:function(){this._super();this.stop();this.$modal.safeSlideUp($.proxy(function(){this.$modal_shade.fadeOut();},this));},load:function(id,container,type){if(!container){container=this.$modal.find('.rm-video-wrapper');}
if(!type){type=this.VIDEO_TYPE_YOUTUBE;}
var src='',params={autoplay:1},flashvars={allowFullScreen:true,allowScriptAccess:'always'},width=780,height=520;switch(type){case this.VIDEO_TYPE_YOUTUBE:src='http://www.youtube.com/v/'+id;$.extend(params,{enablejsapi:1,version:3,hl:'en_US',rel:0,playerapiid:'rm-video-swf-'+id});break;case this.VIDEO_TYPE_VIMDEO:src='http://www.vimeo.com/'+id;$.extend(params,{});break;}
src+='?';for(var key in params){src+=key+'='+params[key]+'&';}
src=src.substr(0,src.length-1);var video={id:id,type:type,container:container,type:type,src:src,params:params,flashvars:flashvars,width:width,height:height};var $dom=$('<div id="rm-video-'+video.id+'" class="rm-video"></div>');$(container).append($dom);$dom.flash({swf:video.src,id:'rm-video-swf-'+id,width:width,height:height,allowFullScreen:true,allowScriptAccess:'always',wmode:'transparent',flashvars:video.flashvars});this.videos[id]=video;},isLoaded:function(id){if(!id){id=this.current_video;}
return(this.videos[id]!==undefined);},play:function(id,options){if(!id){id=this.current_video;}
if(!this.isLoaded(id)){this.load(id);}else{var video=this.videos[id],player=document.getElementById('rm-video-swf-'+id);switch(video.type){case this.VIDEO_TYPE_YOUTUBE:player.playVideo();break;case this.VIDEO_TYPE_VIMEO:break;}}
this.current_video=id;if(options){this.videos[id]=$.extend(this.videos[id],options);}
$('#rm-video-'+id).safeShow().siblings().safeHide();if(!this.isActive()){this.activate();}},pause:function(id){if(!id){id=this.current_video;}
if(!this.isLoaded(id)){return false;}
var video=this.videos[id],player=document.getElementById('rm-video-swf-'+id);switch(video.type){case this.VIDEO_TYPE_YOUTUBE:player.pauseVideo();break;case this.VIDEO_TYPE_VIMEO:break;}},stop:function(id){if(!id){id=this.current_video;}
var video=this.videos[id],player=document.getElementById('rm-video-swf-'+id);switch(video.type){case this.VIDEO_TYPE_YOUTUBE:player.stopVideo();break;case this.VIDEO_TYPE_VIMEO:break;}},getCurrentVideo:function(){return this.videos[this.current_video];},handleYouTubeStateChange:function(state){var video=this.getCurrentVideo();switch(state){case-1:break;case 0:debug('VIDEO COMPLETE!',video,'warn');this.deactivate();if(video.complete){debug('firing complete handler...');video.complete();}
break;case 1:case 2:case 3:case 5:default:break;}}});var Saver=(function(){var _callbacks={before:new Array(),success:new Array(),error:new Array()};var _savers=new Array();var supported_attrs=['href','id','name','rel','src','title'];function _runCallbacks(save_type,callbacks,data){for(var i=0;i<callbacks.length;i++){if(save_type&&(!callbacks[i].save_types||callbacks.save_types.indexOf(save_type)>=0)){callbacks[i].callback.call(callbacks[i].caller,data);}}}
function saveSuccessCallbacks(save_type,data,custom_callback,custom_first){if(custom_callback&&custom_first){custom_callback.call(document,data);}
_runCallbacks(save_type,_callbacks.success,data);if(custom_callback&&!custom_first){custom_callback.call(document,data);}}
function saveBeforeCallbacks(save_type,data,custom_callback,custom_first){if(custom_callback&&custom_first){custom_callback.call(document,data);}
_runCallbacks(save_type,_callbacks.before,data);if(custom_callback&&!custom_first){custom_callback.call(document,data);}}
function saveErrorCallbacks(save_type,data,custom_callback,custom_first){if(custom_callback&&custom_first){custom_callback.call(document,data);}
_runCallbacks(save_type,_callbacks.error,data);if(custom_callback&&!custom_first){custom_callback.call(document,data);}}
function _createPostData(saver,data,elem){var post_data={};for(var key in saver.data){var value=saver.data[key];debug('checking key '+key+': '+value);if(typeof(value)==='string'){if(value.match(/^\:param/)){debug('parameter token detected for key '+key);if(value.indexOf('.')<0){value=data;}else{var property_tokens=value.split('.');if(property_tokens){property_tokens.shift();if(property_tokens.length<1){value=data;}else{var node=$.extend(true,{},data);for(var i=0;i<property_tokens.length;i++){if(typeof(node)!=='object'||!node.hasOwnProperty(property_tokens[i])){debug("Couldn't create post data, error parsing data format "+key+": "+value);node=undefined;break;}
node=node[property_tokens[i]];
}
value=node;}}else{value=data;}}}else{var regex=false;for(var i=0;i<supported_attrs.length;i++){regex=new RegExp('^\\:'+supported_attrs[i]);debug('checking regex for '+supported_attrs[i]+': '+value.match(regex));if(value.match(regex)){value=elem.attr(supported_attrs[i]);break;}}}}
post_data[key]=value;
}
return post_data;}
return{triggerSuccessCallbacks:function(data){saveSuccessCallbacks(null,data);},triggerErrorCallbacks:function(data){saveErrorCallbacks(null,data);},triggerBeforeCallbacks:function(data){saveBeforeCallbacks(null,data);},registerCallbacks:function(caller,callbacks,save_types){if(!callbacks){debug('Saver::registerCallbacks, no callbacks provided!');return;}
if(callbacks.hasOwnProperty('start')){Saver.registerBeforeCallback(caller,callbacks.start,save_types);}
if(callbacks.hasOwnProperty('success')){Saver.registerSuccessCallback(caller,callbacks.success,save_types);}
if(callbacks.hasOwnProperty('error')){Saver.registerErrorCallback(caller,callbacks.error,save_types);}},registerBeforeCallback:function(caller,callback,save_types){if(!callback){debug('Saver::registerBeforeCallback, no callback provided!');return;}
_callbacks.before.push({caller:caller,callback:callback,save_types:save_types});},registerSuccessCallback:function(caller,callback,save_types){if(!callback){debug('Saver::registerBeforeCallback, no callback provided!');return;}
_callbacks.success.push({caller:caller,callback:callback,save_types:save_types});},registerErrorCallback:function(caller,callback,save_types){if(!callback){debug('Saver::registerBeforeCallback, no callback provided!');return;}
_callbacks.error.push({caller:caller,callback:callback,save_types:save_types});},
addSaveRule:
function(name,url,save_data,type)
{	
	
	if(!name||!url||!save_data)
	{
		debug('Saver::addSaver, name, url, and save_data all required parameters!');
		return;
	}
	
	if(!type)
	{
		type='POST';
	}

	var saver={name:name,url:url,data:save_data,http_type:type};
	var indx=false;

	if((indx=_savers.indexOfProp('name',name))>=0)
	{
		_savers[indx]=saver;		
	}
	else
	{
		_savers.push(saver);
	}

}
,removeSaveRule:function(save_type){if(!save_type){debug('Saver::removeSaver, save identifier not given, save_type='+save_type);return;}
var indx=false;if((indx=_savers.indexOfProp('name',save_type))>=0){_savers.splice(indx,1);}},save:function(name,data,options){if(!name){debug('Saver::save, no save identifier given! name= '+name);return false;}
var on_before=false;var on_success=false;var on_error=false;var callbacks_first=false;var elem=false;for(var opt in options){switch(opt){case'before':on_before=options[opt];break;case'success':on_success=options[opt];break;case'error':on_error=options[opt];break;case'callFirst':callbacks_first=Boolean(options[opt]);break;case'callPrevent':break;case'elem':elem=options[opt];break;default:debug('Saver::save, invalid option detected: '+opt);break;}}
var indx=_savers.indexOfProp('name',name);if(indx===-1){debug('Saver::save, no saver found with name= '+name);return false;}
var saver=_savers[indx];try{var post=_createPostData(saver,data,elem);debug(post);debug(saver.http_type);saveBeforeCallbacks(saver.name,post,on_before,callbacks_first);$.ajax({type:saver.http_type,url:saver.url,data:post,dataType:'json',success:function(data,txtstatus){if(data&&data.returnStatus&&data.returnStatus.loggedIn){debug('Saver returnStatus a logged in: '+data.returnStatus.loggedIn);}else{debug('Saver returnStatus a logged in: NO RETURN DATA');}
if(!data.returnStatus.hasOwnProperty('status')||data.returnStatus.loggedIn<1){showError("You have been logged out. If you did not log out of Facebook, you probably have third-party cookies disabled.\n\nPlease enable third party cookies in your web browser in order for "+getGlobal('vendor')+" to be able to communicate with Facebook.");window.location="/logout";return false;}
if(!data||!data.hasOwnProperty('returnStatus')){saveErrorCallbacks(saver.name,data,on_error,callbacks_first);return false;}
if(!data.returnStatus.hasOwnProperty('status')||data.returnStatus.status<0){saveErrorCallbacks(saver.name,data.returnStatus,on_error,callbacks_first);return false;}
saveSuccessCallbacks(saver.name,data,on_success,callbacks_first);},error:function(data,txtstatus){saveErrorCallbacks(saver.name,data,on_error,callbacks_first);debug('Saver returnStatus b logged in: '+data.returnStatus.loggedIn);if(!data.returnStatus.hasOwnProperty('status')||data.returnStatus.loggedIn<1){showError("You have been logged out. If you did not log out of Facebook, you probably have third-party cookies disabled.\n\nPlease enable third party cookies in your web browser in order for "+getGlobal('vendor')+" to be able to communicate with Facebook.");window.location="/logout";return false;}}});}catch(exception){debug('Saver::save, error making save call: '+exception);}}};})();var SaveNotifier=Class.extend({init:function(){this.install();Saver.registerCallbacks(this,{start:this.beforeSave,success:this.saveSuccess,error:this.error});},install:function(){this._notifier=$("<div id='rm-save-notifier'></div>").hide().css({position:'fixed',top:'0px',left:'50%',zIndex:10000});this._container=$("<div></div>").css({backgroundColor:"#555555",backgroundImage:"url(http://b.ak.static-rootmusic.com/images/common/bg/bg_page_gradient_small.png?v=2.70)",backgroundPosition:"bottom",backgroundRepeat:"repeat-x",color:"#dddddd",padding:"5px 10px 8px",position:"relative",left:"-50%",textAlign:"center",zIndex:1}).appendTo(this._notifier);this._messageBox=$("<span class='save-message'>Saving...</span>").css({marginTop:"5px"}).appendTo(this._container);this._loaderGif=$("<img src='http://a.ak.static-rootmusic.com/images/common/ajax-save-loader.gif?v=2.70' />").css({margin:"3px 0 0 10px"}).appendTo(this._container);this._notifier.appendTo($('body'));},beforeSave:function(){this._container.css({backgroundColor:"#555555",color:"#dddddd"});this._messageBox.text("Saving...");this._loaderGif.show();if(this._notifier.is(':hidden')){this._notifier.fadeIn().animate({opacity:1},1000);}},saveSuccess:function(){this._notifier.fadeOut();},error:function(errData){debug('SaveNotifier::error',errData,'error');this._container.css({backgroundColor:"#dddddd",color:"#000000"});this._messageBox.text('Please try again');this._loaderGif.hide();this._notifier.animate({opacity:1},1000).fadeOut();}});var RMFBAutoshare=(function(){var enableAutoshare=function(targetButton,callback){if(targetButton&&targetButton.data('rmPageId')){targetButton.attr('disabled','disabled').animate({opacity:0.5},250,function(){$(this).addClass('disabled');});$.ajax({type:"post",url:"/saveajax/updateUseAutoshare/",data:{autoshare:true,rmPageId:parseInt(targetButton.data('rmPageId'))},dataType:"json",success:function(data,txtstatus){if(data.returnStatus.status<0){showError("Save autoshare settings, something went wrong: "+data.returnStatus.description);if(targetButton){targetButton.css({opacity:1}).removeAttr('disabled').removeClass('disabled');}}
if(callback){targetButton.css({opacity:1}).removeAttr('disabled').removeClass('disabled');callback.call(this,data);}},error:function(data,txtstatus){if(targetButton){targetButton.css({opacity:1}).removeAttr('disabled').removeClass('disabled');}}});}else{debug('RMFBAutoshare::enableAutoshare: an error occurred: rm id missing from button');}};var checkHasAppInstalled=function(fbPageId,callback){$.ajax({type:"post",data:{fbPageId:fbPageId},dataType:"json",cache:false,url:"/getajax/isAppInstalled/",success:function(data,txtstatus){callback.call(this,data);}});};var checkHasSharePermission=function(fbPageId,callback){$.ajax({type:"post",data:{fbPageId:fbPageId},dataType:"json",cache:false,url:"/getajax/hasSharePermission/",success:function(data,txtstatus){callback.call(this,data);}});};var revokeSharePermission=function(callback){$.ajax({type:"get",dataType:"json",cache:false,url:"/getajax/revokeSharePermission/",success:function(data,txtstatus){callback.call(this,data);}});};var defaultButtonHandler=function(event){var autoshareButton=$(event.currentTarget);RMFBAutoshare.request(autoshareButton,function(){autoshareButton.fadeOut(function(){$(this).parent().append('<p class="message info">Autoshare activated! You can now edit your Autoshare settings from the <a href="/settings" title="'+getGlobal('brand')+' Settings">settings</a> page.</p>');});});};return{init:function(targetButton,callback){debug('RMFBAutoshare::init');if(targetButton&&!targetButton.data('hasInstalledApp')){targetButton.attr('disabled','disabled').addClass('loading').addClass('disabled').text('Checking status...');checkHasAppInstalled(targetButton.data('fbPageId'),function(installed){targetButton.data('hasInstalledApp',installed);if(installed===true){targetButton.text('Verifying with FB...');checkHasSharePermission(targetButton.data('fbPageId'),function(share){targetButton.data('hasSharePermissions',share);if(share===true){targetButton.removeAttr('disabled').removeClass('disabled').removeClass('loading').text('Enable Autoshare');}else{revokeSharePermission(function(revoked){targetButton.removeAttr('disabled').removeClass('disabled').removeClass('loading').text('Enable Autoshare');});}
if(callback&&typeof(callback)=='function'){debug('calling callback.');callback.call(targetButton);}else{targetButton.click(defaultButtonHandler);}});}else{targetButton.removeClass('loading').removeAttr('href').text(getGlobal('brand')+' not installed');}});}else{debug('RMFBAutoshare::init: no source button, or init already ran');}},request:function(targetButton,callback){if(targetButton&&targetButton.data('hasInstalledApp')===true){if(false&&targetButton.data('hasSharePermissions')===true){enableAutoshare(targetButton,callback);}else{FB.login(function(response){if(response.session&&response.perms&&response.perms.indexOf('publish_stream')>-1){enableAutoshare(targetButton,callback);}else{debug('AutoSharePerms::enable: user cancelled.');}},{perms:'publish_stream',profile_selector_ids:targetButton.data('fbPageId')});}}else{debug('RMFBAutoshare::requestAutoshare: no source button, hasInstalledApp not set or false');}}};})();var RMUIUtility=Class.extend({init:function(){},getWidget:function(name,domTarget){if(!name){debug('RMUIUtility::getWidgets - "name" parameter is not set.','error');return false;}
var el=$(domTarget);if(!el){debug('RMUIUtility::getWidgets - Not a valid DOM element:',domTarget,'error');return false;}
var assocWidgets=this.getWidgets(el);if(!assocWidgets){debug('RMUIUtility::getWidget - No associated widgets found for element:',domTarget,'error');return false;}
$.each(assocWidgets,function(indx,widget){if(widget._name==name){return widget;}});return eval('new '+name+'('+el+');');},getWidgets:function(target){var el=$(target);if(!el){debug('RMUIUtility::getWidgets - Can\'t find widgets for element:',target,'error');return false;}
return el.data('widgets');}});var ModalUtility=RMUIUtility.extend({_domTarget:false,_content:false,_window:false,_overlay:false,_callback:false,_caller:false,_callbackArgs:[],_fullSize:false,_loading:false,init:function(targetElement,fullSize,formHTML){this._super(targetElement);if(typeof(targetElement)==='string'){targetElement=$(targetElement);}
this._domTarget=targetElement;this._name="ModalUtility";this._enabled=true;this._fullSize=fullSize;this._loading=false;this.install();},install:function(){this._overlay=$('<div class="editor-modal-layer modal-layer"></div>');this._window=$('<div class="floating-window"></div>');if(this._fullSize){this._window.addClass('full');}
this._window.appendTo(this._overlay);this._overlay.appendTo(this._domTarget).hide();},enable:function(){this._enabled=true;},disable:function(){this._enabled=false;},activate:function(){var _modalWindow=this;this._overlay.fadeIn('slow',function(){_modalWindow.scrollToView();});if(__inputs=this._content.find("input[name='cancel']"))__inputs.bind('click',{utility:this},this.cancelHandler);$(".modal-close").bind('click',{utility:this},this.cancelHandler);$("body").bind('click',{utility:this},this.cancelHandler);this._window.bind('click',function(e){e.stopPropagation();});if((this._window.height()+100)<$(window).height()){$(window).bind('scroll',{widget:this},this.handleScroll);}
if(this._callback){this._callback.call(this._caller,this._callbackArgs);}},deactivate:function(){$(".modal-close").unbind('click',this.cancelHandler);$("body").unbind('click',this.cancelHandler);this._window.unbind('click');this._overlay.fadeOut('slow');$(window).unbind('scroll',this.handleScroll);},showDialog:function(content,callback){if(this._enabled){if(content){this._content=$(content);this._window.empty().append(content).wrapInner("<div></div>");this._window.children('div').append("<a class='editor-main-hover-close modal-close' href='#close'>X</a>");var __form=false;if(__form=this._window.find("form")){__form.bind('submit',{utility:this},this.submitHandler);}}
$('.hidden',this._window).removeClass('hidden').hide();if(typeof(callback)=='array'){this._callback=callback[0];if(caller.length>1){this._caller=caller[1];if(caller.length>2){this._callbackArgs=caller[2];}}}else if(typeof(callback)=='function'){this._callback=callback;}
this.activate();}},showLoadingDialog:function(){if(this._enabled){this._loading=true;this._content=$('<p class="loading">Loading...</p>');this._window.empty().append(this._content).wrapInner('<div></div>');this.activate();}},getCurrentContent:function(){return this._window.children('div').children();},hasContent:function(){return this._content!=false;},getWindow:function(){return this._window;},setError:function(msg){this._error={status:-1,msg:msg};return this._error;},setFullFrame:function(fullSize){this._fullSize=fullSize;if(fullSize){this.getWindow().addClass('full');}else{this.getWindow().removeClass('full');}},submitHandler:function(e){var data={};$(e.currentTarget).children("input[type='text']").each(function(){data[$(this).attr("name")]=$(this).val();});if(e.data.utility._callback){e.data.utility._callback.call(e.data.utility._caller,data);}
e.data.utility.deactivate();return false;},cancelHandler:function(e){e.data.utility.setError('user cancelled');e.data.utility.deactivate();return false;},scrollToView:function(){var scrollDiff=(Math.max($(window).scrollTop(),45)-this._domTarget.offset().top);this._window.stop().animate({top:scrollDiff+'px',marginTop:($(window).scrollTop()>45)?0:'50px'},250);},handleScroll:function(event){if(event.data.widget._window.height()+100<$(window).height()){event.data.widget.scrollToView();}
return false;}});var InlineEditWidget=RMUIWidget.extend({_name:"InlineEditWidget",_multi:false,_contentArea:false,_inputArea:false,_dom:{input:false},init:function(targetElement,options){this._super(targetElement,options);if(options){this._multi=options.hasOwnProperty('multi')?options.multi:false;this._aggregate=options.hasOwnProperty('aggregate')?options.aggregate:'array';}},install:function(){this._super();var target=this.getTarget();var tagName='span';switch(target.css('display')){case'block':tagName='div';target.addClass('block');break;case'none':tagName=target.get(0).tagName.toLowerCase();if(tagName=='div'){target.addClass('block');}
break;case'inline-block':case'inline':default:tagName='span';break;}
this._inputArea=$('<'+tagName+' class="rm-inline-edit-input"></'+tagName+'>');this._inputArea.append($(this._dom.input));this._contentArea=$('<'+tagName+' class="rm-inline-edit-content"></'+tagName+'>').html(target.html());if(this._multi){$("<a href='#remove-this' class='rm-inline-edit-multiremove'>remove</a>").bind('click',{widget:this},this.processUserEvent).appendTo(this._contentArea);}
target.empty().append(this._contentArea).append(this._inputArea);this._contentArea.attr('tabindex',0);this._inputArea.hide();if(!target.hasClass('disabled')){this.enable();}},enable:function(){this._super();this._contentArea.css({cursor:'pointer'});this._contentArea.bind('mouseenter',{widget:this},this.processUserEvent).bind('mouseleave',{widget:this},this.processUserEvent);this._contentArea.bind('click focus',{widget:this},this.processUserEvent);this._contentArea.bind('blur',{widget:this},this.processUserEvent);this.getTarget().bind('click',this.processUserEvent);},disable:function(){this._super();this._contentArea.css({cursor:''});this._contentArea.unbind('mouseenter',this.processUserEvent).unbind('mouseleave',this.processUserEvent);this._contentArea.unbind('click focus',this.processUserEvent);this._contentArea.unbind('blur',this.processUserEvent);this.getTarget().unbind('click',this.processUserEvent);},activate:function(){if(!this._super()){return false;}
this._contentArea.hide();this._inputArea.show();$('body').bind('click',{widget:this},this.processUserEvent);return true;},deactivate:function(){if(!this._super())return false;this._inputArea.hide();this._contentArea.show();$('body').unbind('click',this.processUserEvent);if(this.needsUpdate()){this.commit();}
return true;},commit:function(){this._contentArea.css({border:'none'});this.triggerEvent('update');},needsUpdate:function(){return true;},processUserEvent:function(event,doSuper){if(doSuper)return this._super(event);if(event.data.widget._enabled){switch(event.type){case'mouseenter':$(event.currentTarget).css({borderBottom:'1px dotted #000',marginBottom:'-1px'});break;case'mouseleave':$(event.currentTarget).css({borderBottom:'none',marginBottom:'0px'});break;case'click':switch(event.currentTarget){case event.data.widget._contentArea.get(0):event.data.widget.activate();break;case event.data.widget._domTarget.get(0):event.stopPropagation();return false;break;case $('body').get(0):event.data.widget.deactivate();break;default:debug(event.data.widget._name+'::processUserEvent(click): couldn\'t match element for:');debug(event.currentTarget);break;}
break;case'focus':if(event.currentTarget==event.data.widget._contentArea.get(0)){event.data.widget.activate();}
break;case'blur':if(event.currentTarget==event.data.widget._contentArea.get(0)){event.data.widget.deactivate();}
break;default:break;}}}});var TextInlineEditWidget=InlineEditWidget.extend({_inputField:false,_autoSave:true,_activeFeedbackTimer:false,_prompt:'',init:function(targetElement,options){this._name="TextInlineEditWidget";this._autoSave=true;this._multiline=$(targetElement).hasClass('multiline');this._prompt='';if(options){if(options.hasOwnProperty('autoSave')){this._autoSave=options.autoSave;}
if(options.hasOwnProperty('multiline')){this._multiline=options.multiline;}
if(options.hasOwnProperty('prompt')){this._prompt=options.prompt;}}
this._dom.input=(this._multiline)?"<textarea rows='4' cols='40'></textarea>":"<input type='text' />";if(!this._prompt){switch(targetElement.attr('name')){case"bio":this._prompt="Enter bio here.";break;case"location":this._prompt="Enter your city";break;case"youtube-video":case"add-yt-track":this._prompt="Paste the YouTube link here";break;case"vimeo-video":this._prompt="Paste the Vimeo link here";break;case'emailAddress':this._prompt='Email address';break;case'emailTitle':case'websiteTitle':this._prompt='[optional] Display text';break;case'websiteUrl':this._prompt='Website URL';break;case'genreCustom':this._prompt='Custom Genre';break;default:if(targetElement.attr('name').search(/edit-buy-link/i)>=0){this._prompt="Online store link";}
break;}}
this._super(targetElement,options);},install:function(targetElement){this._super(targetElement);if(this._domTarget.text().trim()==''){this._empty=true;}
this._inputField=this._inputArea.children();this._inputField.attr({name:this._domTarget.attr('name')}).addClass('rm-input-field');if(this._multiline){this._inputField.val(this._contentArea.html().replace(/\r?\n/ig,'').replace(/<br[ \/]*>/ig,"\n"));}else this._inputField.val(this._contentArea.text());this._contentArea.children('input').bind('focus',{widget:this},function(e){e.data.widget.activate();});this.checkForEmpty();this.refreshCSS();},activate:function(){if(!this._super())return false;this._inputField.bind('keydown',{widget:this},function(e){switch(e.keyCode){case 9:case 13:if(e.data.widget._domTarget&&!e.data.widget._multiline){e.data.widget.deactivate();}
break;case 27:e.data.widget.cancel();e.data.widget.deactivate();default:break;}}).bind('blur',{widget:this},this.processUserEvent);this.refreshCSS();this._inputField.focus();},deactivate:function(){this._super();this._inputField.unbind('keydown blur',this.processUserEvent);if(this._multiline&&!this._empty){this._contentArea.html(this._inputField.val().replace(/\r?\n/ig,'<br />'));}
if(this._activeFeedbackTimer){clearInterval(this._activeFeedbackTimer);}},enable:function(){this._super();if(this._empty&&this._domTarget.is(':hidden')){this._domTarget.show();}},disable:function(){this._super();if(this._empty){this._domTarget.hide();}},changeMode:function(mode){this._super(mode);switch(mode){case'css':this.disable();break;case'content':this.enable();break;default:break;}},commit:function(){this._empty=(this._inputField.val().trim().length<1);var data=this._inputField.val();if(this._domTarget.hasClass("multi")){var others=this._domTarget.siblings(".multi[name='"+this._inputField.attr("name")+"']");others.each(function(){data+=' '+$(this).data('TextInlineEditWidget')._contentArea.text();});}
switch(this._inputField.attr("name")){case"rm-track-title":if(data.length>255){data=data.substring(0,254);this._inputField.val(data);}
break;case"show-price":if(data.length>31){data=data.substring(0,30);this._inputField.val(data);}
break;case"show-venue":if(data.length==0){var showCityParentDiv=this._inputField.parent().parent().next().children(".rm-inline-edit-content");showCityParentDiv.click();showCityParentDiv.next().children('input[name="show-city"]').val("");$('div#main-container').click();}
break;case"twitter":data=data.replace("http://","").replace("www.","").replace("twitter.com/","");if(data.length>20){data=data.substring(0,20);}
this._inputField.val(data);break;case"twitterList":if(data.length>25){data=data.substring(0,25);this._inputField.val(data);}
break;case"rssFeed":data=data.replace("feed://http://","http://").replace("feed://","http://").replace("feed:http","http");this._inputField.val(data);break;default:if(this._inputField.attr('name').toLowerCase().match('edit-ticket-link-')||this._inputField.attr('name').toLowerCase().match('rm-track-purchase-url'))
{if(this.isUrl(data))
{this._inputField.val(data);this._inputArea.css({outline:''});this._contentArea.css({outline:''});}
else
{this._inputArea.css({outline:'2px solid #cc0000'});this._contentArea.css({outline:'2px solid #cc0000'});this._inputField.val(data);}}
break;}
if(this._multiline){var convertedContent=this._inputField.val().replace(/\r?\n/ig,'<br />');if(convertedContent.length>0){this._contentArea.html(convertedContent);}else{this._contentArea.text(convertedContent);}
data=convertedContent;}else{this._contentArea.text(this._inputField.val());}
if(this._autoSave){debug(this._name+'::commit(): auto saving {'+this._inputField.attr('name')+': '+data+'}');if(this._inputField.attr('name').toLowerCase().match('edit-ticket-link-')&&!this.isUrl(data))
{}
else
{Saver.save(this._inputField.attr('name'),data,{elem:this._inputField});}}
this.checkForEmpty();this._super();},getStoredData:function(){var storedData={};storedData[this._domTarget.attr('name')]=this._inputField.val();return storedData;},cancel:function(){this._inputField.val(this._contentArea.text());},needsUpdate:function(){return(this._contentArea.text()!=this._inputField.val());},checkForEmpty:function(){if(this._empty){if(this._multiline){this._contentArea.html('<textarea class="empty" name="'+this._inputField.attr('name')+'" ></textarea>');}else{this._contentArea.html('<input type="text" class="empty" name="'+this._inputField.attr('name')+'" />');}
this._contentArea.css({opacity:0.5}).children().val(this._prompt);this._contentArea.children("textarea, input").bind('focus',{widget:this},function(e){e.data.widget.activate();});}else{this._contentArea.css({opacity:''});if(this._domTarget.hasClass('wrap-em')){var wrapped='<em>'+this._contentArea.html()+'</em>';this._contentArea.html(wrapped);}}},refreshCSS:function(){var css={backgroundColor:this._domTarget.css('backgroundColor'),color:this._domTarget.css('color'),fontSize:this._domTarget.css('fontSize'),fontFamily:this._domTarget.css('fontFamily'),fontWeight:this._domTarget.css('fontWeight'),fontStyle:this._domTarget.css('fontStyle')};this._inputField.css(css);},copy:function(){var ret=this._super();ret.text(this._contentArea.text());return ret;},clear:function(){this._inputField.val('');this._contentArea.text('');this._empty=true;this.checkForEmpty();},setValue:function(value,save){if(!value){this.clear();}else{this._inputField.val(value);if(!this._multiline){this._contentArea.text(value);}else{this._contentArea.html(value.replace(/\r?\n/ig,'<br />'));}
this._empty=false;this.checkForEmpty();}
if(save){this.commit();}},getValue:function(){return this._inputField.val();},processUserEvent:function(event,doSuper){if(doSuper)return this._super(event);switch(event.type){case'blur':event.data.widget.deactivate();break;}
event.stopPropagation();if(event.data&&event.data.widget)return event.data.widget.processUserEvent(event,true);},isUrl:function(s){var startsWithSlash=/^\/.*/;var startsWithHttpPrefix=/^https?:\/\/.*/;var prefixedString=s;if(!startsWithHttpPrefix.test(s))
{prefixedString="http://"+prefixedString;}
var RegExp=/^https?:\/\/.*\.[\w]{1,4}(\W|$).*/;return((!startsWithSlash.test(s)&&RegExp.test(prefixedString))||s.length<=0);}});var ListSelectionWidget=RMUIWidget.extend({_name:"ListSelectionWidget",_value:false,_defaultValue:false,_selections:{list:false,html:false},_dom:{pane:false,field:false},_saverName:false,_clearLock:false,init:function(targetElement,options){debug(this._name+'::init');if(options&&options.hasOwnProperty('defaultValue')){this._defaultValue=options.defaultValue;}else{this._defaultValue='';}
if(options&&options.hasOwnProperty('saverName')){this._saverName=options.saverName;debug(this._name+':: will save as : '+options.saverName);}
if(options&&options.hasOwnProperty('pane')){this._dom.pane=options.pane;}
if(options&&options.hasOwnProperty('field')){this._dom.field=options.field;if(this._dom.field!=targetElement){debug(this._name+':: selectionField forced to targetElement ');this._dom.field=targetElement;}}
if(options&&options.hasOwnProperty('list')){this._selections.list=options.list;}
debug(this._name+' : and field classes : '+this._dom.field.attr('class'));this._super(targetElement,options);},install:function(targetElement){this._super(targetElement);var initialValue=this._domTarget.text();if(this._dom.field==false){this._dom.field=$('<span class="rm-list-selection-field">'+initialValue+'</span>');this._domTarget.html(this._dom.field);}
if(this._dom.pane==false){this._dom.pane=$('<div class="rm-list-selection-pane"></div>');this._domTarget.append(this._dom.pane);}
if(this._selections.list!=false){buildListHtml();installListHtml();}
if(!initialValue||initialValue.length<1){initialValue=this._defaultValue;this._dom.field.html(initialValue);}
this._value=this._dom.field.text();},enable:function(){debug(this._name+'::enable');this._super();$('li',this._dom.pane).bind('mouseenter mouseleave click',{widget:this},this.selectionEvent).attr('tabindex',0);$(':checkbox',this._dom.pane).bind('mouseup',{widget:this},this.checkEvent);},disable:function(){debug(this._name+'::disable');this._super();$('li',this._dom.pane).unbind('mouseenter mouseleave click',this.selectionEvent).removeAttr('tabindex');$(':checkbox',this._dom.pane).unbind('mouseup',this.checkEvent);},buildListHtml:function(listOfSelections){this._selections.html=$('<ul class="rm-selections"></ul>');if(!listOfSelections){listOfSelections=this._selections.list;if(!listOfSelections){debug(this._name+'::buildListHtml: error : no list');listOfSelections=new Array();}}
var i;for(i=0;i<listOfSelections.length;i++){this._selections.html.append('<li><input type="checkbox" /><span class="ls-value">'+listOfSelections[i]+'</span></li>');}
return this._selections.html;},installListHtml:function(htmlOfSelections){if(!htmlOfSelections){htmlOfSelections=this._selections.html;}
if(htmlOfSelections.children('li').length<1){debug(this._name+'::instalListHtml: error : list is empty');}
this._dom.pane.html(htmlOfSelections);this.cleanPane();},cleanPane:function(){debug(this._name+'::cleanPane');$('.hover',this._dom.pane).removeClass('hover');$('.selected',this._dom.pane).removeClass('selected');$(':checked',this._dom.pane).removeAttr('checked');selected=this._value;$('li',this._dom.pane).each(function(){if($(this).children('.ls-value').text()==selected){$(this).addClass('selected').children('input').attr('checked','checked');}});},commit:function(newValue){debug(this._name+'::commit to value = '+newValue);if(newValue==this._default){newValue='';}
if(this._dom.field.text()==''){this._dom.field.text()==this._default;}
if(this._saverName!=false){this._dom.field.html(newValue.replace(/&/g,'&amp;'));debug(this._saverName+':: saving '+newValue);Saver.save(this._saverName,newValue,{elem:this._domTarget});}
this._value=newValue;this.triggerEvent('update');},selectionEvent:function(event){var selection=$(event.currentTarget);var widget=event.data.widget;var newValue=selection.children('.ls-value').text();switch(event.type){case'mouseenter':selection.addClass('hover');widget.triggerEvent('hoverIn');break;case'mouseleave':selection.removeClass('hover');widget.triggerEvent('hoverOut');widget.cleanPane();break;case'click':debug(widget._name+'::selectionEvent: '+event.type+' : '+newValue);if(!selection.hasClass('selected')){widget.commit(newValue);widget.cleanPane();}else if(selection.hasClass('selected')){widget.commit(widget._default);widget.cleanPane();}
break;default:debug(widget._name+':: error : event type not found');break;}},checkEvent:function(event){debug('checkEvent');$(event.currentTarget).attr('checked','checked');}});var GenreSevenWidget=RMUIWidget.extend({_name:"GenreSevenWidget",_genreSelection:{main1:false,sub1:false,main2:false,sub2:false,main3:false,sub3:false},_domGenreA:{tab:false,mainField:false,subField:false,btnClear:false},_domGenreB:{tab:false,mainField:false,subField:false,btnClear:false},_domGenreC:{tab:false,mainField:false,subField:false,btnClear:false,customField:false,customInput:false},_domPane:{target:false,list:false,head:false,foot:false,menu:false},_wrapperDom:false,_activeGroup:false,_listOfGenres:false,_htmlOfGenres:false,_genreReady:false,_genreNameMap:false,_customGenreWidget:false,init:function(targetElement,options){debug(this._name+'::init');var widget=this;var getListOfGenres=new Array(new Array);$.ajax({url:'/getajax/getGenreMap/',type:'post',dataType:'json',success:function(json,response){if(response=='success'){widget._genreNameMap=json.genreNameMap;for(var mainGenre in json.genreNameMap){getListOfGenres[0].push(mainGenre);getListOfGenres.push(json.genreNameMap[mainGenre]);}
widget._listOfGenres=getListOfGenres;widget.buildGenres();}else{debug('GenreSevenWidget:: getGenreMap : '+response);}}});this._super(targetElement);},install:function(){this._super();this._wrapperDom=$('#editor-main-hover-layer');this._domGenreA.tab=$('#editor-genre-one',this._domTarget);this._domGenreA.mainField=$('[rel=main]',this._domGenreA.tab);this._domGenreA.subField=$('[rel=sub]',this._domGenreA.tab);this._domGenreA.btnClear=$('[rel=clear]',this._domGenreA.tab);this._domGenreB.tab=$('#editor-genre-two',this._domTarget);this._domGenreB.mainField=$('[rel=main]',this._domGenreB.tab);this._domGenreB.subField=$('[rel=sub]',this._domGenreB.tab);this._domGenreB.btnClear=$('[rel=clear]',this._domGenreB.tab);this._domGenreC.tab=$('#editor-genre-three',this._domTarget);this._domGenreC.mainField=$('[rel=main]',this._domGenreC.tab);this._domGenreC.subField=$('[rel=sub]',this._domGenreC.tab);this._domGenreC.btnClear=$('[rel=clear]',this._domGenreC.tab);this._domGenreC.customField=$('[rel=custom]',this._domGenreC.tab);this._domPane.target=$('#genre-pane',this._domTarget);this._domPane.head=$('.pane-head',this._domPane.target);this._domPane.list=$('.select-list',this._domPane.target);this._domPane.foot=$('.pane-foot',this._domPane.target);this._domPane.menu=$('.genre-menu',this._domPane.target);this._domPane.head.css('opacity',0);this._domPane.foot.css('opacity',0);var mainGenreList=this._listOfGenres[0];this._genreSelection.main1=new ListSelectionWidget(this._domGenreA.mainField,{defaultValue:'Genre',pane:this._domPane.list,field:this._domGenreA.mainField});this._genreSelection.main1.addCallback('update',this,this.selectGenreEvent,{widget:this,subwidget:this._genreSelection.main1});this._domGenreA.mainField.data('ListSelectionWidget',this._genreSelection.main1).data('default','Genre');this._genreSelection.main1._name='ListSelectionWidget-main1';this._genreSelection.main2=new ListSelectionWidget(this._domGenreB.mainField,{defaultValue:'Genre',pane:this._domPane.list,field:this._domGenreB.mainField});this._genreSelection.main2.addCallback('update',this,this.selectGenreEvent,{widget:this,subwidget:this._genreSelection.main2});this._domGenreB.mainField.data('ListSelectionWidget',this._genreSelection.main2).data('default','Genre');this._genreSelection.main2._name='ListSelectionWidget-main2';this._genreSelection.main3=new ListSelectionWidget(this._domGenreC.mainField,{defaultValue:'Genre',pane:this._domPane.list,field:this._domGenreC.mainField});this._genreSelection.main3.addCallback('update',this,this.selectGenreEvent,{widget:this,subwidget:this._genreSelection.main3});this._domGenreC.mainField.data('ListSelectionWidget',this._genreSelection.main3).data('default','Genre');this._genreSelection.main3._name='ListSelectionWidget-main3';this._genreSelection.sub1=new ListSelectionWidget(this._domGenreA.subField,{defaultValue:'Genre',pane:this._domPane.list,field:this._domGenreA.subField});this._genreSelection.sub1.addCallback('update',this,this.selectGenreEvent,{widget:this,subwidget:this._genreSelection.sub1});this._domGenreA.subField.data('ListSelectionWidget',this._genreSelection.sub1).data('default','Genre');this._genreSelection.sub1._name='ListSelectionWidget-sub1';this._genreSelection.sub2=new ListSelectionWidget(this._domGenreB.subField,{defaultValue:'Genre',pane:this._domPane.list,field:this._domGenreB.subField});this._genreSelection.sub2.addCallback('update',this,this.selectGenreEvent,{widget:this,subwidget:this._genreSelection.sub2});this._domGenreB.subField.data('ListSelectionWidget',this._genreSelection.sub2).data('default','Genre');this._genreSelection.sub2._name='ListSelectionWidget-sub2';this._genreSelection.sub3=new ListSelectionWidget(this._domGenreC.subField,{defaultValue:'Genre',pane:this._domPane.list,field:this._domGenreC.subField});this._genreSelection.sub3.addCallback('update',this,this.selectGenreEvent,{widget:this,subwidget:this._genreSelection.sub3});this._domGenreC.subField.data('ListSelectionWidget',this._genreSelection.sub3).data('default','Genre');this._genreSelection.sub3._name='ListSelectionWidget-sub3';this._domGenreC.customInput=$('.rm-inline-edit',this._domPane.foot);this._customGenreWidget=new TextInlineEditWidget(this._domGenreC.customInput,{autoSave:true});this._customGenreWidget.addCallback('update',this,this.selectGenreEvent,{widget:this,subwidget:this._customGenreWidget});this._domGenreC.customField.data('default',this._customGenreWidget._prompt);for(var subWidget in this._genreSelection){this._genreSelection[subWidget].disable();}
this._domPane.target.height(0).hide();this.enable();},activate:function(){if(!this._super()||!this._genreReady)return false;this.selectingGenreTab();$('body').bind('mousedown',{widget:this},this.processUserEvent);this._wrapperDom.bind('mousedown',{widget:this},this.processUserEvent);this._domPane.target.bind('click',{widget:this},this.processUserEvent);this._domPane.menu.find('a').bind('click mouseenter mouseleave',{widget:this},this.processUserEvent);this._domPane.target.focus();},deactivate:function(){if(!this._super())return false;this._domPane.target.animate({height:0},{duration:500});$('body').unbind('mousedown',this.processUserEvent);this._wrapperDom.unbind('mousedown',this.processUserEvent);this._domPane.target.unbind('click',this.processUserEvent);this._domPane.menu.find('a').unbind('click mouseenter mouseleave',this.processUserEvent);$('.active-tab',this._domTarget).removeClass('active-tab');$('.selecting',this._domTarget).removeClass('selecting');},enable:function(){this._super();$('.rm-genre-tab',this._domTarget).attr('tabindex',0).bind('mouseenter mouseleave click',{widget:this},this.processUserEvent);$('.rm-genre-tab span',this._domTarget).attr('tabindex',0).bind('mouseenter mouseleave',{widget:this},this.processUserEvent);$('.rm-genre-tab [rel=clear]',this._domTarget).attr('tabindex',0).bind('click',{widget:this},this.processUserEvent);this.updateVisibleField();},disable:function(){if(this._active){this.deactivate();}
this._super();$('.rm-genre-tab',this._domTarget).attr('tabindex',0).unbind('mouseenter mouseleave click',this.processUserEvent);$('.rm-genre-tab span',this._domTarget).attr('tabindex',0).unbind('mouseenter mouseleave',this.processUserEvent);$('.rm-genre-tab [rel=clear]',this._domTarget).attr('tabindex',0).unbind('click',this.processUserEvent);this._domGenreA.btnClear.hide();this._domGenreB.btnClear.hide();this._domGenreC.btnClear.hide();for(var subWidget in this._genreSelection){this._genreSelection[subWidget].disable();}},buildGenres:function(){this._htmlOfGenres=new Array();var i;var ulLi='<ul class="rm-selections"><li><span class="ls-value">genre</span></li></ul>';for(i=0;i<this._listOfGenres.length;i++){ulLi=this._genreSelection.main1.buildListHtml(this._listOfGenres[i]);$('li',ulLi).addClass('rc-xs');this._htmlOfGenres.push(ulLi);}
for(i=0;i<this._listOfGenres[0].length;i++){$('li:eq('+i+')',this._htmlOfGenres[0]).append('<em class="rc-xs">'+this._listOfGenres[i+1].length+'</em>');}
this._genreReady=true;},updateVisibleField:function(){if(this._domGenreA.mainField.text().length>0&&this._domGenreA.mainField.text()!=this._domGenreA.mainField.data('default')){this._domGenreA.btnClear.show();}else{this._domGenreA.btnClear.hide();}
if(this._domGenreB.mainField.text().length>0&&this._domGenreB.mainField.text()!=this._domGenreB.mainField.data('default')){this._domGenreB.btnClear.show();}else{this._domGenreB.btnClear.hide();}
if((this._domGenreC.mainField.text().length>0&&this._domGenreC.mainField.text()!=this._domGenreC.mainField.data('default'))||(this._domGenreC.customField.text().length>0&&this._domGenreC.customField.text()!=this._domGenreC.customField.data('default'))){this._domGenreC.btnClear.show();}else{this._domGenreC.btnClear.hide();}
if(this._domGenreA.subField.text().length>0&&this._domGenreA.subField.text()!=this._domGenreA.subField.data('default')){this._domGenreA.mainField.hide();this._domGenreA.subField.show();}else{this._domGenreA.mainField.show();this._domGenreA.subField.hide();}
if(this._domGenreB.subField.text().length>0&&this._domGenreB.subField.text()!=this._domGenreB.subField.data('default')){this._domGenreB.mainField.hide();this._domGenreB.subField.show();}else{this._domGenreB.mainField.show();this._domGenreB.subField.hide();}
if(this._domGenreC.customField.text().length>0&&this._domGenreC.customField.text()!=this._domGenreC.customField.data('default')){this._domGenreC.mainField.hide();this._domGenreC.subField.hide();this._domGenreC.customField.show();}else if(this._domGenreC.subField.text().length>0&&this._domGenreC.subField.text()!=this._domGenreC.subField.data('default')){this._domGenreC.mainField.hide();this._domGenreC.subField.show();this._domGenreC.customField.hide();}else{this._domGenreC.mainField.show();this._domGenreC.subField.hide();this._domGenreC.customField.hide();}},processUserEvent:function(event){var eventTarget=$(event.currentTarget);var widget=event.data.widget;if(widget._enabled){switch(event.type){case'mouseenter':eventTarget.addClass('hover');break;case'mouseleave':eventTarget.removeClass('hover');break;case'click':case'focus':switch(eventTarget.attr('rel')){case'close-pane':widget.deactivate();break;case'tab':if(!eventTarget.hasClass('active-tab')){$('.active-tab',widget._domTarget).removeClass('active-tab');eventTarget.addClass('active-tab');}
if(widget._active){widget.selectingGenreTab();}else{widget.activate();}
break;case'clear':if(!eventTarget.parent().hasClass('active-tab')){$('.active-tab',widget._domTarget).removeClass('active-tab');eventTarget.parent().addClass('active-tab');}
widget.clearActiveTab();return true;break;case'menu-btn':widget.backToMain();case widget._domTarget.attr('rel'):widget.activate();break;case widget._domPane.target.attr('rel'):break;default:debug(widget._name+'::processUserEvent(click): couldn\'t match element for: '+eventTarget.attr('class'));break;}
break;case'mousedown':if(event.currentTarget==widget._wrapperDom.get(0)){event.stopPropagation();}else if(event.currentTarget==$('body').get(0)){widget.deactivate();}
break;default:debug(widget._name+'::processUserEvent: could not match event for: '+event.type);break;}}
event.stopPropagation();},selectingGenreTab:function(){var activeTab=$('.active-tab',this._domTarget).attr('id');var fieldText=this._domGenreA.mainField.data('ListSelectionWidget')._value;var defaultText=this._domGenreA.mainField.data('default');if(fieldText.length>0&&fieldText!=defaultText){switch(activeTab){case'editor-genre-one':this._activeGroup=this._domGenreA;debug('active A');break;case'editor-genre-two':this._activeGroup=this._domGenreB;debug('active B');break;case'editor-genre-three':this._activeGroup=this._domGenreC;debug('active C');break;}
fieldText=this._activeGroup.mainField.data('ListSelectionWidget')._value;defaultText=this._activeGroup.mainField.data('default');var state=0;if(fieldText.length>0&&fieldText!=defaultText&&this._genreNameMap[fieldText].length>0){state=this.getMainGenreId();}
this._domPane.list.data('newState',state);}else{$('.active-tab',this._domTarget).removeClass('active-tab');this._domGenreA.tab.addClass('active-tab');this._activeGroup=this._domGenreA;this._domPane.list.data('newState',0);}
$('.selecting',this._domTarget).removeClass('selecting');if(this._domPane.list.data('newState')==0){this._activeGroup.mainField.addClass('selecting');}else{this._activeGroup.subField.addClass('selecting');}
this.clearAndRefresh();},backToMain:function(){this._domPane.list.data('newState',0);$('.selecting',this._domTarget).removeClass('selecting');this._activeGroup.mainField.addClass('selecting');var scrollBox=$('#editor-main-hover-scroll',this._wrapperDom);var topPosition=this._domTarget.position().top;if(scrollBox.scrollTop()>topPosition){scrollBox.animate({scrollTop:topPosition},{duration:500});}
this.clearAndRefresh();},clearAndRefresh:function(){for(var subWidget in this._genreSelection){this._genreSelection[subWidget].disable();}
var widget=this;if(this._listOfGenres[this._domPane.list.data('newState')].length<1){this._domPane.list.data('newState',0);this._domPane.list.data('widget',widget).animate({'opacity':1},{duration:0,complete:widget.refreshList});}else{this._domPane.head.not(':hidden').animate({'opacity':0},{duration:200});this._domPane.foot.not(':hidden').animate({'opacity':0},{duration:200});this._domPane.menu.not(':hidden').animate({'opacity':0},{duration:200});this._domPane.list.data('widget',widget).css({'opacity':1}).animate({'opacity':0},{duration:200,complete:widget.refreshList});}},refreshList:function(){var widget=$(this).data('widget');var fieldWidget=$('.selecting',widget._activeGroup.tab).data('ListSelectionWidget');var newListHtml=widget._htmlOfGenres[widget._domPane.list.data('newState')];fieldWidget.installListHtml(newListHtml);widget.updateVisibleField();widget._domPane.target.show();var listHeight;if(widget._domPane.list.height()>0){listHeight=widget._domPane.list.outerHeight();}else{debug(widget._name+':: refresh : could not determine list height');listHeight=181;}
var headHeight=0;widget._domPane.head.show();if(widget._domPane.list.data('newState')>0){headHeight=widget._domPane.head.outerHeight();widget._domPane.list.removeClass('pane-top');$('.home-btn',widget._domPane.menu).show();}else{widget._domPane.head.hide();$('.home-btn',widget._domPane.menu).hide();widget._domPane.list.addClass('pane-top');}
var footHeight=0;if(widget._activeGroup==widget._domGenreC){widget._domPane.foot.show();footHeight=widget._domPane.foot.outerHeight();}else{widget._domPane.foot.hide();}
var btnHeight=widget._domPane.menu.outerHeight();var paneHeight=listHeight+headHeight+footHeight+btnHeight;widget._domPane.target.animate({height:paneHeight},{duration:300,complete:function(){fieldWidget.enable();widget._domPane.head.not(':hidden').animate({'opacity':1},{duration:200});widget._domPane.foot.not(':hidden').animate({'opacity':1},{duration:200});widget._domPane.menu.not(':hidden').animate({'opacity':1},{duration:200});widget._domPane.list.animate({'opacity':1},{duration:200,complete:function(){widget._domPane.list.css({'opacity':''});}});widget._domPane.list.data('state',widget._domPane.list.data('newState'));}});},selectGenreEvent:function(event){if(event.subwidget._name=='TextInlineEditWidget'){var customText=$('input',event.subwidget._domTarget).val();if(customText.length>0&&customText!=event.subwidget._prompt){event.widget._domGenreC.customField.html(customText);event.widget._domGenreC.mainField.html(event.widget._domGenreC.mainField.data('default'));event.widget._domGenreC.subField.html(event.widget._domGenreC.subField.data('default'));event.widget._domGenreC.mainField.data('ListSelectionWidget')._value='';event.widget._domGenreC.subField.data('ListSelectionWidget')._value='';event.widget.selectingGenreTab();}else{event.widget._domGenreC.customField.html(event.widget._domGenreC.customField.data('default'));this.updateVisibleField();return false;}}else{var newGenre=event.subwidget._value;var genreField=$('.genre-field.selecting',this._domTarget);if(newGenre==''){newGenre=genreField.data('default');}
genreField.html(newGenre.replace(/&/g,'&amp;'));if(genreField.attr('rel')=='main'){event.widget._activeGroup.subField.html(this._activeGroup.subField.data('default'));event.widget._activeGroup.subField.data('ListSelectionWidget')._value='';if(newGenre!=genreField.data('default')&&this._genreNameMap[newGenre].length>0){event.widget._domPane.list.data('newState',this.getMainGenreId());event.widget.selectingGenreTab();}}else{}
if(event.widget._activeGroup==event.widget._domGenreC){event.widget.getWidget('TextInlineEditWidget',event.widget._domGenreC.customInput).clear();event.widget.getWidget('TextInlineEditWidget',event.widget._domGenreC.customInput).commit();}}
event.widget.commit();},getMainGenreId:function(){var textMainGenre=this._activeGroup.mainField.data('ListSelectionWidget')._value;if(textMainGenre==this._activeGroup.mainField.data('default')){return(0);}
for(var i=0;i<this._listOfGenres[0].length;i++){if(textMainGenre==this._listOfGenres[0][i]){debug('MainGenre ListReference Id: '+(i+1));return(i+1);}}
this._activeGroup.mainField.html(this._activeGroup.mainField.data('default'));this._activeGroup.mainField.data('ListSelectionWidget')._value='';return(0);},clearActiveTab:function(){var activeTab=$('.active-tab',this._domTarget).attr('id');switch(activeTab){case'editor-genre-one':this._activeGroup=this._domGenreA;debug('clearing A');break;case'editor-genre-two':this._activeGroup=this._domGenreB;debug('clearing B');break;case'editor-genre-three':this._activeGroup=this._domGenreC;debug('clearing C');this.getWidget('TextInlineEditWidget',this._domGenreC.customInput).clear();this.getWidget('TextInlineEditWidget',this._domGenreC.customInput).commit();this._domGenreC.customField.html(this._domGenreC.customField.data('default'));break;}
var activeSub=this._activeGroup.subField;var activeMain=this._activeGroup.mainField;activeSub.html(activeSub.data('default'));activeMain.html(activeMain.data('default'));activeSub.data('ListSelectionWidget')._value='';activeMain.data('ListSelectionWidget')._value='';this._domPane.list.data('newState',0);this.commit();},commit:function(){var mainGenre=this._activeGroup.mainField.data('ListSelectionWidget')._value;var subGenre=this._activeGroup.subField.data('ListSelectionWidget')._value;if(mainGenre==this._activeGroup.mainField.data('default')){mainGenre='';}
if(subGenre==this._activeGroup.subField.data('default')){subGenre='';}
this._activeGroup.mainField.data('ListSelectionWidget')._value=mainGenre;this._activeGroup.subField.data('ListSelectionWidget')._value=subGenre;var groupRef=this._activeGroup.tab.attr('id');groupRef=groupRef.substring(groupRef.lastIndexOf('-')+1);var data={main:mainGenre,sub:subGenre,group:groupRef};Saver.save('genreGroup',data);if(mainGenre.length>0){$('#genreOn').attr('checked','checked');Saver.save('genreOn',true);}
this.updateVisibleField();},changeMode:function(mode){switch(mode){case'css':this.disable();break;case'content':this.enable();break;}}});var RMValidator=(function(){var is_url=function(s){var startsWithSlash=/^\/.*/;var startsWithHttpPrefix=/^https?:\/\/.*/;var prefixedString=s;if(!startsWithHttpPrefix.test(s)){prefixedString="http://"+prefixedString;}
var RegExp=/^https?:\/\/.*\.[\w]{1,4}(\W|$).*/;return(!startsWithSlash.test(s)&&RegExp.test(prefixedString));};var is_email=function(s){var RegExp=/^((([a-z]|[0-9]|!|#|$|%|&|'|\*|\+|\-|\/|=|\?|\^|_|`|\{|\||\}|~)+(\.([a-z]|[0-9]|!|#|$|%|&|'|\*|\+|\-|\/|=|\?|\^|_|`|\{|\||\}|~)+)*)@((((([a-z]|[0-9])([a-z]|[0-9]|\-){0,61}([a-z]|[0-9])\.))*([a-z]|[0-9])([a-z]|[0-9]|\-){0,61}([a-z]|[0-9])\.)[\w]{2,4}|(((([0-9]){1,3}\.){3}([0-9]){1,3}))|(\[((([0-9]){1,3}\.){3}([0-9]){1,3})\])))$/;return RegExp.test(s);};return{isUrl:function(input){return is_url(input);},isEmail:function(input){return is_email(input);},validate:function(input,type){switch(type){case'email':return is_email(input);case'url':return is_url(input);default:debug('');break;}}};})();var LinkedInlineWidget=RMUIWidget.extend({_name:"LinkedInlineWidget",_linkedWidgets:false,_widgetData:false,_autoSave:true,init:function(targetElement,options){this._linkedWidgets=new Array();this._autoSave=true;this._super(targetElement,options);},install:function(targetElement){this._super(targetElement);var _linkedWidget=this;$('.rm-inline-edit',this._domTarget).each(function(){var inlineWidget=$(this).data('TextInlineEditWidget');if(!inlineWidget){inlineWidget=new TextInlineEditWidget($(this));}
inlineWidget._autoSave=false;inlineWidget.addCallback('update',_linkedWidget,_linkedWidget.childUpdated,inlineWidget);var optional=$(this).hasClass('optional');var childWidget={widget:inlineWidget,optional:optional,modified:false,saveName:inlineWidget._inputField.attr('name')};_linkedWidget._linkedWidgets.push(childWidget);});debug(this._name+'::install: now contains widgets:');debug(this._linkedWidgets);},activate:function(){this._super();},deactivate:function(){this._super();},enable:function(){this._super();for(var i=0;i<this._linkedWidgets.length;i++){this._linkedWidgets[i].widget.enable();}},disable:function(){this._super();for(var i=0;i<this._linkedWidgets.length;i++){this._linkedWidgets[i].widget.disable();}},getStoredData:function(){debug('pulling saved data...');var childData={};debug(this._linkedWidgets);for(var i=0;i<this._linkedWidgets.length;i++){debug(this._linkedWidgets[i]);childData[this._linkedWidgets[i].saveName]=this._linkedWidgets[i].widget._inputField.val();}
var ret={};ret[this._domTarget.attr('name')]=childData;debug('got return object!');debug(ret);return ret;},commit:function(){var hasRequired=this.hasRequired();if(this.needsUpdate()&&hasRequired){var saveObj={};for(var i=0;i<this._linkedWidgets.length;i++){saveObj[this._linkedWidgets[i].saveName]=this._linkedWidgets[i].widget._inputField.val();}
if(this._autoSave){this._linkedWidgets[i].modified=false;SaveHelper.save(this._domTarget.attr('name'),saveObj);}
this.triggerEvent('update');}else if(!hasRequired){debug(this._name+'::commit: not all required fields were filled in, not committing.');}},needsUpdate:function(){var needsUpdate=false;for(var i=0;i<this._linkedWidgets.length;i++){if(this._linkedWidgets[i].modified){needsUpdate=true;break;}}
return needsUpdate;},hasValidURL:function(){debug('hasValidURL:: checking','error');var ret=true;for(var i=0;i<this._linkedWidgets.length;i++){if(!this._linkedWidgets[i].optional){if((this._linkedWidgets[i].widget._inputField.val()=='')||(!RMValidator.isUrl(this._linkedWidgets[i].widget._inputField.val()))){this.highlightErrors(this._linkedWidgets[i].widget);ret=false;}else{this.clearErrors(this._linkedWidgets[i].widget);}}}
return ret;},hasValidEmail:function(){debug('hasValidEmail:: checking');var ret=true;for(var i=0;i<this._linkedWidgets.length;i++){debug('checking widget: ');debug(this._linkedWidgets[i]);if(!this._linkedWidgets[i].optional){if((this._linkedWidgets[i].widget._inputField.val()=='')||(!RMValidator.isEmail(this._linkedWidgets[i].widget._inputField.val().toLowerCase()))){this.highlightErrors(this._linkedWidgets[i].widget);ret=false;}else{this.clearErrors(this._linkedWidgets[i].widget);}}}
return ret;},hasRequired:function(){debug('hasRequired:: checking','error');var ret=true;for(var i=0;i<this._linkedWidgets.length;i++){if(!this._linkedWidgets[i].optional){if(this._linkedWidgets[i].widget._inputField.val()==''){this.highlightErrors(this._linkedWidgets[i].widget);ret=false;}else{this.clearErrors(this._linkedWidgets[i].widget);}}}
return ret;},childUpdated:function(childWidget){var foundChild=false;for(var i=0;i<this._linkedWidgets.length;i++){if(this._linkedWidgets[i].widget==childWidget){this._linkedWidgets[i].modified=true;foundChild=true;break;}}
if(foundChild){debug(this._name+'::childUpdated(): triggering commit for child');this.commit();}else{debug(this._name+'::childUpdated(): err: couldn\'t find child widget to update');}},highlightErrors:function(childWidget){childWidget._contentArea.css({outline:'2px solid #cc0000'});},clearErrors:function(childWidget){childWidget._contentArea.css({outline:''});},copy:function(){var ret=this._super();var _linkedWidget=this;var copyFrom=false;$('.rm-inline-edit',ret).each(function(indx){copyFrom=$('.rm-inline-edit',_linkedWidget._domTarget).get(indx);if(copyFrom&&$(copyFrom).data('TextInlineEditWidget')){var replacement=$(copyFrom).data('TextInlineEditWidget').copy();$(this).html(replacement.html()).data({});}else{debug(_linkedWidget._name+'::copy: unhandled widget found. Currently only TextInlineEdit widgets can be contained within Linked widgets.');}});return ret;},validate:function(){var $this=this;var valid=true;$.each($this._linkedWidgets,function(indx,widgetwrap){var $widget=widgetwrap.widget;var el=$widget._domTarget;var inputEl=widgetwrap.widget._inputField;var val_types=$.grep(el.attr('class').split(' '),function(val_type,indx2){return(val_type.indexOf('rm-val-')===0);});$.each(val_types,function(indx2,val_types){val_types=val_types.replace('rm-val-','');switch(val_types){case'required':if(inputEl.val().trim()==''){debug('rm-val-required for '+inputEl.attr('name')+' failed','error');$this.highlightErrors($widget);valid=false;return false;}
break;case'url':if(!RMValidator.isUrl(inputEl.val())){if($widget._contentArea.text().indexOf('http')==-1){$widget._contentArea.text('http://'+inputEl.val());}else{$this.highlightErrors($widget);valid=false;return false;}}
break;case'email':if(!RMValidator.isUrl(inputEl.val())){debug('rm-val-email for '+inputEl.attr('name')+' failed','error');$this.highlightErrors($widget);valid=false;return false;}
break;}});});return valid;}});var MultivalWidget=RMUIWidget.extend({_name:"MultivalWidget",_activeWidgets:false,_inputter:false,_inputWidget:false,_autoAdd:false,_autoSave:true,_validator:false,_addFromTop:false,init:function(targetElement,options){this._activeWidgets=new Array();this._autoAdd=false;this._autoSave=true;this._validator=false;this._addFromTop=false;if(options){if(options.hasOwnProperty('autoAdd')){this._autoAdd=options.autoAdd;}
if(options.hasOwnProperty('autoSave')){this._autoSave=options.autoSave;}
if(options.hasOwnProperty('validate')){this._validator=options.validate;}
if(options.hasOwnProperty('addFromTop')){this._addFromTop=options.addFromTop;}}
this._super(targetElement,options);},install:function(targetElement){this._super(targetElement);if(this._autoAdd){var inputterSelector=this._addFromTop?'li:first-child':'li:last-child';this._inputter=$(inputterSelector,this._domTarget);this._inputter.addClass('rm-multival-addnew').find('.rm-multival-add-button').bind('click',{widget:this},this.handleButtonEvent);}
$('.rm-remove-link',$(this.getTarget())[0]).live('click',{widget:this},this.handleButtonEvent);$('.rm-add-link',$(this.getTarget())[0]).live('click',{widget:this},this.handleButtonEvent);var _multivalWidget=this;$('li',this._domTarget).each(function(){var widgetDOM=$(this).hasClass('.rm-widget')?$(this):$(this).find('.rm-widget').first();var widget=false;var childWidgets=_multivalWidget.getWidgets(widgetDOM);if(childWidgets){for(var i=0;i<childWidgets.length;i++){if(childWidgets[i]instanceof TextInlineEditWidget||childWidgets[i]instanceof LinkedInlineWidget){widget=childWidgets[i];break;}}}else{widgetDOM=$(this).find('.rm-linked-field').first();if(widgetDOM.length<1){widgetDOM=$(this).find('.rm-inline-edit').first();}
if(widgetDOM.hasClass('rm-linked-field')){widget=new LinkedInlineWidget(widgetDOM);}else if(widgetDOM.hasClass('rm-inline-edit')){widget=new TextInlineEditWidget(widgetDOM);}}
if(widget){widget._autoSave=false;if(!$(this).hasClass('rm-multival-addnew')){var idTokens=widgetDOM.attr('id').split('-');$(this).append('<a href="#remove" id="rm-multilval-remove-'+idTokens[idTokens.length-1]+'" class="rm-remove-link" title="Remove this item?">Remove</a>');widget.addCallback('update',_multivalWidget,_multivalWidget.childUpdated,widget);_multivalWidget._activeWidgets.push({id:idTokens[idTokens.length-1],widget:widget,modified:false});}else{_multivalWidget._inputWidget=widget;if(_multivalWidget._autoAdd){if(!_multivalWidget._validator){_multivalWidget._inputWidget.addCallback('update',_multivalWidget,_multivalWidget.inputterUpdated,_multivalWidget._inputWidget);return true;}
switch(_multivalWidget._validator){case'email':_multivalWidget._inputWidget.addCallback('update',_multivalWidget,_multivalWidget.inputterUpdatedEmail,_multivalWidget._inputWidget);break;case'url':_multivalWidget._inputWidget.addCallback('update',_multivalWidget,_multivalWidget.inputterUpdatedWebsite,_multivalWidget._inputWidget);break;default:break;}}}}else{debug(_multivalWidget._name+'::install: found non-supported widget, ignoring. Currently only TextInlineEdit and LinkedInlineEdit widgets are allowed.');}});},activate:function(){this._super();},deactivate:function(){this._super();},changeMode:function(mode){this._super(mode);switch(mode){case'css':this.disable();break;case'content':this.enable();break;default:break;}},enable:function(){this._super();this._inputter.show();$('.rm-remove-link',this._domTarget).show();},disable:function(){this._inputter.hide();$('.rm-remove-link',this._domTarget).hide();},commit:function(added,callback){if(!this.needsUpdate()){return false;}
for(var i=0;i<this._activeWidgets.length;i++){if(!this._activeWidgets[i].modified){continue;}
this._activeWidgets[i].modified=false;debug('getting stored data...');debug(this._activeWidgets[i].widget);var data=this._activeWidgets[i].widget.getStoredData();debug(data);for(var key in data){if(data.hasOwnProperty(key)){debug(this._name+'::commit: saving key '+key);data[key].id=this._activeWidgets[i].id;debug(data[key]);if(this._autoSave){Saver.save(added?key+'-add':key,data[key],{success:callback});}
this.triggerEvent('update',data[key]);}}}},needsUpdate:function(){var needsUpdate=false;for(var i=0;i<this._activeWidgets.length;i++){if(this._activeWidgets[i].modified){needsUpdate=true;break;}}
return needsUpdate;},addNewWidget:function(){var sourceWidgetDOM=$('.rm-widget',this._inputter).first();var targetElement=false;var addedWidget=false;var sourceWidgets=this.getWidgets(sourceWidgetDOM);var src_w=false;if(sourceWidgets){for(var i=0;i<sourceWidgets.length;i++){src_w=sourceWidgets[i];targetElement=src_w.copy();var addedDOM=targetElement.wrap('<li/>').parent().hide();if(this._addFromTop){this._inputter.after(addedDOM);}else{this._inputter.before(addedDOM);}
targetElement.parent().fadeIn();if(src_w instanceof TextInlineEditWidget){addedWidget=new TextInlineEditWidget(targetElement);}else if(src_w instanceof LinkedInlineWidget){addedWidget=new LinkedInlineWidget(targetElement);}else{continue;}}
if(addedWidget){addedWidget._autoSave=false;addedWidget.addCallback('update',this,this.childUpdated,addedWidget);this._activeWidgets.push({widget:addedWidget,modified:true});this.triggerEvent('widgetcreated',addedWidget);this.clearInputter();_multivalWidget=this;this.commit(true,function(data){var indx=_multivalWidget.findChild(addedWidget);if(indx<0){debug('addNewWidget::error, could not find associated element');return false;}
if(!data.hasOwnProperty('object')){debug('addNewWidget::error, could not get valid element from response');return false;}
_multivalWidget._activeWidgets[indx].id=data.object.id;targetElement.attr('id',targetElement.attr('name')+data.object.id);targetElement.parent().append('<a href="#remove" id="rm-multilval-remove-'+data.object.id+'" class="rm-remove-link" title="Remove this item?">Remove</a>');});}else{debug(this._name+'::addNewWidget: found non-supported widget, ignoring. Currently only TextInlineEdit and Linked widgets are allowed.');debug(widgetTarget.data());}}else{debug(this._name+'::addNewWidget: no source widgets found!');debug(sourceWidgets);}},removeWidget:function(id){for(var i=0;i<this._activeWidgets.length;i++){debug('found the active widget with id '+id);if(this._activeWidgets[i].id==id){this._activeWidgets[i].widget._domTarget.closest('li').fadeOut(function(){$(this).remove();});this.triggerEvent('widgetremoved',this._activeWidgets[i].widget);Saver.save(this._activeWidgets[i].widget._domTarget.attr('name')+'-remove',id);this._activeWidgets.slice(i,1);break;}}},clearInputter:function(){var inlineWidget=false;var _widget=this;$('.rm-inline-edit',this._inputter).each(function(){inlineWidget=_widget.getWidget('TextInlineEditWidget',$(this));if(inlineWidget){inlineWidget.clear();}});},childUpdated:function(childWidget){debug(this._name+'::childUpdated: got update event from '+childWidget._name);for(var i=0;i<this._activeWidgets.length;i++){if(this._activeWidgets[i].widget==childWidget){this._activeWidgets[i].modified=true;this.commit();}}},inputterUpdated:function(){debug(this._name+'::inputterUpdated: checking status of new inputter...');if(this._inputWidget._name=='TextInlineEditWidget'){this.addNewWidget();}else if(this._inputWidget._name=='LinkedInlineWidget'){if(this._inputWidget.needsUpdate()&&this._inputWidget.hasRequired()){this.addNewWidget();}}
debug('end!');},inputterUpdatedWebsite:function(){debug(this._name+'::inputterUpdated: checking status of new inputter '+this._inputWidget._name);if(this._inputWidget._name=='TextInlineEditWidget'){this.addNewWidget();}else if(this._inputWidget._name=='LinkedInlineWidget'){if(this._inputWidget.needsUpdate()&&this._inputWidget.hasValidURL()){this.addNewWidget();}}
debug('end!');},inputterUpdatedEmail:function(){debug(this._name+'::inputterUpdated: checking status of new inputter...');if(this._inputWidget._name=='TextInlineEditWidget'){this.addNewWidget();}else if(this._inputWidget._name=='LinkedInlineWidget'){if(this._inputWidget.needsUpdate()&&this._inputWidget.hasValidEmail()){this.addNewWidget();}}
debug('end!');},findChild:function(childWidget){for(var i=0;i<this._activeWidgets.length;i++){if(this._activeWidgets[i].widget==childWidget){return i;}}
return-1;},handleButtonEvent:function(event){debug(event);if(event.data.widget){var widget=event.data.widget;if($(event.currentTarget).hasClass('rm-remove-link')){if(confirm('Are you sure you want to remove this item?')){var idTokens=$(event.currentTarget).attr('id').split('-');widget.removeWidget(idTokens[idTokens.length-1]);}}else if($(event.currentTarget).hasClass('rm-multival-add-button')){var inputValid=false;switch(widget._inputWidget._name){case'TextInlineEditWidget':inputValid=widget._inputWidget.needsUpdate();break;case'LinkedInlineWidget':var requiredVal=widget._inputWidget.hasRequired();var multiValidate=widget._inputWidget.validate();var needsUpdate=widget._inputWidget.needsUpdate();debug('needsUpdate:'+needsUpdate+' hasRequired: '+requiredVal+' multiValidate:'+multiValidate);inputValid=needsUpdate&&requiredVal&&multiValidate;break;default:break;}
if(inputValid){widget.addNewWidget();}}else{debug(widget._name+'::handleButtonEvent: unhandled button: '+event.currentTarget);}}
return false;},generateChildId:function(){return Math.floor(Math.random()*1000);}});var VideoEditWidget=RMUIWidget.extend({_DUPLICATE_ERROR:$('<div class="video-error-dialog">'+'<h4>This video link has already been added.</h4>'+'<br/><em>Please make sure that videos you add</em><br/>'+'<em>have not yet been added to your</em><br/>'+'<em>account.</em><br/><br/><br/>'+'<a class="cancel" href="#video-cancel">Try again with a unique video</a>'+'</div>'),_INCORRECT_ENTRY_ERROR:$('<div class="video-error-dialog">'+'<h4>That video link doesn&rsquo;t seem to be valid!</h4>'+'<p>Example links:<br /><em>http://www.youtube.com/watch?v=XXXXXXX</em><br />'+'<em>http://www.vimeo.com/XXXXXXX</em></p>'+'<a class="cancel" href="#video-cancel">Try again?</a>'+'</div>'),_videos:false,_linkInputter:false,_options:false,_videoType:false,_videoTypeName:false,init:function(targetElement,options){this._name='VideoEditWidget';debug(this._name+'::init');this._options=options;this._videoTypeName=options.type;switch(this._videoTypeName){case'youtube':this._videoType=1;break;case'vimeo':this._videoType=2;break;default:break;}
this._videos=new Array();this._approved=false;this._super(targetElement,options);},install:function(targetElement){this._super(targetElement);var _videoWidget=this;$('.video-item',this._domTarget).each(function(){var idTokens=$(this).attr('id').split('-');var videoId=parseInt(idTokens[idTokens.length-1]);var video={videoId:videoId,title:$(this).children('.title').text()};_videoWidget._videos.push(video);var domStr='<a href="#delete-video" class="remove-video" title="Remove this video?">Remove this video</a>';var removeLink=$(domStr);removeLink.bind('click',{widget:_videoWidget},function(event){if(confirm("Are you sure you want to remove this video?")){event.data.widget.removeVideo(videoId);}
return false;});$(this).prepend(removeLink).attr('id','video-item-'+videoId);});var inputDOMStr='<div class="add-new-video '+this._videoTypeName+'">';inputDOMStr+='<span class="static">Add new:</span>';inputDOMStr+='<span class="rm-inline-edit" name="'+this._videoTypeName+'-video"></span>';inputDOMStr+='<span class="instr hidden">Press enter to add.</span></div>';var inputDOM=$(inputDOMStr);this._domTarget.after(inputDOM);$('.hidden',inputDOM).removeClass('hidden').hide();this._linkInputter=new TextInlineEditWidget(inputDOM.children('.rm-inline-edit'));this._linkInputter.addCallback('update',this,this.processInput);this._linkInputter._inputField.bind('keyup',function(event){var instructions=$(event.currentTarget).closest('.add-new-video').children('.instr');if($(event.currentTarget).val()!=''&&event.keyCode!=13){if(instructions.is(':hidden')){instructions.fadeIn();}}else if(instructions.is(':visible'))instructions.hide();});},commit:function(video,inputLink){var saveRoute='';switch(this._videoType){case 1:saveRoute='add-video-youtube';break;case 2:saveRoute='add-video-vimeo';break;default:break;}
var _widget=this;Saver.save(saveRoute,inputLink,{success:function(data){_widget.updateVideo(data.video);var videoItem=$('#video-pending-'+data.video.serviceId);var removeLinkDomStr='<a href="#delete-video" class="remove-video" title="Remove this video?">Remove this video</a>';var removeLink=$(removeLinkDomStr);removeLink.bind('click',{widget:_widget},function(event){if(confirm("Are you sure you want to remove this video?")){event.data.widget.removeVideo(parseInt(data.video.id));}
return false;});videoItem.removeClass('loading').attr('id','video-item-'+data.video.id).prepend(removeLink);}});this.resetInputField();},getVideo:function(id){for(var i=0;i<this._videos.length;i++){if(this._videos[i].videoId==id)return this._videos[i];}
return false;},updateVideo:function(video){for(var i=0;i<this._videos.length;i++){if(this._videos[i].id==video.id)this._videos[i]=video;}
return false;},addVideo:function(video,inputLink){this._videos.push(video);var domStr='<li name="'+video.id+'" id="video-pending-'+video.id+'" class="video-item '+this._videoTypeName+' loading">';debug("added="+video.id);domStr+='<img class="video-thumb" src="'+video.image+'" alt="'+video.title+'" />';domStr+='<h4 class="title">'+video.title+'</h4>';domStr+='</li>';var newItem=$(domStr);this._domTarget.append(newItem);this.commit(video,inputLink);},removeVideo:function(id){debug(this._name+'::removeVideo: removing video with id='+id);debug(this._videos);var videoItem=$('#video-item-'+id);videoItem.fadeOut();Saver.save('remove-video',id,{success:function(){videoItem.remove();},error:function(){videoItem.fadeIn();}});},resetInputField:function(){this._linkInputter._contentArea.text('');this._linkInputter._inputField.val('');this._linkInputter._empty=true;this._linkInputter.checkForEmpty();},processInput:function(){$('.instr',this._domTarget.parent()).hide();var ajaxURL='';switch(this._videoType){case 1:ajaxURL='/saveajax/saveYoutube';break;case 2:ajaxURL='/saveajax/saveVimeo';break;default:break;}
var _widget=this;var inputLink=this._linkInputter._inputField.val();$.ajax({url:ajaxURL,type:'post',data:{bandId:getGlobal('pageId'),link:inputLink,bypassDb:true},dataType:'json',success:function(data,response){if(!_widget.video_is_exclusive(data.id)){_widget.showErrorDialog(_widget._DUPLICATE_ERROR);return false;}
if(!data.title){_widget.showErrorDialog(_widget._INCORRECT_ENTRY_ERROR);return false;}
_widget.addVideo(data,inputLink);}});this._linkInputter._inputField.val('processing video...');},showErrorDialog:function(domStr){debug(this._name+'::showErrorDialog');var dialog=$(domStr);dialog.appendTo(this._domTarget.parent()).hide().css({bottom:dialog.siblings('.add-new-video').outerHeight()-20+'px',left:dialog.siblings('.add-new-video').position().left+20+'px',display:'block',opacity:0}).animate({bottom:'+=20px',opacity:1},250);$('a.cancel',dialog).bind('click',{widget:this},function(event){dialog.fadeOut(function(){event.data.widget.resetInputField();$(this).remove();});return false;});$('#rm-videos').bind('click',{widget:this},this.handleErrorDialog);},handleErrorDialog:function(event){debug(event.target);if($(event.target).closest('.video-error-dialog').length==0){$('.video-error-dialog','#rm-videos').fadeOut(function(){$(this).remove();});event.data.widget.resetInputField();$('#rm-videos').unbind('click',event.data.widget.handleErrorDialog);}},video_is_exclusive:function(VidId){matchingElem='[name$='+VidId+']';debug("checked="+VidId);debug($(matchingElem).length);if($(matchingElem).length>0){return false;}
else{return true;}}});(function($){var ColorPicker=function(){var
ids={},inAction,charMin=65,visible,tpl='<div class="colorpicker"><div class="colorpicker_color"><div><div></div></div></div><div class="colorpicker_hue"><div></div></div><div class="colorpicker_new_color"></div><div class="colorpicker_current_color"></div><div class="colorpicker_hex"><input type="text" maxlength="6" size="6" /></div><div class="colorpicker_rgb_r colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_rgb_g colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_rgb_b colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_h colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_s colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_b colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_submit"></div></div>',defaults={eventName:'click',onShow:function(){},onBeforeShow:function(){},onHide:function(){},onChange:function(){},onSubmit:function(){},color:'ff0000',livePreview:true,flat:false},fillRGBFields=function(hsb,cal){var rgb=HSBToRGB(hsb);$(cal).data('colorpicker').fields.eq(1).val(rgb.r).end().eq(2).val(rgb.g).end().eq(3).val(rgb.b).end();},fillHSBFields=function(hsb,cal){$(cal).data('colorpicker').fields.eq(4).val(hsb.h).end().eq(5).val(hsb.s).end().eq(6).val(hsb.b).end();},fillHexFields=function(hsb,cal){$(cal).data('colorpicker').fields.eq(0).val(HSBToHex(hsb)).end();},setSelector=function(hsb,cal){$(cal).data('colorpicker').selector.css('backgroundColor','#'+HSBToHex({h:hsb.h,s:100,b:100}));$(cal).data('colorpicker').selectorIndic.css({left:parseInt(150*hsb.s/100,10),top:parseInt(150*(100-hsb.b)/100,10)});},setHue=function(hsb,cal){$(cal).data('colorpicker').hue.css('top',parseInt(150-150*hsb.h/360,10));},setCurrentColor=function(hsb,cal){$(cal).data('colorpicker').currentColor.css('backgroundColor','#'+HSBToHex(hsb));},setNewColor=function(hsb,cal){$(cal).data('colorpicker').newColor.css('backgroundColor','#'+HSBToHex(hsb));},keyDown=function(ev){var pressedKey=ev.charCode||ev.keyCode||-1;if((pressedKey>charMin&&pressedKey<=90)||pressedKey==32){return false;}
var cal=$(this).parent().parent();if(cal.data('colorpicker').livePreview===true){change.apply(this);}},change=function(ev){var cal=$(this).parent().parent(),col;if(this.parentNode.className.indexOf('_hex')>0){cal.data('colorpicker').color=col=HexToHSB(fixHex(this.value));}else if(this.parentNode.className.indexOf('_hsb')>0){cal.data('colorpicker').color=col=fixHSB({h:parseInt(cal.data('colorpicker').fields.eq(4).val(),10),s:parseInt(cal.data('colorpicker').fields.eq(5).val(),10),b:parseInt(cal.data('colorpicker').fields.eq(6).val(),10)});}else{cal.data('colorpicker').color=col=RGBToHSB(fixRGB({r:parseInt(cal.data('colorpicker').fields.eq(1).val(),10),g:parseInt(cal.data('colorpicker').fields.eq(2).val(),10),b:parseInt(cal.data('colorpicker').fields.eq(3).val(),10)}));}
if(ev){fillRGBFields(col,cal.get(0));fillHexFields(col,cal.get(0));fillHSBFields(col,cal.get(0));}
setSelector(col,cal.get(0));setHue(col,cal.get(0));setNewColor(col,cal.get(0));cal.data('colorpicker').onChange.apply(cal,[col,HSBToHex(col),HSBToRGB(col)]);},blur=function(ev){var cal=$(this).parent().parent();cal.data('colorpicker').fields.parent().removeClass('colorpicker_focus');},focus=function(){charMin=this.parentNode.className.indexOf('_hex')>0?70:65;$(this).parent().parent().data('colorpicker').fields.parent().removeClass('colorpicker_focus');$(this).parent().addClass('colorpicker_focus');},downIncrement=function(ev){var field=$(this).parent().find('input').focus();var current={el:$(this).parent().addClass('colorpicker_slider'),max:this.parentNode.className.indexOf('_hsb_h')>0?360:(this.parentNode.className.indexOf('_hsb')>0?100:255),y:ev.pageY,field:field,val:parseInt(field.val(),10),preview:$(this).parent().parent().data('colorpicker').livePreview};$(document).bind('mouseup',current,upIncrement);$(document).bind('mousemove',current,moveIncrement);},moveIncrement=function(ev){var invert=-1;ev.data.field.val(Math.max(0,Math.min(ev.data.max,parseInt(ev.data.val+invert*(ev.pageY-ev.data.y),10))));if(ev.data.preview){change.apply(ev.data.field.get(0),[true]);}
return false;},upIncrement=function(ev){change.apply(ev.data.field.get(0),[true]);ev.data.el.removeClass('colorpicker_slider').find('input').focus();$(document).unbind('mouseup',upIncrement);$(document).unbind('mousemove',moveIncrement);return false;},downHue=function(ev){var current={cal:$(this).parent(),y:$(this).offset().top};current.preview=current.cal.data('colorpicker').livePreview;$(document).bind('mouseup',current,upHue);$(document).bind('mousemove',current,moveHue);},moveHue=function(ev){change.apply(ev.data.cal.data('colorpicker').fields.eq(4).val(parseInt(360*(150-Math.max(0,Math.min(150,(ev.pageY-ev.data.y))))/150,10)).get(0),[ev.data.preview]);return false;},upHue=function(ev){fillRGBFields(ev.data.cal.data('colorpicker').color,ev.data.cal.get(0));fillHexFields(ev.data.cal.data('colorpicker').color,ev.data.cal.get(0));$(document).unbind('mouseup',upHue);$(document).unbind('mousemove',moveHue);return false;},downSelector=function(ev){var current={cal:$(this).parent(),pos:$(this).offset()};current.preview=current.cal.data('colorpicker').livePreview;$(document).bind('mouseup',current,upSelector);$(document).bind('mousemove',current,moveSelector);},moveSelector=function(ev){change.apply(ev.data.cal.data('colorpicker').fields.eq(6).val(parseInt(100*(150-Math.max(0,Math.min(150,(ev.pageY-ev.data.pos.top))))/150,10)).end().eq(5).val(parseInt(100*(Math.max(0,Math.min(150,(ev.pageX-ev.data.pos.left))))/150,10)).get(0),[ev.data.preview]);return false;},upSelector=function(ev){fillRGBFields(ev.data.cal.data('colorpicker').color,ev.data.cal.get(0));fillHexFields(ev.data.cal.data('colorpicker').color,ev.data.cal.get(0));$(document).unbind('mouseup',upSelector);$(document).unbind('mousemove',moveSelector);return false;},enterSubmit=function(ev){$(this).addClass('colorpicker_focus');},leaveSubmit=function(ev){$(this).removeClass('colorpicker_focus');},clickSubmit=function(ev){var cal=$(this).parent();var col=cal.data('colorpicker').color;cal.data('colorpicker').origColor=col;setCurrentColor(col,cal.get(0));cal.data('colorpicker').onSubmit(col,HSBToHex(col),HSBToRGB(col),cal.data('colorpicker').el);},show=function(ev){var cal=$('#'+$(this).data('colorpickerId'));cal.data('colorpicker').onBeforeShow.apply(this,[cal.get(0)]);var pos=$(this).offset();var viewPort=getViewport();var top=pos.top+this.offsetHeight;var left=pos.left;if(top+176>viewPort.t+viewPort.h){top-=this.offsetHeight+176;}
if(left+356>viewPort.l+viewPort.w){left-=356;}
cal.css({left:left+'px',top:top+'px'});if(cal.data('colorpicker').onShow.apply(this,[cal.get(0)])!=false){cal.show();}
$(document).bind('mousedown',{cal:cal},hide);return false;},hide=function(ev){if(!isChildOf(ev.data.cal.get(0),ev.target,ev.data.cal.get(0))){if(ev.data.cal.data('colorpicker').onHide.apply(this,[ev.data.cal.get(0)])!=false){ev.data.cal.hide();}
$(document).unbind('mousedown',hide);}},isChildOf=function(parentEl,el,container){if(parentEl==el){return true;}
if(parentEl.contains){return parentEl.contains(el);}
if(parentEl.compareDocumentPosition){return!!(parentEl.compareDocumentPosition(el)&16);}
var prEl=el.parentNode;while(prEl&&prEl!=container){if(prEl==parentEl)
return true;prEl=prEl.parentNode;}
return false;},getViewport=function(){var m=document.compatMode=='CSS1Compat';return{l:window.pageXOffset||(m?document.documentElement.scrollLeft:document.body.scrollLeft),t:window.pageYOffset||(m?document.documentElement.scrollTop:document.body.scrollTop),w:window.innerWidth||(m?document.documentElement.clientWidth:document.body.clientWidth),h:window.innerHeight||(m?document.documentElement.clientHeight:document.body.clientHeight)};},fixHSB=function(hsb){return{h:Math.min(360,Math.max(0,hsb.h)),s:Math.min(100,Math.max(0,hsb.s)),b:Math.min(100,Math.max(0,hsb.b))};},fixRGB=function(rgb){return{r:Math.min(255,Math.max(0,rgb.r)),g:Math.min(255,Math.max(0,rgb.g)),b:Math.min(255,Math.max(0,rgb.b))};},fixHex=function(hex){var len=6-hex.length;if(len>0){var o=[];for(var i=0;i<len;i++){o.push('0');}
o.push(hex);hex=o.join('');}
return hex;},HexToRGB=function(hex){var hex=parseInt(((hex.indexOf('#')>-1)?hex.substring(1):hex),16);return{r:hex>>16,g:(hex&0x00FF00)>>8,b:(hex&0x0000FF)};},HexToHSB=function(hex){return RGBToHSB(HexToRGB(hex));},RGBToHSB=function(rgb){var hsb={h:0,s:0,b:0};var min=Math.min(rgb.r,rgb.g,rgb.b);var max=Math.max(rgb.r,rgb.g,rgb.b);var delta=max-min;hsb.b=max;if(max!=0){}
hsb.s=max!=0?255*delta/max:0;if(hsb.s!=0){if(rgb.r==max){hsb.h=(rgb.g-rgb.b)/delta;}else if(rgb.g==max){hsb.h=2+(rgb.b-rgb.r)/delta;}else{hsb.h=4+(rgb.r-rgb.g)/delta;}}else{hsb.h=-1;}
hsb.h*=60;if(hsb.h<0){hsb.h+=360;}
hsb.s*=100/255;hsb.b*=100/255;return hsb;},HSBToRGB=function(hsb){var rgb={};var h=Math.round(hsb.h);var s=Math.round(hsb.s*255/100);var v=Math.round(hsb.b*255/100);if(s==0){rgb.r=rgb.g=rgb.b=v;}else{var t1=v;var t2=(255-s)*v/255;var t3=(t1-t2)*(h%60)/60;if(h==360)h=0;if(h<60){rgb.r=t1;rgb.b=t2;rgb.g=t2+t3}
else if(h<120){rgb.g=t1;rgb.b=t2;rgb.r=t1-t3}
else if(h<180){rgb.g=t1;rgb.r=t2;rgb.b=t2+t3}
else if(h<240){rgb.b=t1;rgb.r=t2;rgb.g=t1-t3}
else if(h<300){rgb.b=t1;rgb.g=t2;rgb.r=t2+t3}
else if(h<360){rgb.r=t1;rgb.g=t2;rgb.b=t1-t3}
else{rgb.r=0;rgb.g=0;rgb.b=0}}
return{r:Math.round(rgb.r),g:Math.round(rgb.g),b:Math.round(rgb.b)};},RGBToHex=function(rgb){var hex=[rgb.r.toString(16),rgb.g.toString(16),rgb.b.toString(16)];$.each(hex,function(nr,val){if(val.length==1){hex[nr]='0'+val;}});return hex.join('');},HSBToHex=function(hsb){return RGBToHex(HSBToRGB(hsb));},restoreOriginal=function(){var cal=$(this).parent();var col=cal.data('colorpicker').origColor;cal.data('colorpicker').color=col;fillRGBFields(col,cal.get(0));fillHexFields(col,cal.get(0));fillHSBFields(col,cal.get(0));setSelector(col,cal.get(0));setHue(col,cal.get(0));setNewColor(col,cal.get(0));};return{init:function(opt){opt=$.extend({},defaults,opt||{});if(typeof opt.color=='string'){opt.color=HexToHSB(opt.color);}else if(opt.color.r!=undefined&&opt.color.g!=undefined&&opt.color.b!=undefined){opt.color=RGBToHSB(opt.color);}else if(opt.color.h!=undefined&&opt.color.s!=undefined&&opt.color.b!=undefined){opt.color=fixHSB(opt.color);}else{return this;}
return this.each(function(){if(!$(this).data('colorpickerId')){var options=$.extend({},opt);options.origColor=opt.color;var id='collorpicker_'+parseInt(Math.random()*1000);$(this).data('colorpickerId',id);var cal=$(tpl).attr('id',id);if(options.flat){cal.appendTo(this).show();}else{cal.appendTo(document.body);}
options.fields=cal.find('input').bind('keyup',keyDown).bind('change',change).bind('blur',blur).bind('focus',focus);cal.find('span').bind('mousedown',downIncrement).end().find('>div.colorpicker_current_color').bind('click',restoreOriginal);options.selector=cal.find('div.colorpicker_color').bind('mousedown',downSelector);options.selectorIndic=options.selector.find('div div');options.el=this;options.hue=cal.find('div.colorpicker_hue div');cal.find('div.colorpicker_hue').bind('mousedown',downHue);options.newColor=cal.find('div.colorpicker_new_color');options.currentColor=cal.find('div.colorpicker_current_color');cal.data('colorpicker',options);cal.find('div.colorpicker_submit').bind('mouseenter',enterSubmit).bind('mouseleave',leaveSubmit).bind('click',clickSubmit);fillRGBFields(options.color,cal.get(0));fillHSBFields(options.color,cal.get(0));fillHexFields(options.color,cal.get(0));setHue(options.color,cal.get(0));setSelector(options.color,cal.get(0));setCurrentColor(options.color,cal.get(0));setNewColor(options.color,cal.get(0));if(options.flat){cal.css({position:'relative',display:'block'});}else{$(this).bind(options.eventName,show);}}});},showPicker:function(){return this.each(function(){if($(this).data('colorpickerId')){show.apply(this);}});},hidePicker:function(){return this.each(function(){if($(this).data('colorpickerId')){$('#'+$(this).data('colorpickerId')).hide();}});},setColor:function(col){if(typeof col=='string'){col=HexToHSB(col);}else if(col.r!=undefined&&col.g!=undefined&&col.b!=undefined){col=RGBToHSB(col);}else if(col.h!=undefined&&col.s!=undefined&&col.b!=undefined){col=fixHSB(col);}else{return this;}
return this.each(function(){if($(this).data('colorpickerId')){var cal=$('#'+$(this).data('colorpickerId'));cal.data('colorpicker').color=col;cal.data('colorpicker').origColor=col;fillRGBFields(col,cal.get(0));fillHSBFields(col,cal.get(0));fillHexFields(col,cal.get(0));setHue(col,cal.get(0));setSelector(col,cal.get(0));setCurrentColor(col,cal.get(0));setNewColor(col,cal.get(0));}});}};}();$.fn.extend({ColorPicker:ColorPicker.init,ColorPickerHide:ColorPicker.hidePicker,ColorPickerShow:ColorPicker.showPicker,ColorPickerSetColor:ColorPicker.setColor});})(jQuery);var Color={toRgbStr:function(color){var isRGB=color.match(/rgb/ig);if(isRGB&&isRGB.length){return color;}else{color=color.substr(color.indexOf('#')+1);var r=parseInt(color.slice(0,2),16);var g=parseInt(color.slice(2,4),16);var b=parseInt(color.slice(4,6),16);return'rgb('+r+','+g+','+b+')';}},rgbStrToArray:function(rgbStr){debug('Color::rgbStrToArray: converting string '+rgbStr);var tokens=rgbStr.replace(/[rgb()\s]/ig,"").split(",");return[parseInt(tokens[0]),parseInt(tokens[1]),parseInt(tokens[2])];},rgbStrToHex:function(rgbStr){var tokens=rgbStr.replace(/[rgb()\s]/ig,"").split(",");var rHex=parseInt(tokens[0]).toString(16);var gHex=parseInt(tokens[1]).toString(16);var bHex=parseInt(tokens[2]).toString(16);rHex=(rHex.length<2)?'0'+rHex:rHex;gHex=(gHex.length<2)?'0'+gHex:gHex;bHex=(bHex.length<2)?'0'+bHex:bHex;return rHex+gHex+bHex;},rgbArrayToStr:function(rgbArr){if(typeof(rgbArr)=='object'&&rgbArr.length==3){return'rgb('+Math.round(rgbArr[0])+','+Math.round(rgbArr[1])+','+Math.round(rgbArr[2])+')';}else{debug('Color::rgbArrayToStr: couldn\'t convert value to string, are you sure it\'s an array?');return false;}},offsetColor:function(color,offset){debug('converting color '+color+'..');switch(typeof(color)){case'array':break;case'string':color=Color.rgbStrToArray(Color.toRgbStr(color));break;default:break;}
var percentage=(offset<1)&&(Math.ceil(offset)==1);var r=color[0];var g=color[1];var b=color[2];if(percentage){r+=(r*offset);g+=(g*offset);b+=(b*offset);}else{r+=offset;g+=offset;b+=offset;}
r=Math.min(255,Math.max(0,r));g=Math.min(255,Math.max(0,g));b=Math.min(255,Math.max(0,b));debug(Color.rgbArrayToStr([r,g,b]));return Color.rgbArrayToStr([r,g,b]);}};var BackgroundImageUploader=RMUIWidget.extend({_name:'BackgroundImageUploader',_uploadifySelector:'',_scriptArgs:{kid:null,type:'style',index:0,onSelect:null,onProgress:null,onComplete:null,onCancel:null,onError:null},init:function(targetElement,options){this._uploadifySelector='#rm-css-bgimage-uploader';this._scriptArgs={rmPageId:getGlobal('fanPageId'),kid:getGlobal('kid'),type:'style',onSelect:function(resp){},onProgress:function(resp){},onComplete:function(resp){},onCancel:function(resp){},onError:function(resp){}};if(options&&options.hasOwnProperty('scriptArgs')){this._scriptArgs=$.extend(this._scriptArgs,options.scriptArgs);}
this._super(targetElement);},install:function(){this._super();var origarturl="";this.activateHoverHandler();var _uploader=this;$(this._uploadifySelector).uploadify({uploader:'/flash/uploadify.swf',script:Environment.getHost()+'/upload',folder:'/var/www/cache',cancelImg:'http://a.ak.static-rootmusic.com/images/soundcloud/cancel.png?v=2.70',buttonText:'Upload new',hideButton:true,fileDesc:'jpg, jpeg, png, gif',fileExt:'*.jpg;*.jpeg;*.gif;*.png',wmode:'transparent',scriptAccess:'always',auto:'false',multi:false,height:'18',width:'119',sizeLimit:(1024*1024*4),onSelect:function(event,queueID,fileObj){_uploader.deactivateHoverHandler();$(event.currentTarget).data('destination').addClass('uploadify-queue-'+queueID);$(_uploader._domTarget).css({zIndex:-1});$('.progress-bar','#rm-css-bgimage-control').text('').removeClass('hover').addClass('uploading');var args=$.extend(_uploader.getScriptArgs(),{element:$(event.currentTarget).data('destination').attr('rel')});$(_uploader._uploadifySelector).uploadifySettings('scriptData',args);$(_uploader._uploadifySelector).uploadifyUpload();_uploader._scriptArgs.onSelect(event);return false;},onProgress:function(event,queueID,response,data){var destination=$(event.currentTarget).data('destination');if(destination.hasClass('uploadify-queue-'+queueID)){_uploader.deactivateHoverHandler();$('.progress-bar','#rm-css-bgimage-control').addClass('uploading').css({width:data.percentage+'%'}).text(data.percentage+'%');}
_uploader._scriptArgs.onProgress(event);return false;},onComplete:function(event,queueID,fileObj,response,data){debug(response);response=JSON.parse(response);var destination=$(event.currentTarget).data('destination');if(destination.hasClass('uploadify-queue-'+queueID)){$('.progress-bar','#rm-css-bgimage-control').css({textAlign:'center'}).text('loading...');$(_uploader._domTarget).css({zIndex:''});_uploader.activateHoverHandler();}
$(event.currentTarget).trigger({type:'complete',response:response,queueID:queueID});_uploader._scriptArgs.onComplete(event);return false;},onCancel:function(event,queueID,fileObj,data){var destination=$(event.currentTarget).data('destination');if(destination.hasClass('uploadify-queue-'+queueID)){destination.removeClass('uploadify-queue-'+queueID);$('.progress-bar','#rm-css-bgimage-control').removeClass('uploading');_uploader.activateHoverHandler();$(this._domTarget).css({zIndex:''});}
_uploader._scriptArgs.onCancel(event);return true;},onError:function(event,queueID,fileObj,errorObj){var destination=$(event.currentTarget).data('destination');if(destination.hasClass('uploadify-queue-'+queueID)){destination.removeClass('uploadify-queue-'+queueID);$('.progress-bar','#rm-css-bgimage-control').removeClass('uploading').addClass('error');_uploader.activateHoverHandler();$(_uploader._domTarget).css({zIndex:''});}
if(errorObj.type=="File Size"){showError("The file upload limit for backgrounds and banners is 4Mb");}
_uploader.onError(event);return true;}});},resetScriptArgs:function(){this._scriptArgs={rmPageId:getGlobal('fanPageId'),kid:getGlobal('kid'),type:'style',onSelect:function(resp){},onProgress:function(resp){},onComplete:function(resp){},onCancel:function(resp){},onError:function(resp){}};},getScriptArgs:function(){return this._scriptArgs;},setScriptArg:function(key,val){if(key===undefined){debug(this._name+'::setScriptArgs, no key defined!');return false;}
if(val===undefined&&this._scriptArgs.hasOwnProperty(key)){debug(this._name+'::setScriptArgs, deleting value for key '+key);delete this._scriptArgs[key];}else{this._scriptArgs[key]=val;}},activateHoverHandler:function(){if(!$(this._domTarget).data('hover_bound')){$(this._domTarget).bind('mouseenter',function(e){var progress_bar=$('.progress-bar','#rm-css-bgimage-control');progress_bar.addClass('hover').data('text_old',progress_bar.text()).text('upload new?');}).bind('mouseleave',function(e){var progress_bar=$('.progress-bar','#rm-css-bgimage-control');progress_bar.removeClass('hover').text(progress_bar.data('text_old'));}).data('hover_bound',true);}},deactivateHoverHandler:function(){if($(this._domTarget).data('hover_bound')){$(this._domTarget).removeClass('hover').unbind('mouseenter').unbind('mouseleave').data('hover_bound',false);}}});var BackgroundImageWidget=RMUIWidget.extend({_name:"BackgroundImageWidget",_uploaderSelector:'#bgimage-upload',_uploader:false,init:function(targetElement){this._position={top:0,left:0};this._bgsize={width:0,height:0};this._modified=false;this._super(targetElement);},install:function(){this._super();this._uploader=this.getWidget('BackgroundImageUploader',$(this._uploaderSelector))||new BackgroundImageUploader($(this._uploaderSelector));this._panWindow=$("<div class='rm-css-pan-window'></div>").css({display:'none',opacity:0,position:'absolute',top:0,left:0,width:'100%',height:'100%'}).appendTo(this._domTarget);this._panWindow.bind('mousedown',$.proxy(this,'processUserEvent'));},activate:function(){if(!this._super())return false;debug(this._name+'::activate : '+this._domTarget.attr('id'));this.loadImageDimensions();this._modified=false;this._domTarget.css({cursor:'move'}).children().animate({opacity:0.3},500);this._panWindow.css({display:'block'});return true;},deactivate:function(){this._super();debug(this._name+'::deactivate : '+this._domTarget.attr('id'));this._modified=false;$(this._domTarget).css({cursor:'pointer'});this._domTarget.children().animate({opacity:1},500);this._panWindow.css({display:'none'});},enable:function(){this._super();debug(this._name+'::enable : '+this._domTarget.attr('id'));this._uploader.activateHoverHandler();},changeMode:function(mode){switch(mode){case'css':this.enable();break;case'content':this.disable();break;}},disable:function(){this._super();debug(this._name+'::disable : '+this._domTarget.attr('id'));this._uploader.deactivateHoverHandler();},loadImageDimensions:function(){if(this._domTarget.css('background-image')!='none'){var bg_img=new Image();var img_src=this._domTarget.css('background-image').replace(/url\(/,'').replace(/"/g,'');img_src=img_src.substr(0,img_src.length-1);$(bg_img).load($.proxy(function(event){this._bgsize.width=event.currentTarget.width;this._bgsize.height=event.currentTarget.height;},this)).attr('src',img_src);}},setPosition:function(positionLeft,positionTop){var left=0;var top=0;if(positionLeft.indexOf('%')>-1){var ratio=(parseFloat(positionLeft)/100);left=this._domTarget.width()*ratio;left-=(ratio*this._bgsize.width);}else left=parseInt(positionLeft);if(positionTop.indexOf('%')>-1){var ratio=(parseFloat(positionTop)/100);top=this._domTarget.height()*ratio;top-=(ratio*this._bgsize.height);}else top=parseInt(positionTop);this._position.left=left;this._position.top=top;},getPosition:function(){return this._position;},hasModified:function(){return this._modified;},processUserEvent:function(event,doSuper){if(!event.data){event.data={};}
if(doSuper){return this._super(event);}
var target=$(event.currentTarget);if(event.data.cancel){this.deactivate();}
if(this.isActive()){switch(event.type){case'mousedown':target.data('origin',false).css({cursor:'move'});$('body').css({cursor:'move'}).bind('mousemove mouseup',{op:'offset'},$.proxy(this,'handleDrag'));debug('offset event started');break;default:break;}}
return this.processUserEvent(event,true);},handleDrag:function(event){var target=event.currentTarget;switch(event.data.op){case'offset':switch(event.type){case'mousemove':if(!this._panWindow.data('origin')){this._panWindow.data('origin',{x:event.pageX,y:event.pageY});}
var pos={left:event.pageX-parseInt(this._panWindow.data('origin').x),top:event.pageY-parseInt(this._panWindow.data('origin').y)};this._domTarget.css({backgroundPosition:(this.getPosition().left+pos.left)+"px "+(this.getPosition().top+pos.top)+"px"});this._modified=true;break;case'mouseup':debug('offset event stopped');var bgPos=this._domTarget.css('backgroundPosition');var offsets=bgPos.split(' ');this.setPosition(offsets[0],offsets[1]);$(target).css({cursor:'pointer'});$('body').css({cursor:''}).unbind('mousemove mouseup',this.handleDrag);event.stopPropagation();this.triggerEvent('update',this.getPosition());break;default:break;}
break;default:break;}
return false;}});var ImageUploadWidget=RMUIWidget.extend({_domSelector:false,_name:'ImageUploadWidget',_scTrackId:false,_queues:false,_host:'',_url:'',_args:{},DEFAULT_URL:'/upload',DEFAULT_WIDTH:100,DEFAULT_HEIGHT:100,_loadIndicator:false,_progressBar:false,_uploadifyForm:false,_waiting:false,init:function(targetElement,options){this._queues=new Array();this._host=Environment.getHost();this._url=this.DEFAULT_URL;this._args={'rmPageId':getGlobal('fanPageId'),'kid':getGlobal('kid')};this._width=$(targetElement).width()||this.DEFAULT_WIDTH;this._height=$(targetElement).height()||this.DEFAULT_HEIGHT;if(options){if(options.hasOwnProperty('url')){this._url=options.url;}
if(options.hasOwnProperty('data')){this._args=options.data;}
if(options.hasOwnProperty('width')){this._width=options.width;}
if(options.hasOwnProperty('height')){this._height=options.height;}}
this._domSelector=targetElement.attr('id');this._uploadifySelector=this._domSelector+'-uploadify';this._uploadify=false;var formDOM='<div id="'+this._domSelector+'-form"><input id="'+this._uploadifySelector+'" type="file" name="image" /><em class="help-overlay rc-m">Upload new image?</em></div>';this._uploadifyForm=$(formDOM);this._uploadifyForm.css({width:'100%',height:'100%','min-height':'10px',top:'0px',left:'0px',position:'absolute',zIndex:1}).appendTo(targetElement);this._waitMessage=$('<em class="help-overlay rc-m loading">Please wait</em>');this._waitMessage.css({zIndex:1}).appendTo(this._uploadifyForm).hide();this._waiting=false;this._resize=this.resize;this._super(targetElement);},install:function(){this._super();this._domTarget.addClass('rm-image-upload');$('.help-overlay',this._uploadifyForm).hide();this._domTarget.bind('mouseenter mouseleave',{widget:this},this.handleHover);debug(this._name+'::install, booting up uploadify');this.installUploadify();},installUploadify:function(){debug(this._name+'::installUploadify(): script destination = '+this._url);var _uploader=this;var width=this._domTarget.width||this.DEFAULT_WIDTH;var height=this._domTarget.height||this.DEFAULT_HEIGHT;$('#'+this._uploadifySelector).uploadify({uploader:'/flash/uploadify.swf',script:this._url,folder:'/var/www/cache/',cancelImg:'http://a.ak.static-rootmusic.com/images/soundcloud/cancel.png?v=2.70',buttonText:'Change',hideButton:true,fileDesc:'jpg, jpeg, png, gif',fileExt:'*.jpg;*.jpeg;*.gif;*.png',wmode:'transparent',scriptAccess:'always',sizeLimit:(1024*1024*4),height:this._height,width:this._width,multi:false,onInit:function(event){_uploader._uploadify=$('#'+_uploader._uploadifySelector);$('#'+_uploader._uploadifySelector+'Uploader').css({position:'absolute',zIndex:2});return true;},onSelect:function(event,queueID,fileObj){_uploader.upload();_uploader.storeQueueID(queueID);return false;},onOpen:function(event,queueID,fileObj){debug(_uploader._name+'::OPEN');_uploader.triggerEvent('uploadstart',{type:'uploadstart',queueID:queueID});return true;},onProgress:function(event,queueID,fileObj,data){debug(_uploader._name+'::PROGRESS');_uploader.triggerEvent('uploadprogress',{type:'uploadprogress',queueID:queueID,data:{percentage:data.percentage}});return false;},onComplete:function(event,queueID,fileObj,response,data){if(response){var json=eval('('+response+')');_uploader.triggerEvent('uploadcomplete',{type:'uploadcomplete',queueID:queueID,data:{response:json}});}else{debug('Error detected with file upload. Check logs for more info.');}
return true;},onCancel:function(event,queueID,fileObj,data){_uploader.triggerEvent('uploadcancel',{type:'uploadcancel',queueID:queueID});return true;},onError:function(event,queueID,fileObj,errObj){_uploader.triggerEvent('uploaderror',{type:'uploaderror',queueID:queueID,error:errObj});if(errorObj.type=="File Size"){showError("The file upload limit for album artwork is 4Mb");}
return true;}});},changeMode:function(mode){switch(mode){}},enable:function(){this._super();this._uploadifyForm.css({height:'',overflow:''});},disable:function(){this._super();this._uploadifyForm.css({height:0,overflow:'hidden'});},setArgs:function(data){if(data===undefined){debug(this._name+'::setArgs, no args given!');return false;}
this._args=data;},setArg:function(key,value){if(key===undefined){debug(this._name+'::setArg, no key given!');return false;}
this._args[key]=value;},setWaiting:function(isWaiting){this._waiting=isWaiting;},handleHover:function(event){if(!event.data.widget._waiting){switch(event.type){case'mouseenter':$('.help-overlay:not(.loading)',event.data.widget._domTarget).fadeIn('fast');break;case'mouseleave':$('.help-overlay',event.data.widget._domTarget).hide();break;default:break;}}
return false;},upload:function(){this._uploadify.uploadifySettings('script',this._url);this._uploadify.uploadifySettings('scriptData',this._args);this._uploadify.uploadifyUpload();debug(this._name+'::upload(): starting upload with new script args =');debug(this._args);},cancel:function(queueID){if(this.hasQueueID(queueID)){$(this._uploadifySelector).uploadifyCancel(queueID);}else{debug('Error: this uploadify instance doesn\'t have control of this queueID='+queueID);}},storeQueueID:function(queueID){if(!this.hasQueueID(queueID)){this._queues.push(queueID);}},hasQueueID:function(queueID){for(var i=0;i<this._queues.length;i++){if(this._queues[i]==queueID){return true;}}
return false;},resize:function(){$uploader=$('#'+this._uploadifySelector);var $img=this._domTarget.find('img'),width=this._width=$img.width(),height=this._height=$img.height();if($img.length>0&&width>0&&height>0){$uploader.attr('width',width).attr('height',height).siblings('object').attr('width',width).attr('height',height);$uploader.uploadifySettings('width',width);$uploader.uploadifySettings('height',height);}}});var MultiStyleWidget=RMUIWidget.extend({_name:'MultiStyleWidget',_mode:'static',_uploader:null,_els:{SWITCH_MODE_BTN:'#rm-multi-banner-switch',SIDEDRAWER:'#rm-appearance-multi-banner'},_templates:{banner_item:'<li class="rm-banner" rel="{ INDEX }">'+'<a href="#remove-banner" class="rm-remove-link corner-display" title="Remove this Banner">Remove</a>'+'<img src="{ IMAGE URL }" alt="Banner image { INDEX }" />'+'<span class="hidden" name="style">{ STYLE }</span>'+'</li>'},_styles:{},_current:'',init:function(el){this._super(el);},install:function()
{this._mode='static';this._styles={};this._current='rm-css-main-banner';this._super();$(this._els.SIDEDRAWER).data('template',this._templates.banner_item);this._uploader=new ImageUploadWidget($('#rm-appearance-multi-banner-upload'),{width:180,height:40,data:{type:'banner',rmPageId:getGlobal('fanPageId'),kid:getGlobal('kid')}});this._uploader.addCallback('uploadstart',this,this.handleUpload);this._uploader.addCallback('uploadprogress',this,this.handleUpload);this._uploader.addCallback('uploadcomplete',this,this.handleUpload);this._uploader.addCallback('uploadcancel',this,this.handleUpload);this._uploader.addCallback('uploaderror',this,this.handleUpload);this.hideBannerDrawer();$(this._els.SWITCH_MODE_BTN).show();if($('ul.thumbs li.rm-banner',this._els.SIDEDRAWER).length>1){this.setEditMode('multi');}
$(this._els.SIDEDRAWER).detach().bind('click',function(event){event.stopPropagation();}).appendTo('#editor-left-sidebar');var _multi_widget=this;$('ul.thumbs',this._els.SIDEDRAWER).sortable({containment:'parent',revert:true,tolerance:'pointer',update:function(event,ui){var new_pos=$('ul li.rm-banner:not(.ui-placeholder)',_multi_widget._els.SIDEDRAWER).index(ui.item);var old_pos=ui.item.attr('rel');Saver.save('style-reorder',{element:'rm-css-main-banner',oldPosition:old_pos,newPosition:new_pos},{success:function(resp){$('.rm-css-edit[rel='+_multi_widget._current+']').data('seq',new_pos);_multi_widget.refresh('current');debug('MultiBackgroundImageWidget - /rest/style/reorder - banner moved from '+old_pos+' to '+new_pos+' [SUCCESS]');},error:function(error){debug('MultiBackgroundImageWidget - /rest/style/reorder - cannot move banner from '+old_pos+' to '+new_pos+' [ERROR]');}});}});$(this._els.SIDEDRAWER).delegate('li.rm-banner','click',$.proxy(function(event){var $target=$(event.currentTarget);var styles=JSON.parse($('span[name=style]',$target).text());var seq=$target.attr('rel')||0;this.applyStyles(this._current,styles,seq);$target.addClass('selected').siblings().removeClass('selected').end();},this));$(this._els.SIDEDRAWER).delegate('a.rm-remove-link','click',$.proxy(function(e){e.stopPropagation();var $row=$(e.currentTarget).closest('li');var index=parseInt($row.attr('rel'));var styles=this.getCurrentStyles();var savedata={element:this._current};if(!isNaN(index)){styles.splice(index,1);savedata.index=index;}
if(styles.length<1){this.setEmptyBanner();}
$row.remove();Saver.save('style-delete',savedata,{success:$.proxy(function(data){debug('MultiStyleWidget - /rest/style/delete - image #'+index+' deleted [SUCCESS]');this.refresh('current',true);},this),error:$.proxy(function(){this.refresh('current',true);},this)});},this));$(this._els.SWITCH_MODE_BTN).bind('click',$.proxy(function(event){if(this._mode==='static'){this.setEditMode('multi');this.refresh();}else{this.setEditMode('static');}},this));this.refresh('first');},activate:function()
{this._super();$(this._els.SWITCH_MODE_BTN).show();if(this._mode=='multi'){this.showBannerDrawer();}else{var num_styles=this.getCurrentStyles().length;if(num_styles>1){this.setEditMode('multi');}}},deactivate:function()
{this._super();$(this._els.SWITCH_MODE_BTN).hide();if(this.drawerVisible()){this.hideBannerDrawer();}},enable:function()
{this._super();},disable:function()
{this._super();this.hideBannerDrawer();},getCurrentStyles:function(){if(!this._current){return[];}
var styles=this._styles[this._current]||[];return styles;},changeMode:function(mode){switch(mode){case'css':this.enable();break;case'content':this.disable();break;}},setEmptyBanner:function(){var css={backgroundImage:'none',height:'auto',backgroundColor:'transparent'};$('#editor-main-banner').attr('style','').css(css).removeData('original_size');$('.progress-bar','#rm-css-bgimage-control').removeClass('uploading').text('click to upload');$('#banner-placeholder').data('active',true).fadeIn();if($('#rm-css-background-color').is(':visible')){$('#rm-css-background-color').fadeOut();}
$('#editor-main-banner a.rm-window-resizer-dragger').hide();RMUIWidgetRelay.relayEvent(RMUIEvent.STYLE_CHANGE,{css:css,element:'rm-css-main-banner'});this.setEditMode('static');},buildStyleObject:function(rules,values){var mapped_styles={};for(var i in rules){if(rules[i]==='background-image'&&values[i].indexOf('_520')<0){var stripped_image=values[i].replace(/url\(/,'').replace(/\)/,'');values[i]='url('+this.getImageSize(stripped_image,'520')+')';}
mapped_styles[rules[i]]=values[i];}
return mapped_styles;},applyStyles:function(element,styles,seq)
{var defaults={'background-image':'none','background-position':'0px 0px','background-repeat':'no-repeat','background-color':'transparent'};var css=$.extend(defaults,styles);if(css.height){delete css.height;}
RMUIWidgetRelay.relayEvent(RMUIEvent.STYLE_CHANGE,{css:css,element:element,seq:seq});$(this._els.SWITCH_MODE_BTN).show();},toggleBannerDrawer:function(animate)
{if(animate===undefined){animate=true;}
return this.drawerVisible()?hideBannerDrawer(animate):showBannerDrawer(animate);},showBannerDrawer:function(animate)
{if(animate===undefined){animate=true;}
var $drawer=$(this._els.SIDEDRAWER);if(animate){$('#editor-left-sidebar > [id!="rm-appearance-multi-banner"]').animate({opacity:'-=0.5'},250).end()
$drawer.show().css({right:-$drawer.parent().outerWidth()+'px'}).animate({right:'-30px'},250);}else{$('#editor-left-sidebar > [id!="rm-appearance-multi-banner"]').hide().end()
$drawer.show();}},hideBannerDrawer:function(animate)
{if(animate===undefined){animate=true;}
var $drawer=$(this._els.SIDEDRAWER);if(animate){$drawer.siblings().animate({opacity:1},250).end().fadeOut();}else{$drawer.siblings().show().end().hide();}},drawerVisible:function()
{return $(this._els.SIDEDRAWER).is(':visible');},setEditMode:function(mode)
{if(mode===undefined){return false;}
switch(mode){case'static':$(this._els.SWITCH_MODE_BTN).fadeIn();$(this._els.SWITCH_MODE_BTN).html('Turn on Rotating Banners');if($('#rm-appearance-multi-banner ul li.rm-banner').length>0){Saver.save('disable-multi-banners',{});}
$(this._els.SIDEDRAWER+' ul').empty();this.hideBannerDrawer();break;case'multi':$(this._els.SWITCH_MODE_BTN).html('Turn off Rotating Banners');if(this.isActive()){this.showBannerDrawer();}
break;default:debug(this._name+'::setEditMode, invalid mode given: '+mode);return false;break;}
this._mode=mode;},refresh:function(op,sync,element)
{if(element===undefined){element=this._current;}
$.ajax({url:'/rest/style',type:'GET',data:{rmPageId:getGlobal('fanPageId'),element:element},dataType:'json',context:this,cache:false,success:$.proxy(function(response){var $banner_drawer=$('ul',this._els.SIDEDRAWER);$banner_drawer.empty();this._styles[element]=new Array();for(var i=0,style;style=response.styles[i++];){if(!style.image){debug('Banner has no image - no empty image paths should be present!',style);continue;}
var style_map=this.buildStyleObject(style.styles,style.attributes);var thumb_image=this.getImageSize(style.image,'180');var template=$('#rm-appearance-multi-banner').data('template').replace(/\{ IMAGE URL \}/g,thumb_image).replace(/\{ INDEX \}/g,style.seq).replace(/\{ STYLE \}/g,JSON.stringify(style_map));$(template).appendTo($banner_drawer);this._styles[element].push(style_map);}
var $selected;switch(op){case'first':$selected=$('#rm-appearance-multi-banner ul li:first-child').siblings().removeClass('selected').end().addClass('selected');break;case'last':$selected=$('#rm-appearance-multi-banner ul li:last-child').siblings().removeClass('selected').end().addClass('selected');break;case'current':default:var seq=$('#editor-main-banner').data('seq');$selected=$('#rm-appearance-multi-banner ul li[rel="'+seq+'"]').siblings().removeClass('selected').end().addClass('selected');}
if(sync&&$selected){$selected.trigger('click');}},this)});},getImageSize:function(path,identifier){var ext_indx=path.lastIndexOf('.');var ext=path.substring(ext_indx+1);var base=path.substring(0,ext_indx);return base+'_'+identifier+'.'+ext;},handleSelectionChange:function(selection,widget){this._current=false;if(selection&&selection.hasClass('multi')){var elem=selection.attr('rel');if(elem){this._current=elem;var current_seq=parseInt(selection.data('seq'));if(this.getCurrentStyles().length>0){if(isNaN(current_seq)){selection.data('seq',0);}}}
debug('ACTIVATING MULTI STYLE WIDGET ON SELECTION CHANGE');this.activate();}else{this.deactivate();}},handleStyleSave:function(data){var element;for(var i=0,style;style=data[i++];){if(style.element){element=style.element;break;}}
this.refresh('current',false,element);},handleUpload:function(event)
{debug(this._name+'::handleUpload - event:'+event.type,event);try{switch(event.type){case'uploadstart':$('#rm-appearance-multi-banner-upload div.progress-bar').show().css({width:0});$('#rm-appearance-multi-banner-upload div.progress-number').text('0%').show();break;case'uploadprogress':var banner_len=parseInt(event.data.percentage)/100*160;$('#rm-appearance-multi-banner-upload div.progress-bar').css({width:banner_len});$('#rm-appearance-multi-banner-upload div.progress-number').text(event.data.percentage+'%');break;case'uploaderror':break;case'uploadcomplete':$('#rm-appearance-multi-banner-upload div.progress-bar').hide();$('#rm-appearance-multi-banner-upload div.progress-number').hide();this.refresh();break;default:break;}}catch(e){debug('MultiBackgroundImageWidget - Upload failed due to exceptions - '+e.getMessage(),'error');}}});var ResizableWidget=RMUIWidget.extend({_name:"ResizableWidget",init:function(targetElement){this._windowHeight={height:0};this._modified=false;this._super(targetElement);},install:function(){this._super();$('<a class="rm-window-resize-dragger">Drag me to resize the frame</a>').css({position:'absolute',bottom:'0px',zIndex:1000,width:'100%',height:'20px',paddingTop:'5px',textAlign:'center',background:'#f9f9f9 url("http://b.ak.static-rootmusic.com/images/common/bg/bg_page_gradient_small.png?v=2.70") repeat-x bottom',borderTop:'1px solid #aaaaaa',cursor:'n-resize'}).hide().appendTo(this.getTarget());},changeMode:function(mode){switch(mode){case'css':if(this.getTarget().css('background-image')!=='none'){this.enable();}
break;case'content':this.disable();break;}},enable:function(){this._super();$('.rm-window-resize-dragger',this._domTarget).show().css({opacity:0}).animate({opacity:1},250).bind('mousedown',$.proxy(this,'processUserEvent'));},disable:function(){this._super();$('.rm-window-resize-dragger',this._domTarget).fadeOut().unbind('mousedown',this.processUserEvent);},activate:function(){this._super();$('.rm-window-resize-dragger',this.getTarget()).animate({opacity:0.2},500);$('body').css({cursor:'n-resize'}).bind('mousemove mouseup',$.proxy(this,'handleDrag'));debug('resize event started');},deactivate:function(){this._super();$('.rm-window-resize-dragger',this.getTarget()).animate({opacity:1},250);$('body').css({cursor:''}).unbind('mousemove mouseup',this.handleDrag);debug(this._name+'::handleDrag(): triggering height modification event');if(this.hasModified()){this.triggerEvent('heightmodified');this._modified=false;}},hasModified:function(){return this._modified;},handleStyleSave:function(styles){for(var i=0,style;style=styles[i++];){var element=style.element;if(!element){debug(this._name+'::handleStyleSave, no element found for style, given "'+element+'"');continue;}
var $elem=$('.rm-css-edit[rel="'+element+'"]');if($elem[0]===this.getTarget()[0]){if($elem.css('background-image')!=='none'){this.enable();}else{this.disable();}}}},processUserEvent:function(event,doSuper){if(doSuper)return this._super(event);var $target=$(event.currentTarget);if($target.hasClass('rm-window-resize-dragger')){switch(event.type){case'mousedown':this.activate();event.stopPropagation();break;default:break;}}
return this.processUserEvent(event,true);},handleDrag:function(event,doSuper){switch(event.type){case'mousemove':var height=(event.pageY-this.getTarget().offset().top);if(height>20){this.getTarget().height(height).css({height:height+'px'});this.triggerEvent('sizechanged');this._modified=true;}
event.stopPropagation();break;case'mouseup':this.deactivate();break;default:break;}
return false;}});var CSSEditWidget=RMUIWidget.extend({_name:"CSSEditWidget",_FONT_FAMILIES:{'default':'Futura, "Tw Cen MT", "Tw Cent MT", "Tw Cen", "Tw Cent", "Century Gothic", "Helvetica Neue", Helvetica, Arial, sans-serif','sans-serif-one':'"Helvetica Neue", Helvetica, Arial, sans-serif','sans-serif-two':'"Lucida Grande", Verdana, Geneva, sans-serif','block-sans':'Impact, Charcoal, sans-serif','monospace':'"Courier New", Monaco, Courier, monospace','serif-one':'Garamond, Georgia, serif','serif-two':'"Times New Roman", Times, serif','serif-three':'"Palatino Linotype", "Book Antiqua", Palatino, serif'},_multiEnabled:false,_multi_widget:null,init:function(options){this._selected=false;this._highlighted=false;this._banner=false;this._multiEnabled=false;if(options&&options.hasOwnProperty('multi')){this._multiEnabled=options.multi;}
this._dom={panel:$('#rm-appearance-panel'),typeSubpanel:$('#rm-appearance-type'),backgroundSubpanel:$('#rm-appearance-background'),mediaPlayerSubpanel:$('#rm-appearance-mediaplayer'),controls:$('#rm-appearance-controls'),multiBgPanel:$('#rm-appearance-multi-background')};$('.rm-css-edit','#editor-pane').each(function(){var constraints={};constraints.minFontSize=7;switch($(this).attr('rel')){																																																																																															case'rm-css-page-title':constraints.maxFontSize=100;
break;
case'rm-css-page-location':case'rm-css-fan-count':case'rm-css-info-header':case'rm-css-box-header':constraints.maxFontSize=100;
break;
case'rm-css-library-title':constraints.maxFontSize=100;
break;
case'rm-css-main-nav':constraints.maxFontSize=100;
break;
case'rm-css-ts-header':case'rm-css-ts-even':case'rm-css-ts-odd':constraints.maxFontSize=100;
case'rm-css-info-pane':default:constraints.maxFontSize=100;
break;}
$(this).data('css_constraints',constraints);});this._super($('body'));this.addGlobalCallback(RMUIEvent.STYLE_CHANGE,this,this.handleStyleChange);this.disable();},install:function(){this._super();debug('INSTALLING APPEARANCE EDITOR.');$('.rm-css-highlight-window').live('click',function(ce){var $target=$(ce.currentTarget);if($target.data('delegate')){$target.data('delegate').trigger({type:ce.type,pageX:ce.pageX,pageY:ce.pageY});return false;}});$('#banner-placeholder').data('orig_text',$('#banner-placeholder').text());if(this._multiEnabled){this._multi_widget=new MultiStyleWidget(this._domTarget);this.addCallback(RMUIEvent.STYLE_SELECT,this._multi_widget,this._multi_widget.handleSelectionChange);this.addCallback(RMUIEvent.STYLE_SAVE,this._multi_widget,this._multi_widget.handleStyleSave);}
var banner_resize_widget=new ResizableWidget($('.rm-css-edit[rel="rm-css-main-banner"]'));banner_resize_widget.addCallback('sizechanged',this,this.refreshHighlightWindows);banner_resize_widget.addCallback('heightmodified',this,this.cssEvent,{data:{action:'height'}});this.addCallback(RMUIEvent.STYLE_SAVE,banner_resize_widget,banner_resize_widget.handleStyleSave);$('.rm-css-edit').each($.proxy(function(indx,elem){var $elem=$(elem);if($elem.hasClass('bg')&&$elem.hasClass('bgimg')){debug('EDIT background-img:'+$elem.attr('id')+',  '+$elem.attr('class'));var bg_widget=new BackgroundImageWidget($elem);bg_widget.addCallback('update',this,function(position){var event={data:{action:'bgposition',position:position}};this.cssEvent(event);});}},this));$('select',this._dom.typeSubpanel).uniform();this.installPanel();},handleStyleChange:function(data,widget){if(!data.element){debug(this._name+'::handleStyleChange, no valid element found!');return false;}
var $element=$('.rm-css-edit[rel='+data.element+']');var on_selection=($element[0]==this._selected[0]);if(on_selection){if(this._selected.data('modified')){this.save();}}
var anim_props=['background-position','background-color','color','font-size'];var css=data.css;$element.css(css);if($element.hasClass('multi')){var current_seq=parseInt(data.seq);if(!isNaN(current_seq)){var old_seq=parseInt($element.data('seq'));if(!isNaN(old_seq)){$element.removeClass('seq-'+old_seq);}
$element.addClass('seq-'+current_seq).data('seq',current_seq);}else{$element.removeData('seq');}}
if(on_selection){this.storeCSS(this._selected);this.setCSSPanelFields(this._selected);this.refreshCSSPanel();var bg_widget=this.getWidget('BackgroundImageWidget',this._selected);if(bg_widget){debug('LOADING NEW IMAGE DIMENSIONS FOR ELEMENT '+data.element);bg_widget.loadImageDimensions();}}},installPanel:function(){this._panel=this._dom.panel;this._panel.hide().appendTo(this._domTarget);this._domTarget.bind('click',{cancel:true},$.proxy(this,'processUserEvent'));this._panel.bind('click',{cancel:true},$.proxy(this,'processUserEvent'));$('#rm-css-type-bold').bind('click',{action:'bold'},$.proxy(this,'cssEvent'));$('#rm-css-type-italic').bind('click',{action:'italic'},$.proxy(this,'cssEvent'));$('#rm-css-type-increasesize').bind('mousedown mouseup',{action:'sizeup'},$.proxy(this,'cssEvent'));$('#rm-css-type-decreasesize').bind('mousedown mouseup',{action:'sizedown'},$.proxy(this,'cssEvent'));$('#rm-css-color-foreground').bind('change',{action:'fcolor'},$.proxy(this,'cssEvent'));$('#rm-css-font-family').bind('change',{action:'family'},$.proxy(this,'cssEvent'));$('#rm-css-color-background').bind('change',{action:'bcolor'},$.proxy(this,'cssEvent'));$('#rm-css-bg-transparent').bind('click',{action:'bcolor'},$.proxy(this,'cssEvent'));$('#rm-css-bgposition-top').bind('click',{action:'bgposition',anchor:'top'},$.proxy(this,'cssEvent'));$('#rm-css-bgposition-right').bind('click',{action:'bgposition',anchor:'right'},$.proxy(this,'cssEvent'));$('#rm-css-bgposition-bottom').bind('click',{action:'bgposition',anchor:'bottom'},$.proxy(this,'cssEvent'));$('#rm-css-bgposition-left').bind('click',{action:'bgposition',anchor:'left'},$.proxy(this,'cssEvent'));$('#rm-css-bgposition-free').bind('click',{action:'bgposition'},$.proxy(this,'cssEvent'));$('#bgposition-more-info-link').bind('click',function(){if($('#bgposition-more-info').is(':hidden')){$('#bgposition-more-info').show('slow');}else $('#bgposition-more-info').hide('slow');});$('#rm-css-bgrepeat-x').bind('click',{action:'bgrepeat',axis:'x'},$.proxy(this,'cssEvent'));$('#rm-css-bgrepeat-y').bind('click',{action:'bgrepeat',axis:'y'},$.proxy(this,'cssEvent'));$('#rm-css-bgimage-uploader').bind('complete',{action:'bgimage'},$.proxy(this,'cssEvent'));$('#rm-css-bgimage-remove').bind('click',{action:'bgimage',remove:true},$.proxy(this,'cssEvent'));$('#rm-css-bgimage-uploader').data(''+this._name,this);$('#rm-css-color-playertheme').bind('change',{action:'playertheme'},$.proxy(this,'cssEvent'));$('#rm-css-playertheme-transparent').bind('click',{action:'playertheme'},$.proxy(this,'cssEvent'));$('#rm-css-color-playerprimary').bind('change',{action:'playerprimary'},$.proxy(this,'cssEvent'));$('#rm-css-color-playersecondary').bind('change',{action:'playersecondary'},$.proxy(this,'cssEvent'));$('#rm-css-color-playertext').bind('change',{action:'playertext'},$.proxy(this,'cssEvent'));$('#rm-css-control-cancel').bind('click',{cancel:true},$.proxy(this,'processUserEvent'));$('#rm-css-control-close').bind('click',$.proxy(function(event){this.saveAndClose();return false;},this));var css_widget=this;$('.rm-color-select',this._panel).ColorPicker({onChange:css_widget.handleColorpicker}).each(function(){var id=$(this).data('colorpickerId');debug('found color picker div with id '+id);$('#'+id).data('linked_div',$(this));});$('.colorpicker').css({zIndex:parseInt(this._panel.css('zIndex'))+1});},activate:function(){this._super();},deactivate:function(){this._super();this._panel.fadeOut();},enable:function(){$('.rm-css-edit').css({cursor:'inherit'});$('.rm-css-hide').not('.hidden').fadeOut();$('.rm-css-noui','#editor-pane').bind('mouseover click',this.preventButtonCSS);$('input, textarea','#editor-pane').attr('disabled','disabled');if($('#banner-placeholder').is(':visible')){$('h3','#banner-placeholder').stop().css({opacity:1}).fadeOut(function(){$(this).text('Click to bring up image options');$(this).fadeIn();});if($('#banner-tip-520px').length==0){$('#editor-main-banner').before('<span id="banner-tip-520px" style="position: absolute; top:0px; left:1px"><img src="http://c.ak.static-rootmusic.com/images/common/bg/bg_520px.png?v=2.70" alt="The BandPage is 520px wide." /></span>');}
$('#banner-tip-520px').show().animate({top:-30},{duration:400});}
var _css_widget=this;$('.rm-css-edit').each(function(){_css_widget.storeCSS($(this));});this._domTarget.bind('mouseover mouseout',$.proxy(this,'processUserEvent'));},disable:function(){if(this._active){this.deactivate();if(this._selected){this.cancel();this.clearSelected();}
if(this._highlighted){this._highlighted.css({zIndex:'',cursor:''}).unbind('click',this.processUserEvent);this._highlighted=false;}}
if($('#banner-placeholder').is(':visible')&&($('#banner-placeholder').text()!=$('#banner-placeholder').data('orig_text'))){$('h3','#banner-placeholder').stop().css({opacity:1}).fadeOut(function(){$(this).text($(this).parent().data('orig_text'));$(this).fadeIn();});}
if($('#banner-tip-520px').length>0){$('#banner-tip-520px').fadeOut(function(){$(this).css('top',0).hide();});}
$('.rm-css-edit').css({cursor:''});$('.rm-css-hide').not('.hidden').fadeIn();$('.rm-css-noui','#editor-pane').unbind('mouseover click',this.preventButtonCSS).each(function(){$(this).css({backgroundColor:'',color:'',border:'',borderWidth:'1px'});});$('input, textarea','#editor-pane').removeAttr('disabled');$('#submenu-info-media').show();this._domTarget.unbind('mouseover mouseout',this.processUserEvent);},changeMode:function(mode){switch(mode){case'css':this.enable();break;case'content':this.disable();break;default:break;}},disableBgTransparency:function(){$('.rm-color-transparent').hide();$('.rm-css-color-selector').unbind('mouseenter mouseleave');},enableBgTransparency:function(){$('.rm-color-transparent').css({display:'block',opacity:0});$('.rm-css-color-selector').bind('mouseenter',function(event){$(event.currentTarget).children('.rm-color-transparent').stop().animate({opacity:1},250);}).bind('mouseleave',function(event){$(event.currentTarget).children('.rm-color-transparent').stop().animate({opacity:0},250);});},style:function(){var domName;for(domName in this._css){if(this._dom[domName]){var prop;for(prop in this._css[domName]){this._dom[domName].css(prop,this._css[domName][prop]);}}}},clearSelected:function(){this.removeSelected();this.triggerEvent(RMUIEvent.STYLE_SELECT,false);},removeSelected:function(){if(this._selected){this.disableExtraWidgets();this._selected.removeClass("rm-css-selected");this._selected.css({zIndex:'',cursor:''}).unbind('click',this.processUserEvent);this._selected=false;}},setNewSelection:function(selection){this._selected=selection;this._selected.addClass('rm-css-selected').css({zIndex:0});$('.rm-css-selected-window').css({zIndex:0});},setCSSPanelFields:function(source){debug(this._name+'::setCSSPanelFields - ',source);if(!source||!source.data('css')){debug(this._name+'::setCSSPanelFields, no source or no valid CSS data given!');return false;}
var css=source.data('css');if(this._selected.attr('rel')==='rm-css-main-banner'&&$('#editor-main-banner').css('background-image')==='none'){$('#banner-placeholder').data('active',true);}
$('#rm-css-bgimage-uploader').data('destination',this._selected);$('#bgimage-upload').css({zIndex:''});$('#rm-css-type-bold, #rm-css-type-italic').removeClass('active');$('#rm-css-font-family').children(':selected').removeAttr('selected').end().children('option[value=default]').attr('selected','selected');$('#rm-css-bgimage-remove, #rm-css-bgimage-advanced').hide();$('.progress-bar','#rm-css-bgimage-control').css({textAlign:'center',width:'100%'}).text('click to upload');$('#rm-css-bgimage-remove, #rm-css-bgimage-advanced').hide();for(var property in css){switch(property){case'font-size':$('#rm-css-type-size-indicator').text(Math.round(parseInt(css[property])));break;case'font-weight':if(css[property]==='bold'){$('#rm-css-type-bold').addClass('active');}
break;case'font-style':if(css[property]==='italic'){$('#rm-css-type-italic').addClass('active');}
break;case'font-family':var currentFamily=css[property].replace(/["'\s,]/g,'').toLowerCase();var foundMatch=false;for(var f in this._FONT_FAMILIES){if(currentFamily.search(this._FONT_FAMILIES[f].replace(/["'\s,]/g,'').toLowerCase())==0){foundMatch=f;break;}}
if(foundMatch){$('#rm-css-font-family').children('option[value='+f+']').attr('selected','selected');$.uniform.update('#rm-css-font-family');}
break;case'color':$("#rm-css-color-foreground").css({backgroundColor:css[property]}).ColorPickerSetColor(Color.rgbStrToHex(css[property]));$("#rm-css-color-playertext").css({backgroundColor:css[property]}).ColorPickerSetColor(Color.rgbStrToHex(css[property]));break;case'background-color':if(css[property].indexOf('rgb(')===0){var color=Color.rgbStrToHex(css[property]);}else{var color=css[property];}
$("#rm-css-color-background").css({backgroundColor:css[property]}).ColorPickerSetColor(color);$("#rm-css-color-playertheme").css({backgroundColor:css[property]}).ColorPickerSetColor(Color.rgbStrToHex(css[property]));break;case'background-position':$('#rm-css-background-anchors').children('a').removeClass('active');$('#rm-css-bgposition-free').removeClass('active');var bg_pos=css[property].split(' ');var is_free=(bg_pos.length>1&&(bg_pos[0].indexOf('%')<0&&bg_pos[0].indexOf('%')<0));if(!is_free){if(bg_pos.length<2){bg_pos[1]=bg_pos[0];}
switch(bg_pos[0]){case'0%':$('#rm-css-bgposition-left').addClass('active');break;case'50%':break;case'100%':$('#rm-css-bgposition-right').addClass('active');break;default:is_free=true;break;}
switch(bg_pos[1]){case'0%':$('#rm-css-bgposition-top').addClass('active');break;case'50%':break;case'100%':$('#rm-css-bgposition-bottom').addClass('active');break;default:is_free=true;break;}}else{$('#rm-css-background-anchors').children('a').removeClass('active');$('#rm-css-bgposition-free').addClass('active');}
break;case'background-repeat':$('#rm-css-bgrepeat').children('a').removeClass('active');var bgRepeat=css[property].split(' ');if(bgRepeat.length>1){if(bgRepeat[0]==='repeat'){$('#rm-css-bgrepeat-x').addClass('active');}
if(bgRepeat[1]==='repeat'){$('#rm-css-bgrepeat-y').addClass('active');}}else{switch(css[property]){case'repeat-x':$('#rm-css-bgrepeat-x').addClass('active');break;case'repeat-y':$('#rm-css-bgrepeat-y').addClass('active');break;case'repeat':$('#rm-css-bgrepeat-x, #rm-css-bgrepeat-y').addClass('active');break;default:$('#rm-css-bgrepeat-x, #rm-css-bgrepeat-y').removeClass('active');break;}}
break;case'background-image':$('.progress-bar','#rm-css-bgimage-control').removeClass('hover').removeClass('uploading');debug('CSSEditWidget::setCSSPanelFields - Setting background-image ',css);if(css[property]!=='none'&&!css[property].match(/\?v=\d/)){debug(css[property]);$('.progress-bar','#rm-css-bgimage-control').css({textAlign:'center',width:'100%'}).text('Add Custom Image');$('#rm-css-bgimage-remove, #rm-css-bgimage-advanced, #rm-css-background-color').show();}
break;}}
if(this._selected.data('rmplayer-primary-ui')){$("#rm-css-color-playerprimary").css({backgroundColor:this._selected.data('rmplayer-primary-ui')}).ColorPickerSetColor(Color.rgbStrToHex(this._selected.data('rmplayer-primary-ui')));}
if(this._selected.data('rmplayer-secondary-ui')){$("#rm-css-color-playersecondary").css({backgroundColor:this._selected.data('rmplayer-secondary-ui')}).ColorPickerSetColor(Color.rgbStrToHex(this._selected.data('rmplayer-secondary-ui')));}},refreshCSSPanel:function(){debug(this._name+'::refreshCSSPanel - id:'+$(this._selected).attr('id')+' classes:'+$(this._selected).attr('class'));this.setCSSPanelFields(this._selected);this._dom.typeSubpanel.hide();this._dom.backgroundSubpanel.hide();this._dom.mediaPlayerSubpanel.hide();$('#rm-css-bgimage-advanced').hide();if(this._selected.hasClass('fg'))this._dom.typeSubpanel.show();if(this._selected.hasClass('bg')){this._dom.backgroundSubpanel.show();if($('#rm-css-background-color').is(':hidden')){$('#rm-css-background-color').show();}
if(this._selected.hasClass('bgtrans')){this.enableBgTransparency();}else{this.disableBgTransparency();}}
if(this._selected.hasClass('mp')){this._dom.mediaPlayerSubpanel.show();this.disableBgTransparency();}
if(this._selected.hasClass('bgimg')){debug(this._name+'::refreshCSSPanel : handle extra widgets backgroundImage = '+this._selected.css('backgroundImage'));if(this._selected.attr('rel')=='rm-css-main-banner'||!$('#banner-placeholder').data('active')){if(this._selected.attr('id')=='editor-main-banner'){$('#rm-multi-banner-switch').hide();var bg_widget=this.getWidget('BackgroundImageWidget',this._selected);if(bg_widget){bg_widget.loadImageDimensions();bg_widget.enable();}}}
$('.bgimg',this._dom.backgroundSubpanel).show();if(this._selected.css('backgroundImage')!='none'&&!this._selected.css('backgroundImage').match(/\?v=\d/)){$('#rm-css-bgimage-advanced',this._dom.backgroundSubpanel).show();}}else{$('.bgimg',this._dom.backgroundSubpanel).hide();$('#rm-css-bgimage-advanced',this._dom.backgroundSubpanel).hide();}
if(this._selected.attr('rel')=='rm-css-main-banner'&&$('#banner-placeholder').data('active')){$('#rm-css-background-color').hide();}
if(this._selected.hasClass('fgtype')){$('.fgtype',this._dom.typeSubpanel).show();}else{$('.fgtype',this._dom.typeSubpanel).hide();}
$('#rm-css-control-cancel').hide();},retarget:function(){this.removeSelected();this.setNewSelection(this._highlighted);this.refreshCSSPanel();this.triggerEvent(RMUIEvent.STYLE_SELECT,this._selected);},shiftLocation:function(coords,animIn){var animParams={};if(animIn){this._panel.css({display:"block",opacity:0,left:coords.x-32+'px',top:coords.y+'px',height:'auto'});animParams.opacity=1;animParams.height=this._panel.height()+'px';this._panel.height(0);}
animParams.left=coords.x-32+'px';animParams.top=coords.y+15+'px';this._panel.animate(animParams,250);},save:function(){this.storeCSS(this._selected);this.writeCSS(this._selected);this.removeInlineStyles(this._selected);this.disableExtraWidgets();var elemName=this._selected.attr('rel');var css={};css[elemName]=this._selected.data('css');if(this._selected.data('original_size')){css[elemName]['background-image']='url('+this._selected.data('original_size')+')';}
if(this._selected.data('rmplayer-primary-ui')&&this._selected.data('rmplayer-primary-modified')){var primaryUIValue=this._selected.data('rmplayer-primary-ui');css['rm-css-playerprimary']={'background-color':primaryUIValue};}
if(this._selected.data('rmplayer-secondary-ui')&&this._selected.data('rmplayer-secondary-modified')){var secondaryUIValue=this._selected.data('rmplayer-secondary-ui');css['rm-css-playersecondary']={'background-color':secondaryUIValue};}
var savedata={css:css,seq:0};if(this._selected.hasClass('multi')){var current_seq=parseInt(this._selected.data('seq'));if(isNaN(current_seq)){current_seq=0;}
$.extend(savedata,{seq:current_seq});}
debug(this._name+'::save, saving styles for elem: '+this._selected.attr('rel'));Saver.save('rm-appearance-style',savedata,{success:$.proxy(function(response){if(!response||!response.hasOwnProperty('styles')){debug('Style save callback error: invalid response from backend given');return false;}
if(response.styles.length<1){debug('Style save callback error: no styles given on return object');return false;}
this.triggerEvent(RMUIEvent.STYLE_SAVE,response.styles);},this)});this._selected.data('rmplayer-primary-modified',false);this._selected.data('rmplayer-secondary-modified',false);this._selected.data('modified',false);},cancel:function(){var banner=$('#editor-main-banner');banner.data('before',$('#editor-main-banner').css('background-image'));if(this._selected.attr('rel')=='rm-css-info-pane'){this.removeInlineStyles($('.active','#edit-main-info .editor-submenu'));}
this.removeInlineStyles(this._selected);if(this._selected.attr('rel')=='rm-css-rmplayer'){var _widget=this;this._selected.find('[rel=rm-css-playerprimary],[rel=rm-css-playersecondary]').each(function(){$(this).attr('style','');_widget._selected.find('polygon, rect').attr('fill','#'+_widget._selected.data('rmplayer-icon-fill'));});}
banner.data('after',$('#editor-main-banner').css('background-image'));this.disableExtraWidgets();$('.rm-css-selected-window').fadeOut('fast',function(){$(this).remove();});if($('#rm-css-control-cancel').is(':visible')){$('#rm-css-control-cancel').hide();}
if(banner.data('before')=='none'&&banner.data('after')!='none'){$('#banner-placeholder').data('active',false).fadeOut();}else if(banner.data('before')!='none'&&banner.data('after')=='none'){$('#banner-placeholder').data('active',true).fadeIn();}},close:function(){this.clearSelected();$('.rm-css-selected-window').data('delegate',false).fadeOut(function(){$(this).remove();});this.deactivate();},saveAndClose:function(){if(this._selected){this.save();}
this.close();},storeCSS:function(target){debug('storeCSS:',target);var css={};if(target.hasClass('fg')){css.color=target.css("color");if(target.hasClass('fgtype')){css['font-family']=target.css("fontFamily");css['font-size']=target.css("fontSize");css['font-style']=target.css("fontStyle");css['font-weight']=target.css("fontWeight");css['letter-spacing']=target.css("letterSpacing");css['text-transform']=target.css("textTransform");}}
if(target.hasClass('bg')){css['background-color']=target.css("backgroundColor");if(target.hasClass('bgimg')){css['background-image']=target.css('backgroundImage');css['background-repeat']=target.css('backgroundRepeat');css['background-position']=target.css('backgroundPosition');}}
if(target.hasClass('border')){css['outline-color']=target.css("outlineColor");css['outline-style']=target.css("outlineStyle");css['outline-width']=target.css("outlineWidth");}
if(target.hasClass('resizable')){}
switch(target.attr('rel')){case'rm-css-rmplayer':css['background-color']=target.css('backgroundColor');css['color']=target.css('color');var rmplayerPrimary=$('[rel="rm-css-playerprimary"]',target);if(rmplayerPrimary.length){target.data('rmplayer-primary-ui',rmplayerPrimary.css('background-color'));}
var rmplayerSecondary=$('[rel="rm-css-playersecondary"]',target);if(rmplayerSecondary.length){target.data('rmplayer-secondary-ui',rmplayerSecondary.css('background-color'));}
break;default:break;}
debug('target.data.rmplayer-primaryui = '+target.data('rmplayer-primary-ui'));debug('target.data.rmplayer-secondaryui = '+target.data('rmplayer-secondary-ui'));target.each(function(){$(this).data('css',css);});},restoreCSS:function(target){debug(this._name+"::restoreCSS");var css;if(css=target.data("css")){var prop;for(prop in css){target.css(prop,css[prop]);}}},writeCSS:function(target){var element=target.attr('rel');var id=element;var styleText='#editor-pane-container .rm-css-edit[rel='+element+']';if(target.hasClass('multi')){var seq=parseInt(target.data('seq'));if(isNaN(seq)){seq=0;}
id+='-seq'+seq;styleText+='.seq-'+seq;}
styleText+=' {';var css=target.data('css');if(css){for(var attr in css){styleText+=attr.camelToHyphen()+":"+css[attr]+"; ";}}
styleText+="}";var styleBlock=$('style#'+id);if(styleBlock.length>0){styleBlock.remove();}
styleBlock=$('<style>'+styleText+'</style>');styleBlock.attr('type','text/css').attr('id',id);styleBlock.appendTo($("head"));if(id=='rm-css-info-pane'){styleText="#editor-pane-container .rm-css-edit[rel='rm-css-main-nav'].active { ";if(css){styleText+="background-color: "+css.backgroundColor+";";styleText+="color: "+css.color+";";}
styleText+=" }";styleBlock=$('#rm-css-main-nav-active');if(styleBlock.length>0){styleBlock.remove();}
styleBlock=$('<style>'+styleText+'</style>');styleBlock.attr('type','text/css').attr('id','rm-css-main-nav-active');styleBlock.appendTo($('head'));}
else if(id=='rm-css-rmplayer'){debug('writing extra styles for rmplayer...');styleText='';if(target.data('rmplayer-primary-ui')){debug('writing primary styles...');styleText+='#editor-pane-container #rmplayer [rel="rm-css-playerprimary"] { background-color: '+target.data('rmplayer-primary-ui')+'; }';}
if(target.data('rmplayer-secondary-ui')){debug('writing secondary styles...');styleText+='#editor-pane-container #rmplayer [rel="rm-css-playersecondary"] { background-color: '+target.data('rmplayer-secondary-ui')+'; }';}
styleBlock.append(styleText);}},removeInlineStyles:function(target){/*$(target).each(function(){var $this=$(this);var css=$this.data('css');if(css){var styles=$this.attr('style').split(';');$this.removeAttr('style');var styleStr="";var styleArr=[];var inlineStyles={};for(var i=0,style;style=styles[i++];){styleStr=style.trim();styleArr=styleStr.split(':');if(styleArr.length==2){inlineStyles[styleArr[0]]=styleArr[1].trim();}}
var newStyleStr='';for(var inlineStyle in inlineStyles){if(!css[inlineStyle]){newStyleStr+=inlineStyle.camelToHyphen()+":"+inlineStyles[inlineStyle]+";";}}
$(this).attr('style',newStyleStr);}});*/},preventButtonCSS:function(me){if($(me.currentTarget).parents('div').attr('id')=='nav-tabs'){return false;}
$(me.currentTarget).css({'background-color':$(me.currentTarget).css('background-color'),'color':$(me.currentTarget).css('color'),'border':'none'});},refreshHighlightWindows:function(){$('.rm-css-highlight-window, .rm-css-selected-window').each(function(){var $delegate=$(this).data('delegate');if($delegate){$(this).css({left:$delegate.position().left+(parseInt($delegate.css('margin-left'))-5)+'px',top:$delegate.position().top+(parseInt($delegate.css('margin-top'))-5)+'px',width:$delegate.outerWidth()+'px',height:$delegate.outerHeight()+'px'});}});},disableExtraWidgets:function(){if(this._selected){var bgwidget=this.getWidget('BackgroundImageWidget',this._selected);if(bgwidget){var bg_css=this._selected.css('backgroundPosition');if(bg_css){var bg_pos=bg_css.split(' ');bgwidget.setPosition(bg_pos[0],bg_pos[1]);}
if(bgwidget._active)bgwidsizeupget.deactivate();}}},handleColorpicker:function(hsb,hex,rgb){var colorpicker=$(this).closest('.colorpicker');colorpicker.data('linked_div').css({backgroundColor:'#'+hex}).trigger({type:'change',color:'#'+hex});},cssEvent:function(event){var $this=this;if(event.data===undefined){debug(this._name+'::cssEvent, no action found on event!');return false;}
switch(event.data.action){case'bold':this._selected.css({fontWeight:function(indx,val){return(val=="bold")?"normal":"bold";}});$("#rm-css-type-bold").toggleClass('active');break;case'italic':this._selected.css({fontStyle:function(indx,val){return(val=="italic")?"normal":"italic";}});$("#rm-css-type-italic").toggleClass('active');break;case'sizeup':switch(event.type){case'mousedown':$(event.currentTarget).data('is_holding',true);break;case'mouseup':$(event.currentTarget).data('is_holding',false);return true;break;default:break;}
if($(event.currentTarget).data('is_holding')){var maxSize=50;if(this._selected.data('css_constraints')){maxSize=100/*parseInt(this._selected.data('css_constraints').maxFontSize)*/;}
this._selected.css({fontSize:function(indx,val){return Math.min(parseInt(val)+1,maxSize);}});$("#rm-css-type-size-indicator").text(parseInt(this._selected.css('fontSize')));var timeout=(event.type=='hold')?100:500;event.type='hold';setTimeout(function(){this.cssEvent(event);},timeout);}
break;case'sizedown':switch(event.type){case'mousedown':$(event.currentTarget).data('is_holding',true);break;case'mouseup':$(event.currentTarget).data('is_holding',false);return true;break;default:break;}
if($(event.currentTarget).data('is_holding')){var minSize=7;if(this._selected.data('css_constraints')){minSize=parseInt(this._selected.data('css_constraints').minFontSize);}
this._selected.css({fontSize:function(indx,val){return Math.max(parseInt(val)-1,minSize);}});$("#rm-css-type-size-indicator").text(parseInt(this._selected.css('fontSize')));var timeout=(event.type=='hold')?100:500;event.type='hold';setTimeout(function(){this.cssEvent(event);},timeout);}
break;case'fcolor':switch(this._selected.attr('rel')){case'rm-css-info-pane':$(".rm-css-edit[rel='rm-css-main-nav']").data('active-css-fg',this._selected.css('color')).filter('.active').css({color:this._selected.css('color')});break;case'rm-css-rmplayer':if(this._selected.attr('id')=='scplayer'){$('[rel="rm-css-playersecondary"], .rmplayer-secondary-ui','#rmplayer').css({backgroundColor:event.color});$('#rmplayer').data('rmplayer-secondary-ui',event.color).data('rmplayer-secondary-modified',true);}
break;default:break;}
this._selected.css({color:event.color});break;case'bcolor':if(this._selected.attr('rel')=='rm-css-main-banner'&&$('#banner-placeholder').data('active')){return false;}
if(event.color){this._selected.css({backgroundColor:event.color});}else{this._selected.css({backgroundColor:'transparent'});}
switch(this._selected.attr('rel')){case'rm-css-info-pane':$(".rm-css-edit[rel='rm-css-main-nav']").data('active-css-bg',this._selected.css('backgroundColor')).filter('.active').css({backgroundColor:this._selected.css('backgroundColor')});break;case'rm-css-rmplayer':if(this._selected.attr('id')=='scplayer'){var offsetColor=Color.offsetColor(event.color,.2);$('[rel="rm-css-playerprimary"], .rmplayer-primary-ui','#rmplayer').css({backgroundColor:offsetColor});this._selected.data('rmplayer-primary-ui',offsetColor).data('rmplayer-primary-modified',true);}
break;default:break;}
break;case'family':var selectedFamily=$(event.currentTarget).children(':selected').val();this._selected.data("fontFamily",selectedFamily).css({fontFamily:this._FONT_FAMILIES[selectedFamily]});break;case'bgimage':if(event.data.remove&&confirm('Are you sure you want to remove the background image? This action cannot be undone after you save changes on this element. Just checking!')){this._selected.css({backgroundImage:'none',height:'auto',backgroundColor:'transparent'}).removeData('original_size');this.disableExtraWidgets();$('#rm-css-bgimage-advanced, #rm-css-bgimage-remove').fadeOut();$('.progress-bar','#rm-css-bgimage-control').removeClass('uploading').text('click to upload');if(this._selected.attr('rel')=='rm-css-main-banner'&&!$('#banner-placeholder').data('active')){$('#banner-placeholder').data('active',true).fadeIn();if($('#rm-css-background-color').is(':visible')){$('#rm-css-background-color').fadeOut();}}}else if(event.response&&event.queueID){debug('image just finish uploading');var queueEl=$('.uploadify-queue-'+event.queueID);var url='';var original_size='';switch(typeof(event.response)){case'string':url=event.response;break;case'object':if(event.response.hasOwnProperty('full')){url=event.response.full;}
if(event.response.hasOwnProperty('original')){url=url||event.response.original;original_size=event.response.original;}
break;}
var loader=new Image();$(loader).load($.proxy(function(e){if(queueEl.attr('rel')=='rm-css-main-banner'){if($('#banner-placeholder').data('active')||$('#banner-placeholder').is(':visible')){$('#banner-placeholder').data('active',false).fadeOut();if($('#rm-css-background-color').is(':hidden'))$('#rm-css-background-color').fadeIn();}
var maxHeight=($('#editor-main-banner').css('max-height'))?parseInt($('#editor-main-banner').css('max-height')):500;var newHeight=Math.min(loader.height,maxHeight);this.cssEvent({data:{action:'height',height:newHeight,element:queueEl}});}
queueEl.css({backgroundImage:'url("'+url+'")',backgroundPosition:'0px 0px',backgroundRepeat:'no-repeat'}).data('original_size',original_size);if(this._selected.index(queueEl.get(0))>=0){$('.progress-bar','#rm-css-bgimage-control').removeClass('uploading').text('Add Custom Image');this.setCSSPanelFields(this._selected);$('#rm-css-bgimage-advanced, #rm-css-bgimage-remove').fadeIn();$('#rm-css-bgrepeat-x, #rm-css-bgrepeat-y').removeClass('active');var bgwidget=this.getWidget('BackgroundImageWidget',this._selected);if(bgwidget){bgwidget.activate();}}
if(this._multi_widget.isActive()){debug('MULTI STYLE WIDGET ACTIVE, SAVING STYLES...');this.save();}},this)).attr('src',url);}
break;case'bgposition':var current_pos=this._selected.css('backgroundPosition');current_pos=current_pos.split(' ');var bgwidget=this.getWidget('BackgroundImageWidget',this._selected);if(event.data.anchor){if(bgwidget&&bgwidget._active){if(!/multi/.test(bgwidget._name.toLowerCase())){bgwidget.deactivate();}}
var new_pos=[current_pos[0],current_pos[1]];if(current_pos[0].indexOf('px')>-1){new_pos[0]='50%';}
if(current_pos[1].indexOf('px')>-1){new_pos[1]='50%';}
$('#rm-css-bgposition-free').removeClass('active');switch(event.data.anchor){case'top':if(current_pos[1]!=='0%'){new_pos[1]='0%';$('#rm-css-bgposition-top').addClass('active');if(current_pos[1]==='100%')$('#rm-css-bgposition-bottom').removeClass('active');}else{new_pos[1]='50%';$('#rm-css-bgposition-top').removeClass('active');}
break;case'right':if(current_pos[0]!=='100%'){new_pos[0]='100%';$('#rm-css-bgposition-right').addClass('active');if(current_pos[0]==='0%')$('#rm-css-bgposition-left').removeClass('active');}else{new_pos[0]='50%';$('#rm-css-bgposition-right').removeClass('active');}
break;case'bottom':if(current_pos[1]!=='100%'){new_pos[1]='100%';$('#rm-css-bgposition-bottom').addClass('active');if(current_pos[1]==='0%')$('#rm-css-bgposition-top').removeClass('active');}else{new_pos[1]='50%';$('#rm-css-bgposition-bottom').removeClass('active');}
break;case'left':if(current_pos[0]!=='0%'){new_pos[0]='0%';$('#rm-css-bgposition-left').addClass('active');if(current_pos[0]==='100%')$('#rm-css-bgposition-right').removeClass('active');}else{new_pos[0]='50%';$('#rm-css-bgposition-left').removeClass('active');}
break;default:break;}
this._selected.css({backgroundPosition:new_pos[0]+' '+new_pos[1]});bgwidget.setPosition(new_pos[0],new_pos[1]);}else if(event.data.position){debug('got update from bg widget! '+event.data.position);}else{if(bgwidget&&!bgwidget._active){$('#rm-css-background-anchors').children('a').removeClass('active');$('#rm-css-bgposition-free').addClass('active');bgwidget.activate();}else if(bgwidget){if(!/multi/.test(bgwidget._name.toLowerCase())){bgwidget.deactivate();}}}
break;case'bgrepeat':var old_repeat=this._selected.css('backgroundRepeat');var new_repeat='no-repeat';switch(event.data.axis){case'x':switch(old_repeat){case'repeat-x':new_repeat='no-repeat';break;case'repeat-y':new_repeat='repeat';break;case'repeat':new_repeat='repeat-y';break;case'no-repeat':new_repeat='repeat-x';break;default:break;}
$('#rm-css-bgrepeat-x').toggleClass('active');break;case'y':switch(old_repeat){case'repeat-x':new_repeat='repeat';break;case'repeat-y':new_repeat='no-repeat';break;case'repeat':new_repeat='repeat-x';break;case'no-repeat':new_repeat='repeat-y';break;default:break;}
$('#rm-css-bgrepeat-y').toggleClass('active');break;}
this._selected.css({backgroundRepeat:new_repeat});break;case'bordercolor':if(event.color){this._selected.css({outlineColor:event.color});}else{this._selected.css({outlineColor:'transparent'});}
break;case'borderstyle':var selectedStyle=$(event.currentTarget).children(':selected').val();switch(selectedStyle){case'solid':case'dashed':case'dotted':this._selected.css({outlineStyle:selectedStyle,outlineWidth:'1px'});break;default:this._selected.css({outlineStyle:'none',outlineWidth:''});break;}
break;case'height':var activeElement;var newHeight;if(event.data.height){newHeight=event.data.height;if(event.data.element){activeElement=event.data.element;}else{activeElement=event.data.widget._selected;}
activeElement.height(newHeight).css({height:newHeight+'px'});}else{activeElement=$('#editor-main-banner');newHeight=activeElement.height();}
if(activeElement.attr('id')=='editor-main-banner'){debug(this._name+'::cssEvent(height): sending banner height to Page through Saver(bannerHeight:'+newHeight+')');Saver.save('banner-height',newHeight,{elem:activeElement});}else{debug(this._name+'::cssEvent(height): NOT sending banner height to Page through Saver(bannerHeight:'+newHeight+')');}
break;case'playertheme':if(event.color){this._selected.css({backgroundColor:event.color});}else{this._selected.css({backgroundColor:'transparent'});}
break;case'playerprimary':if(event.color){$('[rel="rm-css-playerprimary"], .rmplayer-primary-ui',this._selected).css({backgroundColor:event.color});this._selected.data('rmplayer-primary-ui',event.color).data('rmplayer-primary-modified',true);}
break;case'playersecondary':if(event.color){var _widget=this;$('[rel="rm-css-playersecondary"], .rmplayer-secondary-ui',this._selected).each(function(index){if($(this).hasClass('rmplayer-icon')){_widget._selected.data('rmplayer-icon-fill',$(this).find('polygon, rect').attr('fill'));$(this).find('polygon, rect').attr('fill',event.color);}else{$(this).css({backgroundColor:event.color});}});this._selected.data('rmplayer-secondary-ui',event.color).data('rmplayer-secondary-modified',true);}
break;case'playertext':if(event.color){this._selected.css({color:event.color}).data('rmplayer-text-ui',event.color);}
break;default:break;}
this._selected.data('modified',true);if($('#rm-css-control-cancel').is(':hidden')){$('#rm-css-control-cancel').fadeIn();}
this.refreshHighlightWindows();return false;},processUserEvent:function(event){if(event.data===undefined){event.data={};}
switch(event.type){case'mouseover':if(event.currentTarget!=this._panel.get(0)){var targetedElemRel=$(event.target).closest(".rm-css-edit").attr('rel')||'no-rel';var fromHighlightWindow=false;if($(event.target).hasClass('rm-css-highlight-window')){if($(event.target).data('delegate')){targetedElemRel=$(event.target).data('delegate').attr('rel')||'no-rel';fromHighlightWindow=true;}
else targetedElemRel='no-rel';}
var targetedElems=$('.rm-css-edit[rel="'+targetedElemRel+'"]').not(':hidden');if(targetedElems.length){if(this._highlighted&&targetedElems.index(this._highlighted.get(0))<0){$('.rm-css-highlight-window').unbind('click').data('delegate',false).hide().remove();if(!this._selected||this._selected.index(this._highlighted.get(0))<0){this._highlighted.css({zIndex:'',cursor:''}).unbind('click',this.processUserEvent);}}
if(!this._highlighted||targetedElems.index(this._highlighted.get(0))<0){if(!this._selected||targetedElems.index(this._selected.get(0))<0){var targetHighlight=false;targetedElems.css({zIndex:1200,cursor:'pointer'}).bind('click',$.proxy(this,'processUserEvent')).each(function(){if($(this).css('position')=='static'){$(this).data('static',true).css({position:'relative'});}
if($(this).parent().css('position')=='static'){$(this).parent().data('static',true).css({position:'relative'});}
var pos={top:$(this).position().top+parseInt($(this).css('margin-top'))-5,left:$(this).position().left+parseInt($(this).css('margin-left'))-5};var css={position:'absolute',border:'1px dotted #000000',outline:'1px dotted #ffffff',padding:'5px',cursor:'pointer',top:pos.top+'px',left:pos.left+'px',width:$(this).outerWidth()+'px',height:$(this).outerHeight()+'px',zIndex:parseInt($(this).css('zIndex'))-100};if($(this).css('text-align')=='right'){if($(this).css('right')!='auto'){css.right=parseInt($(this).css('right'))-5+'px';delete css.left;}}
targetHighlight=$('<div></div>').css(css).addClass('rm-css-highlight-window').data('delegate',$(this)).hide();targetHighlight.appendTo($(this).parent()).fadeIn();});if(fromHighlightWindow){$('.rm-css-highlight-window').bind('click',function(event){$(event.currentTarget).data('delegate').trigger(event);});}}
this._highlighted=targetedElems;}}else if(!targetedElems.length&&($(event.target).closest("#rm-appearance-panel").length<1)&&!$(event.target).hasClass('rm-css-highlight-window')){$('.rm-css-highlight-window').data('delegate',false).fadeOut(function(){$(this).remove();});if(this._highlighted&&(!this._selected||this._highlighted.index(this._selected.get(0))<0)){this._highlighted.css({zIndex:'',cursor:''}).unbind('click',this.processUserEvent);}
this._highlighted=false;}
event.stopPropagation();}
break;case'click':if(event.data.cancel&&this._active&&!$(event.target).hasClass('rm-css-highlight-window')){if((event.currentTarget==this._domTarget.get(0)||$(event.currentTarget).attr('id')=='rm-css-control-cancel'||$(event.currentTarget).attr('id')=='rm-css-control-save')&&($(event.target).closest('.colorpicker').length<1&&!$(event.target).hasClass('rm-css-highlight-window'))){if(this._selected){this._selected.removeClass('rm-css-selected');$('.rm-css-selected-window').data('delegate',false).fadeOut(function(){$(this).remove();});if(event.currentTarget.id=='rm-css-control-cancel'){this.cancel();}else{if(this._selected.data('modified')){this.save();}}
this.disableExtraWidgets();}
this.close();}
return false;}else if(!event.data.cancel){if(!this._selected||(this._highlighted&&this._selected.index(this._highlighted.get(0))<0)){$('.rm-css-selected-window').remove();$('.rm-css-highlight-window').css({borderStyle:'solid',outlineStyle:'solid',borderWidth:'2px',outlineWidth:'2px'}).removeClass('rm-css-highlight-window').addClass('rm-css-selected-window');if(this._selected){if(this.needsUpdate()){this.save();}}
this.retarget();if(!this.isActive()){this.activate();}
this.shiftLocation({x:event.pageX,y:event.pageY},true);}else{var bg_widget=this._selected.data('BackgroundImageWidget')
if(!bg_widget||!bg_widget.isActive()){this.shiftLocation({x:event.pageX,y:event.pageY},false);}}
event.stopPropagation();}
break;default:break;}},needsUpdate:function(){if(this._selected){return this._selected.data('modified');}
return false;}});var SoundCloudSongUploader=RMUIWidget.extend({_domSelector:false,_uploadifyForm:false,_uploadifySelector:false,_name:'SoundCloudSongUploader',_plid:false,_queues:false,_host:'',init:function(targetElement){this._domSelector=targetElement.selector;this._uploadifySelector=this._domSelector+'-uploadify';var formDOM='<div id="'+this._domSelector.substr(1)+'-form"><input id="'+this._uploadifySelector.substr(1)+'" type="file" name="sctracks[]" /></div>';this._uploadifyForm=$(formDOM);this._uploadifyForm.insertAfter(targetElement);this._uploadifyForm.css({width:'100%',height:'100%',position:'absolute',top:'0px',left:'0px',visibility:'hidden',zIndex:1});this._queues=new Array();this._host=Environment.getHost();this._super(targetElement);},install:function(targetElement){this._super(targetElement);this._uploadifyForm.bind('mouseenter',{widget:this},function(event){event.data.widget._domTarget.addClass('hover');}).bind('mouseleave',{widget:this},function(event){event.data.widget._domTarget.removeClass('hover');});},installUploadify:function(){debug('installing uploadify');var _songwidget=this;var scriptURL=this._host+'/soundcloud/uploadTrack';$(this._uploadifySelector).uploadify({uploader:'/flash/uploadify.swf',script:scriptURL,folder:'',cancelImg:'http://a.ak.static-rootmusic.com/images/soundcloud/cancel.png?v=2.70',buttonText:'Upload song',hideButton:true,width:156,height:47,fileDesc:'m4a, mp4, aac, aiff, flac, mp3, ogg, wav',fileExt:'*.m4a;*.mp4;*.aac;*,aiff;*.flac;*.mp3;*.ogg;*.wav',wmode:'transparent',scriptAccess:'always',multi:false,sizeLimit:(1024*1024*150),onSelect:function(event,queueID,fileObj){var n=fileObj.name.toLowerCase();n=n.substr(n.lastIndexOf("."));if(n.indexOf(".aac")==-1&&n.indexOf(".aiff")==-1&&n.indexOf(".flac")==-1&&n.indexOf(".m4a")==-1&&n.indexOf(".mp4")==-1&&n.indexOf(".mp3")==-1&&n.indexOf(".ogg")==-1&&n.indexOf(".wav")==-1){alert("We support .mp3, .aiff, .wav, .flac, .aac, and .ogg files. Please select a different file.");return false;}else{_songwidget.triggerEvent('uploadselect',{type:'uploadselect',queueID:queueID});_songwidget.upload(fileObj.name,false);_songwidget.storeQueueID(queueID);}
return true;},onOpen:function(event,queueID,fileObj){debug('OPEN!');_songwidget.triggerEvent('uploadstart',{type:'uploadstart',queueID:queueID,data:{filename:fileObj.name}});return true;},onProgress:function(event,queueID,fileObj,data){debug('PROGRESS!');_songwidget.triggerEvent('uploadprogress',{type:'uploadprogress',queueID:queueID,data:{percentage:data.percentage}});return false;},onComplete:function(event,queueID,fileObj,response,data){debug('COMPLETE!');_songwidget.triggerEvent('uploadcomplete',{type:'uploadcomplete',queueID:queueID,data:{response:response}});return true;},onCancel:function(event,queueID,fileObj,data){debug('CANCEL!');_songwidget.triggerEvent('uploadcancel',{type:'uploadcancel',queueID:queueID});return true;},onError:function(event,queueID,fileObj,errorObj){debug('ERROR!');if(errorObj.type=="File Size"){alert("The file upload limit for songs is 150Mb");}
_songwidget.triggerEvent('uploaderror',{type:'uploaderror',queueID:queueID,error:errorObj});return true;}});},upload:function(title,downloadable){var args={'title':escape(title),'downloadable':downloadable,'bandId':getGlobal('pageId'),'kid':getGlobal('kid'),'name':getGlobal('bandName')};$(this._uploadifySelector).uploadifySettings('scriptData',args);debug('starting uploadify upload with scriptData: ');debug(args);$(this._uploadifySelector).uploadifyUpload();},cancel:function(queueID){if(this.hasQueueID(queueID)){$(this._uploadifySelector).uploadifyCancel(queueID);}else{debug('Error: this uploadify instance doesn\'t have control of this queueID='+queueID);}},storeQueueID:function(queueID){if(!this.hasQueueID(queueID)){this._queues.push(queueID);}},hasQueueID:function(queueID){for(var i=0;i<this._queues.length;i++){if(this._queues[i]==queueID){return true;}}
return false;},enable:function(){this._uploadifyForm.css({height:'',overflow:''});},disable:function(){this._uploadifyForm.css({height:0,overflow:'hidden'});}});var SoundCloudArtworkUploader=RMUIWidget.extend({_domSelector:false,_name:'SoundCloudArtworkUploader',_scTrackId:false,_queues:false,_host:'',_loadIndicator:false,_progressBar:false,_uploadifyForm:false,_waiting:false,TRACK_SCRIPT_URL:'/soundcloud/uploadTrackArtwork',PLAYLIST_SCRIPT_URL:'/soundcloud/uploadArtwork',init:function(targetElement){this._domSelector=targetElement.selector;this._uploadifySelector=this._domSelector+'-uploadify';var formDOM='<div id="'+this._domSelector.substr(1)+'-form"><input id="'+this._uploadifySelector.substr(1)+'" type="file" name="scartwork" /><em class="artwork-help-overlay rc-m">Upload new image?</em></div>';this._uploadifyForm=$(formDOM);this._uploadifyForm.appendTo(targetElement);this._uploadifyForm.css({width:'100%',height:'100%',top:'0px',left:'0px',position:'absolute',zIndex:1});this._waitMessage=$('<em class="artwork-help-overlay rc-m loading">Please wait</em>');this._waitMessage.appendTo(this._uploadifyForm).css({zIndex:1}).hide();this._waiting=false;this._queues=new Array();this._host=Environment.getHost();this._super(targetElement);},install:function(targetElement){this._super(targetElement);$(this._domTarget).addClass('sc-artwork-upload');$('.artwork-help-overlay',this._uploadifyForm).hide();this._domTarget.bind('mouseenter mouseleave',{widget:this},this.processUserEvent);},installUploadify:function(){var scriptURL=this._host+this.PLAYLIST_SCRIPT_URL;debug(this._name+'::installUploadify(): script destination = '+scriptURL);var _artwidget=this;$(this._uploadifySelector).uploadify({uploader:'/flash/uploadify.swf',script:scriptURL,folder:'/var/www/cache/soundcloud',cancelImg:'http://a.ak.static-rootmusic.com/images/soundcloud/cancel.png?v=2.70',buttonText:'Change',hideButton:true,fileDesc:'jpg, jpeg, png, gif',fileExt:'*.jpg;*.jpeg;*.gif;*.png',wmode:'transparent',scriptAccess:'always',sizeLimit:(1024*1024*4),height:100,width:100,multi:false,onSelect:function(event,queueID,fileObj){debug(fileObj);_artwidget.upload();_artwidget.storeQueueID(queueID);return false;},onOpen:function(event,queueID,fileObj){_artwidget.triggerEvent('uploadstart',{type:'uploadstart',queueID:queueID});return true;},onProgress:function(event,queueID,fileObj,data){debug(data.percentage);_artwidget.triggerEvent('uploadprogress',{type:'uploadprogress',queueID:queueID,data:{percentage:data.percentage}});return false;},onComplete:function(event,queueID,fileObj,response,data){if(response){debug(response);var json=eval('('+response+')');_artwidget.triggerEvent('uploadcomplete',{type:'uploadcomplete',queueID:queueID,data:{response:json}});}else{debug('Error detected with artwork upload. Check logs for more info.');}
return true;},onCancel:function(event,queueID,fileObj,data){_artwidget.triggerEvent('uploadcancel',{type:'uploadcancel',queueID:queueID});return true;},onError:function(event,queueID,fileObj,errObj){if(errorObj.type=="File Size"){alert("The file upload limit for album artwork is 4Mb");}
_artwidget.triggerEvent('uploaderror',{type:'uploaderror',queueID:queueID,error:errObj});return true;}});},setTargetTrack:function(trackObj){if(trackObj.id){this._rmTrackId=trackObj.id;}
if(trackObj.sourceId){this._scTrackId=trackObj.sourceId;}
if(trackObj.artworkUrl){this._artworkUrl=trackObj.artworkUrl;}},setWaiting:function(isWaiting){this._waiting=isWaiting;},processUserEvent:function(event){if(!event.data.widget._waiting){switch(event.type){case'mouseenter':$('.artwork-help-overlay:not(.loading)',event.data.widget._domTarget).fadeIn('fast');break;case'mouseleave':$('.artwork-help-overlay',event.data.widget._domTarget).hide();break;default:break;}}
return false;},upload:function(){var scriptUrl='';if(this._scTrackId&&parseInt(this._scTrackId)>0){scriptUrl=this._host+this.TRACK_SCRIPT_URL;}else{scriptUrl=this._host+this.PLAYLIST_SCRIPT_URL;}
$(this._uploadifySelector).uploadifySettings('script',scriptUrl);var args={'bandid':getGlobal('pageId'),'rmtrackid':this._rmTrackId,'kid':getGlobal('kid'),'sctrackid':this._scTrackId};debug(this._name+'::upload(): starting upload with new script args =');debug(args);$(this._uploadifySelector).uploadifySettings('scriptData',args);$(this._uploadifySelector).uploadifyUpload();},cancel:function(queueID){if(this.hasQueueID(queueID)){$(this._uploadifySelector).uploadifyCancel(queueID);}else{debug('Error: this uploadify instance doesn\'t have control of this queueID='+queueID);}},storeQueueID:function(queueID){if(!this.hasQueueID(queueID)){this._queues.push(queueID);}},hasQueueID:function(queueID){for(var i=0;i<this._queues.length;i++){if(this._queues[i]==queueID){return true;}}
return false;},enable:function(){this._uploadifyForm.css({height:'',overflow:''});},disable:function(){this._uploadifyForm.css({height:0,overflow:'hidden'});}});var SC=function(){return{Connect:{wrapped_callback:null,popup_window:null,prepareButton:function(link,options){SC.Connect.wrapped_callback=options.callback;$(link).click(function(evt){evt.stopPropagation();debug('opening pop-up...');SC.Connect.popup_window=window.open(options.request_token_endpoint,'sc_connect_popup','location=1,width=456,height=500,toolbar=no,scrollbars=yes');return false;});},callback:function(query_obj){SC.Connect.popup_window.close();SC.Connect.wrapped_callback(query_obj);}},QueryToObject:function(query){var obj={};var splitted_url=document.URL.split("?");var query=splitted_url[1]?splitted_url[1]:"";var vars=query.split("&");for(var i=0;i<vars.length;i++){var pair=vars[i].split("=");obj[pair[0]]=decodeURIComponent(pair[1]);}
return(obj);}};}();var TrackManagerWidget=RMUIWidget.extend({_shade:false,_trackEditor:false,_trackSelector:false,_scConnect:false,_ytConnect:false,_songUploader:false,_directSongUploader:false,_trackArtworkUploader:false,_playlistArtworkUploader:false,_ytInputter:false,_tracks:false,_selectedTrack:false,_artworkPollers:false,_songPollers:false,_needSCUpdate:false,_uploading:false,_postData:false,_scrollStartPos:false,STATE_SC_TRACKS:1,STATE_SC_CONNECT:2,STATE_YT_TRACKS:3,STATE_TRACK_INFO:4,_state:false,_lastState:false,MESSAGE_ERROR:'error',MESSAGE_INFO:'info',MESSAGE_WARNING:'warning',_errDisplay:false,DEFAULT_ALBUM_ARTWORK:'http://b.ak.static-rootmusic.com/images/soundcloud/rm_default_artwork_sm.png?v=2.70',SERVICE_TYPE_SOUNDCLOUD:1,SERVICE_TYPE_YOUTUBE:2,init:function(targetElement,options){if(options){this._scConnect=(options.scConnect)?options.scConnect:false;this._ytConnect=(options.ytConnect)?options.ytConnect:false;}
debug(this._scConnect+' = using soundcloud connect for track manager');this._songUploader=new SoundCloudSongUploader($('#sc-track-upload-button'));this._songUploader.installUploadify();this._songUploader.addCallback('uploadcomplete',this,this.songUploadHandler);this._songUploader.addCallback('uploadstart',this,this.songUploadHandler);this._songUploader.addCallback('uploadprogress',this,this.songUploadHandler);this._songUploader.addCallback('uploadcancel',this,this.songUploadHandler);this._songUploader.addCallback('uploaderror',this,this.songUploadHandler);this._trackArtworkUploader=new SoundCloudArtworkUploader($('#sc-track-artwork-upload'));this._trackArtworkUploader.installUploadify();this._trackArtworkUploader.addCallback('uploadcomplete',this,this.artworkUploadHandler);this._trackArtworkUploader.addCallback('uploadstart',this,this.artworkUploadHandler);this._trackArtworkUploader.addCallback('uploadprogress',this,this.artworkUploadHandler);this._trackArtworkUploader.addCallback('uploadcancel',this,this.artworkUploadHandler);this._trackArtworkUploader.addCallback('uploaderror',this,this.artworkUploadHandler);this._directSongUploader=new SoundCloudSongUploader($('#add-file-track-button'));this._directSongUploader.installUploadify();this._directSongUploader.addCallback('uploadcomplete',this,this.songUploadHandler);this._directSongUploader.addCallback('uploadstart',this,this.songUploadHandler);this._directSongUploader.addCallback('uploadprogress',this,this.songUploadHandler);this._directSongUploader.addCallback('uploadcancel',this,this.songUploadHandler);this._directSongUploader.addCallback('uploaderror',this,this.songUploadHandler);this._directSongUploader.addCallback('uploadselect',this,this.songUploadHandler);if(!this._scConnect){debug('disabling song uploads from my computer button');this._directSongUploader.disable();}
this._tracks=new Array();this._artworkPollers=new Array();this._trackPollers=new Array();this._uploading=false;this._postData={bandId:getGlobal('pageId'),rmPageId:getGlobal('fanPageId')};this._super(targetElement,options);},install:function(targetElement){this._super(targetElement);$('#editor-pane-container').append(this._domTarget);this._trackSelector=$('#rm-track-selector');this._trackEditor=$('#rm-track-editor');if($('#rm-track-manager-shade').length<1){debug('creating track manager shade...');var domStr='<div id="rm-track-manager-shade" class="editor-modal-layer"></div>';this._shade=$(domStr);this._shade.appendTo($('#editor-pane-container')).hide();}
this._errDisplay=$('.error-display',this._domTarget);$('#add-track-button').bind('click',{widget:this},function(event){$(event.currentTarget).safeHide().siblings().safeShow();event.stopPropagation();return false;});$('#rmplayer-upload-subactions').bind('click',function(event){event.stopPropagation();return false;});$('body, #rmplayer-upload-subactions .close-button').bind('click',{widget:this},function(event){if($(event.target).closest(event.data.widget._domTarget.selector).length==0&&$('#rmplayer-upload-subactions').is(':visible')){$('#rmplayer-upload-subactions').safeHide().siblings().safeShow();}});$('#add-file-track-button, #add-sc-track-button, #add-yt-track-button, #close-track-selector-button, #save-to-bandpage-button, #cancel-track-changes-button, #back-to-selector-button, #cancel-song-upload-button').bind('click',{widget:this},this.buttonHandler);$('li[id|=rm-track] > a:not(.disabled)',this._domTarget).live('click',{widget:this},function(event){var idTokens=$(event.currentTarget).attr('id').split('-');var sourceId=idTokens[idTokens.length-1];event.data.widget.openTrackInfo(event.data.widget.getTrack(sourceId));return false;});$('li[id|=bandpage-track]',$('#rmplayer-playlist')).live('click',{widget:this},function(event){var idTokens=$(event.currentTarget).attr('id').split('-');var trackId=idTokens[idTokens.length-1];debug('opening track info for track id='+trackId);debug(event.data.widget.getTrackByRMId(trackId));event.data.widget.openTrackInfo(event.data.widget.getTrackByRMId(trackId));return false;});$('.rm-remove-link','#rmplayer-playlist').live('click',{widget:this},this.buttonHandler);var _trackManager=this;if(!this._scConnect){var scConnectOptions={request_token_endpoint:'/soundcloud/oauth_request_token',access_token_endpoint:'/soundcloud/oauth_access_token',callback:function(query_obj){_trackManager._scConnect=true;_trackManager._directSongUploader.enable();_trackManager.openSoundCloudManager();}};debug('setting up button...');SC.Connect.prepareButton($('#sc-connect-init')[0],scConnectOptions);}
var titleEditor=new TextInlineEditWidget($('#rm-track-title'),{autoSave:false});titleEditor.addCallback('update',this,function(){if(this._selectedTrack){this._selectedTrack.title=titleEditor.getValue();}});var purchaseUrlEditor=new TextInlineEditWidget($('#rm-track-purchase-url'),{autoSave:false});purchaseUrlEditor.addCallback('update',this,function(){if(this._selectedTrack){this._selectedTrack.purchaseUrl=purchaseUrlEditor.getValue();}});$('#rm-track-downloadable-checkbox').bind('click',{widget:this},function(event){$('#rm-track-downloadable-indicator').click();return true;});$('#rm-track-downloadable-indicator').bind('click',{widget:this},function(event){var selectedTrack=event.data.widget.getSelectedTrack();selectedTrack.downloadable=!selectedTrack.downloadable;event.data.widget.setSelectedTrack(selectedTrack);event.data.widget.updateTrackEditorUI();return false;});$('#rm-track-purchasable-checkbox').bind('click',{widget:this},function(event){$('#rm-track-purchasable-indicator').click();return true;});$('#rm-track-purchasable-indicator').bind('click mouseenter',{widget:this},function(event){var inputField=$(event.currentTarget).siblings('.rm-buy-link-input');var selectedTrack=event.data.widget.getSelectedTrack();debug(event.type);switch(event.type){case'click':selectedTrack.purchasable=!selectedTrack.purchasable;event.data.widget.setSelectedTrack(selectedTrack);event.data.widget.updateTrackEditorUI();if(selectedTrack.purchasable){$('body').bind('click',{widget:_trackManager,elem:inputField},_trackManager.handleBuyLinkEvent);inputField.css({display:'block',opacity:0,bottom:function(indx,val){return(parseInt(val)-10);}}).animate({opacity:1,bottom:'+=10px'},250,function(){$(this).css({bottom:''});});}else{inputField.hide();$('body').unbind('click',_trackManager.handleBuyLinkEvent);}
break;case'mouseenter':if(selectedTrack.purchasable){if(inputField.is(':hidden')){$('body').bind('click',{widget:_trackManager,elem:inputField},_trackManager.handleBuyLinkEvent);inputField.css({display:'block',opacity:0,bottom:function(indx,val){return(parseInt(val)-10);}}).animate({opacity:1,bottom:'+=10px'},250,function(){$(this).css({bottom:''});});}}
break;default:break;}
return false;});$('.safe-hidden').removeClass('safe-hidden').safeHide();this.loadBandPagePlaylist();if((this._domTarget.height()+100)<$(window).height()){$(window).bind('scroll',{widget:this},this.handleScroll);this._scrollStartPos=this._domTarget.offset().top;}},activate:function(){this._super();debug('attaching cancel handler...');$('body').bind('click',{widget:this},this.cancelHandler);},deactivate:function(){this._super();this.clearMessages();var _trackManager=this;if(this._trackSelector.css('visibility')!='hidden'){debug('closing track SELECTOR...');this._trackSelector.safeSlideUp(function(){_trackManager._shade.fadeOut('fast');});}else if(this._trackEditor.css('visibility')!='hidden'){debug('closing track EDITOR....');this._trackEditor.safeFadeOut(function(){_trackManager._shade.fadeOut('fast');$('#track-upload-notification').hide();});}else{debug('just closing shade.');this._shade.fadeOut();}
this._lastState=false;debug('removing cancel handler...');$('body').unbind('click',this.cancelHandler);if($('#rmplayer-upload-subactions').is(':visible')){$('#rmplayer-upload-subactions').safeHide().siblings().safeShow();}},changeMode:function(mode){this._super(mode);switch(mode){case'css':this.disable();break;case'content':this.enable();break;default:break;}},enable:function(){this._super();$('#rmplayer-actions').safeShow();$('#rmplayer-playlist').sortable('enable');$('.rm-remove-link','#rmplayer-playlist').show();},disable:function(){this._super();$('#rmplayer-actions').safeHide();$('#rmplayer-playlist').sortable('disable');$('.rm-remove-link','#rmplayer-playlist').hide();},saveTrackToPlaylist:function(trackObj){debug('updating track on bandpage playlist...');var trackDOM=$('#bandpage-track-'+trackObj.id);trackDOM.css({opacity:0.6});$('.rm-remove-link',trackDOM).hide();$('.track-buttons',trackDOM).addClass('loading');var _trackManager=this;var saveData={trackId:trackObj.id,title:trackObj.title,description:trackObj.description||'',artworkUrl:trackObj.artworkUrl,purchaseUrl:trackObj.purchaseUrl,downloadable:trackObj.downloadable,purchasable:trackObj.purchasable};Saver.save('track-update',saveData,{success:function(){_trackManager.storeTrack(trackObj);var addedTrackDOM=_trackManager.generateTrackDOM(trackObj);var originalTrackDOM=$('#bandpage-track-'+trackObj.id);addedTrackDOM.insertBefore(originalTrackDOM).hide();originalTrackDOM.remove();if(originalTrackDOM.hasClass('odd')){addedTrackDOM.addClass('odd');}
addedTrackDOM.fadeIn(function(){if(addedTrackDOM.index()==0){_trackManager.refreshFirstTrackDisplay(trackObj);}});trackDOM.css({opacity:1});$('.rm-remove-link',trackDOM).show();$('.track-buttons',trackDOM).removeClass('loading');},error:function(){trackDOM.css({opacity:1});$('.rm-remove-link',trackDOM).show();$('.track-buttons',trackDOM).removeClass('loading');}});},saveCurrentToPlaylist:function(){var selectedTrack=this.getSelectedTrack();debug('saving current track: ');debug(selectedTrack);if(selectedTrack&&selectedTrack.onBandPage){this.saveTrackToPlaylist(selectedTrack);}else if(selectedTrack){var _trackManager=this;var saveData={sourceType:selectedTrack.serviceType,sourceId:selectedTrack.sourceId,title:selectedTrack.title,description:selectedTrack.description||'',duration:selectedTrack.duration,genre:selectedTrack.genre,artworkUrl:selectedTrack.artworkUrl,downloadable:selectedTrack.downloadable,purchasable:selectedTrack.purchasable,downloadUrl:selectedTrack.downloadUrl,streamUrl:selectedTrack.streamUrl,purchaseUrl:selectedTrack.purchaseUrl};Saver.save('track-add',saveData,{callFirst:true,success:function(data){if(!data.hasOwnProperty('tracks')){Saver.triggerErrorCallbacks();return;}
var success=false;for(var i=0,track;track=data.tracks[i++];){debug('comparing response of '+track.sourceId+' to '+selectedTrack.sourceId);if(track.sourceId==selectedTrack.sourceId){selectedTrack.id=parseInt(track.id);selectedTrack.onBandPage=true;_trackManager.storeTrack(selectedTrack);var addedTrackDOM=_trackManager.generateTrackDOM(selectedTrack);$('#rmplayer-playlist').append(addedTrackDOM);$('.empty-message','#rmplayer-playlist').remove();_trackManager.updatePlaylistUI(true);success=true;break;}}
if(success){Saver.triggerSuccessCallbacks();}else{Saver.triggerErrorCallbacks();}}});}},removeTrackFromPlaylist:function(trackId){debug('removing track with id='+trackId);var track=this.getTrackByRMId(trackId);var trackDOM=$('#bandpage-track-'+trackId);var _trackManager=this;$('.rm-remove-link',trackDOM).hide();$('.track-buttons',trackDOM).addClass('loading');Saver.save('track-remove',trackId,{success:function(data){trackDOM.fadeOut('fast',function(){$(this).remove();_trackManager.updatePlaylistUI(true);});track.onBandPage=false;_trackManager.storeTrack(track);},error:function(){$('.rm-remove-link',trackDOM).show();$('.track-buttons',trackDOM).removeClass('loading');}});},storeTrack:function(trackObj){debug('storing track = '+trackObj.sourceId);this._tracks.upsert(trackObj,'sourceId');},getTrack:function(sourceId){for(var i=0,track;track=this._tracks[i++];){if(track.sourceId==sourceId){return $.extend({},track);}}
return false;},getTrackByRMId:function(id){for(var i=0,track;track=this._tracks[i++];){if(track.id){if(parseInt(track.id)==parseInt(id)){return $.extend({},track);}}}
return false;},setSelectedTrack:function(trackObj){this._selectedTrack=trackObj;},getSelectedTrack:function(){return this._selectedTrack;},updateTrackEditorUI:function(){var selectedTrack=this.getSelectedTrack();switch(selectedTrack.serviceType){case this.SERVICE_TYPE_YOUTUBE:this._trackArtworkUploader.disable();this._trackArtworkUploader.setWaiting(false);$('#rm-track-title').addClass('yt');$('#rm-track-downloadable-toggle').hide();break;case this.SERVICE_TYPE_SOUNDCLOUD:default:if(selectedTrack.uploadQueueID){this._trackArtworkUploader.disable();this._trackArtworkUploader.setWaiting(true);}else{this._trackArtworkUploader.enable();this._trackArtworkUploader.setWaiting(false);}
$('#rm-track-title').removeClass('yt');$('#rm-track-downloadable-toggle').show();break;}
this._trackArtworkUploader.setTargetTrack(selectedTrack);if(this.isPollingArtwork(selectedTrack.sourceId)){$('img',this._trackArtworkUploader._domTarget).fadeOut();$(this._trackArtworkUploader._domTarget).addClass('loading-artwork');}else{$(this._trackArtworkUploader._domTarget).removeClass('loading-artwork');$('img',this._trackArtworkUploader._domTarget).fadeIn();if(selectedTrack.artworkUrl&&selectedTrack.artworkUrl!=''){$('img','#sc-track-artwork-upload').attr('src',selectedTrack.artworkUrl);}else{$('img','#sc-track-artwork-upload').attr('src',this.DEFAULT_ALBUM_ARTWORK);$('.artwork-help-overlay:not(.loading)',this._trackArtworkUploader._domTarget).fadeIn();}}
this.getWidget('TextInlineEditWidget',$('#rm-track-title')).setValue(selectedTrack.title);if(selectedTrack.downloadable){$('input[type=checkbox]','#rm-track-downloadable-toggle').attr('checked','checked');$('.rm-ui-button','#rm-track-downloadable-toggle').addClass('active');$('#rm-track-downloadable-toggle').data('active',true);}else{$('input[type=checkbox]','#rm-track-downloadable-toggle').removeAttr('checked');$('.rm-ui-button','#rm-track-downloadable-toggle').removeClass('active');$('#rm-track-downloadable-toggle').data('active',false);}
if(selectedTrack.purchasable){$('input[type=checkbox]','#rm-track-purchasable-toggle').attr('checked','checked');$('.rm-ui-button','#rm-track-purchasable-toggle').addClass('active');$('#rm-track-purchasable-toggle').data('active',true);}else{$('input[type=checkbox]','#rm-track-purchasable-toggle').removeAttr('checked');$('.rm-ui-button','#rm-track-purchasable-toggle').removeClass('active');$('#rm-track-purchasable-toggle').data('active',false);}
var purchaseUrlInputter=this.getWidget('TextInlineEditWidget',$('#rm-track-purchase-url'));if(purchaseUrlInputter){if(this._selectedTrack.purchaseUrl){purchaseUrlInputter.setValue(this._selectedTrack.purchaseUrl);}
else{purchaseUrlInputter.clear();}}
if(selectedTrack.fanOnly){$('#rm-track-fan-only').attr('checked','checked');}else{$('#rm-track-fan-only').removeAttr('checked');}
if(selectedTrack.uploadQueueID){if($('#track-upload-notification').is(':hidden')){$('#track-editor-actions').fadeOut(function(){$('#track-upload-notification').fadeIn('fast');$('.progress','#track-upload-notification').removeClass('cancelled').css({width:0});$('.progress-notification','#track-upload-notification').text('Uploading...');});}
$('.progress-notification','#track-upload-notification').removeClass('loading');}else if($('#track-upload-notification').is(':visible')){$('#track-upload-notification').hide();$('#track-editor-actions').show();}},updatePlaylistUI:function(resetSortable){if(resetSortable!==true){resetSortable=false;}
debug('updating playlist ui...');var playlistTracks=$('#rmplayer-playlist').children('li');if(playlistTracks.length>0){playlistTracks.removeClass('odd').filter(':odd').addClass('odd');var firstTrackIdTokens=playlistTracks.filter(':first').attr('id').split('-');var firstTrackId=firstTrackIdTokens[firstTrackIdTokens.length-1];debug('first track id = '+firstTrackId+', stored value = '+$('#rmplayer-playlist').data('first_track_id'));if($('#rmplayer-playlist').data('first_track_id')!=firstTrackId){debug(this.getTrackByRMId(firstTrackId));this.refreshFirstTrackDisplay(this.getTrackByRMId(firstTrackId));}
if(resetSortable){var _trackManager=this;$('#rmplayer-playlist').sortable({cursor:"move",items:"li:not(.empty-message)",containment:'parent',revert:100,scroll:false,update:function(event,ui){var order=[];var idTokens=[];$('#rmplayer-playlist').children('li').each(function(){debug($(this).attr('id'));idTokens=$(this).attr('id').split('-');order[order.length]=idTokens[idTokens.length-1];});debug(order);Saver.save('playlist-update-order',order,{success:function(){if(firstTrackId!=order[0]){_trackManager.refreshFirstTrackDisplay(_trackManager.getTrackByRMId(order[0]));}else{debug('first track remained the same... order[0] = '+order[0]+', firsttrack='+firstTrackId);}
_trackManager.updatePlaylistUI();}});},change:function(event,ui){playlistTracks.filter(':not(.sorting)').removeClass('odd').filter(':even').addClass('odd');},stop:function(event,ui){ui.item.removeClass('sorting');playlistTracks.filter(':not(.sorting)').removeClass('odd').filter(':even').addClass('odd');$('#rmplayer-playlist').css({overflow:''}).animate({height:$('#rmplayer-playlist').data('height')+'px'},250,function(){$(this).css({height:''});});},start:function(event,ui){ui.item.addClass('sorting');var needed_height=0;$('#rmplayer-playlist').children('li').each(function(){needed_height+=$(this).outerHeight();});needed_height-=8;$('#rmplayer-playlist').data('height',$('#rmplayer-playlist').height()).css({overflow:'visible'}).animate({height:needed_height+'px'},250);}});}}else{this.refreshFirstTrackDisplay(false);}},refreshFirstTrackDisplay:function(trackObj){if(trackObj){if(this.isPollingArtwork(trackObj.sourceId)){$('img','#rmplayer-artwork').hide();$('.artwork-container','#rmplayer-artwork').addClass('loading-artwork');}else{var imgLoader=new Image();$('.artwork-container','#rmplayer-artwork').addClass('loading-artwork');$(imgLoader).load(function(event){$('img','#rmplayer-artwork').attr('src',$(event.currentTarget).attr('src')).fadeIn('fast');$('.artwork-container','#rmplayer-artwork').removeClass('loading-artwork');});imgLoader.src=(trackObj.artworkUrl!='')?trackObj.artworkUrl:this.DEFAULT_ALBUM_ARTWORK;}
$('#track-title').hide().text(trackObj.title);$('#track-title').fadeIn();var seconds=Math.round(trackObj.duration/1000);var minutes=Math.floor(seconds/60);seconds-=(minutes*60);var timecode='';if(minutes<10){timecode+='0';}
timecode+=minutes+':';if(seconds<10){timecode+='0';}
timecode+=seconds;$('#timecodes').text('00:00 / '+timecode).hide().fadeIn();$('#rmplayer-playlist').data('first_track_id',trackObj.id);}else{$('img','#rmplayer-artwork').hide().attr('src',this.DEFAULT_ALBUM_ARTWORK).fadeIn();$('#track-title').hide().text('No tracks (yet.)');$('#track-title').fadeIn();$('#timecodes').hide();$('#rmplayer-playlist').removeData('first_track_id');}},generateTrackDOM:function(trackObj){var trackNode=$('<li></li>');trackNode.addClass('bandpage-track').attr('id','bandpage-track-'+trackObj.id);var trackActions=$('<div class="track-buttons"></div>');if(trackObj.purchasable&&trackObj.purchasable===true){trackActions.append('<a class="buy-track-button rmplayer-primary-ui rc-xs" title="Buy track button" rel="rm-css-playerprimary">Buy</a>');}
if(trackObj.downloadable&&trackObj.downloadable===true){trackActions.append('<a class="get-track-button rmplayer-primary-ui rc-xs" title="Download track button" rel="rm-css-playerprimary">Download</a>');}
trackActions.append('<a class="rmplayer-primary-ui rc-xs disabled" title="Share track button" rel="rm-css-playerprimary">Share</a>');trackActions.append('<a class="rm-remove-link" id="remove-track-'+trackObj.id+'" title="Remove this track?" href="#remove-track">Remove</a>');trackNode.append(trackActions);trackNode.append('<h4 class="rm-inline-edit" name="rm-track-title">'+trackObj.title+'</h4>');return trackNode;},switchState:function(state){switch(state){case this.STATE_SC_TRACKS:this._domTarget.find('.rm-track-selector-view').safeHide();$('#soundcloud-track-selector').children('.track-selector-state').hide().filter('#soundcloud-default-state').show();$('#soundcloud-track-selector').safeFadeIn();this.loadSoundCloudTracks();this.loadSoundCloudPlaylists();this.updateAvailableTrackList();this.openTrackSelector();break;case this.STATE_SC_CONNECT:this._domTarget.find('.rm-track-selector-view').safeHide();$('#soundcloud-track-selector').children('.track-selector-state').hide().filter('#soundcloud-connect-state').show();$('#soundcloud-track-selector').safeFadeIn();this.openTrackSelector();break;case this.STATE_YT_TRACKS:this._domTarget.find('.rm-track-selector-view').safeHide();$('#youtube-track-selector').safeFadeIn();this.openTrackSelector();break;case this.STATE_TRACK_INFO:this.openTrackEditor();break;default:break;}
if(this._state!=state){this._lastState=this._state;this._state=state;}},previousState:function(){if(this._lastState){this.switchState(this._lastState);}},openTrackSelector:function(){var _trackManager=this;if(this._trackEditor.css('visibility')!='hidden'){this._trackEditor.safeFadeOut(function(){_trackManager._trackSelector.safeSlideDown();});}else if(this._trackSelector.css('visibility')=='hidden'){this._trackSelector.safeSlideDown();}else{}
if(this._shade.is(':hidden')){this._shade.fadeIn('fast');}
if(!this._active){this.activate();}
this.setSelectedTrack(false);},openTrackEditor:function(){var _trackManager=this;if(this._trackSelector.css('visibility')!='hidden'){$('#back-to-selector-button').show();this._trackSelector.safeFadeOut(function(){_trackManager._trackEditor.safeFadeIn();});}else if(this._trackEditor.css('visibility')=='hidden'){$('#back-to-selector-button').hide();this._trackEditor.safeFadeIn();}else{}
if(this._shade.is(':hidden')){this._shade.fadeIn('fast');}
if(!this._active){this.activate();}},lockTrackEditor:function(){debug('removing cancel handler...');$('body').unbind('click',this.cancelHandler);},unlockTrackEditor:function(){debug('adding cancel handler...');$('body').bind('click',{widget:this},this.cancelHandler);},openYouTubeManager:function(){this.switchState(this.STATE_YT_TRACKS);if(this._ytInputter){this._ytInputter.clear();}else{this._ytInputter=new TextInlineEditWidget($('.rm-inline-edit','#yt-track-input'),{autoSave:false});this._ytInputter.addCallback('update',this,this.youTubeInputHandler);this._ytInputter._inputField.bind('keyup',function(event){var instructions=$('#yt-track-input').find('.instr');if($(event.currentTarget).val()!=''&&event.keyCode!=13){if(instructions.is(':hidden')){instructions.fadeIn();}}else if(instructions.is(':visible')){instructions.hide();}});}
if(this._ytConnect){$('#yt-default-state').siblings('.track-selector-state').hide().show();}else{$('#yt-connect-state').show();}},openSoundCloudManager:function(){if(this._scConnect){this.switchState(this.STATE_SC_TRACKS);}else{this.switchState(this.STATE_SC_CONNECT);}},openTrackInfo:function(track){this.switchState(this.STATE_TRACK_INFO);if(track){this.setSelectedTrack(track);}
this.updateTrackEditorUI();},loadBandPagePlaylist:function(){var _trackManager=this;$('#rmplayer-playlist').empty();var loadingNode=$('<li class="loading">Loading '+getGlobal('brand')+' tracks...</li>');loadingNode.appendTo($('#rmplayer-playlist'));$.ajax({url:'/getajax/getPlaylist',type:'post',dataType:'json',data:{bandId:_trackManager._postData.bandId},success:function(data,response){if(data){debug(data);$('.loading','#rmplayer-playlist').remove();if(data.tracks&&data.tracks.length){$('#rmplayer-playlist').hide();var track;for(var i=0;i<data.tracks.length;i++){track={id:parseInt(data.tracks[i].id),serviceType:parseInt(data.tracks[i].source),sourceId:data.tracks[i].sourceId,title:data.tracks[i].title,description:data.tracks[i].description,duration:data.tracks[i].duration,downloadable:data.tracks[i].downloadable,purchasable:data.tracks[i].purchaseable,artworkUrl:data.tracks[i].artworkUrl,purchaseUrl:data.tracks[i].purchaseUrl,streamUrl:data.tracks[i].streamUrl,onBandPage:true};_trackManager.storeTrack(track);$('#rmplayer-playlist').append(_trackManager.generateTrackDOM(track));}
$('#rmplayer-playlist').fadeIn();debug(_trackManager._tracks);_trackManager.updatePlaylistUI(true);}else{var emptyNode=$('<li class="empty-message"><p>It looks like you haven&rsquo;t added any tracks to your playlist yet.<br /><a href="http://www.rootmusic.com/help" title="'+getGlobal('vendor')+' Help & Feedback" target="_blank">Do you need some help?</a></p></li>');emptyNode.appendTo($('#rmplayer-playlist'));$('#track-title').text('No tracks (yet).');}}else{}}});},loadSoundCloudPlaylists:function(){var playlistSelector=$('#sc-existing-playlists');if(playlistSelector.length<1){var loadingDOM='<span class="loading">Loading...</span>';$('#sc-playlist-filter').append($(loadingDOM));var _trackManager=this;$.ajax({url:'/soundcloud/getPlaylists',type:'post',dataType:'json',data:{rmPageId:_trackManager._postData.rmPageId,bandId:_trackManager._postData.bandId},success:function(data,response){var selectorDOM='<select id="sc-existing-playlists" name="scplaylist"><option name="All Tracks" value="">All Tracks</option></select>';playlistSelector=$(selectorDOM);playlistSelector.appendTo($('#sc-playlist-filter'));playlistSelector.siblings('.loading').remove();if(data&&data.length){var playlist=false;for(var i=0;i<data.length;i++){playlist=data[i];playlistSelector.append('<option value="'+playlist.scId+'" name="'+escape(playlist.title)+'">'+playlist.title+'</option>');}}else{debug('something went wrong... or you have no playlists. data=');debug(data);}
playlistSelector.bind('change',{widget:_trackManager},_trackManager.playlistFilterHandler);}});}},loadSoundCloudTracks:function(){debug('loading track list...');var trackList=$('.rm-track-selector-tracks','#soundcloud-default-state');if(this._needSCUpdate||trackList.children('li').length<1){trackList.append('<li><span class="loading">Loading SoundCloud tracks...</span></li>').animate({opacity:0.5},250);var _trackManager=this;$.ajax({url:'/soundcloud/getTracks',type:'post',dataType:'json',data:{rmPageId:_trackManager._postData.rmPageId,bandId:_trackManager._postData.bandId},success:function(data,response){debug('load soundcloud tracks success');$('.rm-track-selector-tracks','#soundcloud-default-state').empty();if(data){if(data.length>0){if($('#sc-track-chooser').is(':hidden')){$('.no-sc-tracks','#soundcloud-default-state').remove();$('#sc-track-chooser').fadeIn();}
var track=false;var trackDOM=false;for(var i=0;i<data.length;i++){track=_trackManager.getTrack(data[i].scId);var rmId=false;if(track){rmId=track.id;}
track={id:rmId,serviceType:_trackManager.SERVICE_TYPE_SOUNDCLOUD,sourceId:data[i].scId,title:data[i].title,description:data[i].description,duration:data[i].duration,downloadable:data[i].downloadable,purchasable:(data[i].purchaseUrl!=''),downloadUrl:data[i].downloadUrl,artworkUrl:data[i].artworkUrl,purchaseUrl:data[i].purchaseUrl,streamUrl:data[i].streamUrl,onBandPage:data[i].onBandPage,public:data[i].public};trackDOM=$('<a href="#add-track"></a>');trackDOM.text(track.title).attr('id','sc-track-'+track.sourceId);trackDOM.wrap('<li id="rm-track-'+track.sourceId+'"></li>').parent().appendTo(trackList);if(!track.onBandPage){trackDOM.append('<em class="hover-help">Add to '+getGlobal('brand')+'</em>');}else{trackDOM.addClass('disabled').append('<em>Currently on '+getGlobal('brand')+'</em>').removeAttr('href');}
_trackManager.storeTrack(track);}}else{if($('.no-sc-tracks','#soundcloud-default-state').length<1){$('#sc-track-chooser').hide();$('<p class="message warning no-sc-tracks">No SoundCloud tracks are currently linked to your account.<br />Please upload some tracks from your computer first.</p>').insertAfter($('#sc-track-chooser'));}}
trackList.stop().animate({opacity:1},250);}else{debug('something went wrong... or you have no tracks. data=');debug(data);}}});}},updateAvailableTrackList:function(){var trackIdTokens;var trackId;var track;var _trackManager=this;$('.rm-track-selector-tracks','#soundcloud-default-state').children('li').each(function(){trackIdTokens=$(this).attr('id').split('-');trackId=trackIdTokens[trackIdTokens.length-1];track=_trackManager.getTrack(trackId);if(track&&track.onBandPage){$(this).children('a').addClass('disabled').find('em').removeClass('hover-help').text('Currently on '+getGlobal('brand'));}else{$(this).children('a').removeClass('disabled').find('em').addClass('hover-help').text('Add to '+getGlobal('brand'));}
debug('updated track '+trackId);});},cancelHandler:function(event){if($(event.target).closest(event.data.widget._trackEditor.selector).length==0&&$(event.target).closest(event.data.widget._trackSelector.selector).length==0){event.data.widget.saveCurrentToPlaylist();event.data.widget.deactivate();}
debug('in cancel handler.');},playlistFilterHandler:function(event){var trackItems=$('.rm-track-selector-tracks','#soundcloud-default-state').children('li');var scId=$(event.currentTarget).val();if(scId){$('#sc-playlist-filter').addClass('loading');$.ajax({url:'/soundcloud/getTracksByPlaylist',type:'post',dataType:'json',data:{rmPageId:event.data.widget._postData.rmPageId,bandId:event.data.widget._postData.bandId,scPlaylistId:scId},success:function(data,response){trackItems.hide();if(data&&data.length){var track=false;for(var i=0;i<data.length;i++){track=data[i];trackItems.filter('[id$='+track.scId+']').show();}}else{if($('.empty-message',trackItems.parent()).length){$('.empty-message',trackItems.parent()).show();}else{$('<li class="empty-message">No SoundCloud tracks available.<br />Try uploading a new one by clicking the button above!</li>').appendTo(trackItems.parent());}}
$('#sc-playlist-filter').removeClass('loading');}});}else{trackItems.show();if(trackItems.not('.empty-message').length){$('.empty-message',trackItems.parent()).hide();}}},songUploadHandler:function(event){switch(event.type){case'uploadselect':this._uploading=true;break;case'uploadstart':debug('START');var track={serviceType:this.SERVICE_TYPE_SOUNDCLOUD,title:event.data.filename,downloadable:false,purchasable:false,duration:0,artworkUrl:'',downloadUrl:'',purchaseUrl:'',streamUrl:'',onBandPage:false,uploadQueueID:event.queueID};this.storeTrack(track);this.openTrackInfo(track);debug('locking track editor...');this.lockTrackEditor();break;case'uploadprogress':debug('PROGRESS, percentage='+event.data.percentage+', queueID='+event.queueID);if(this.getSelectedTrack().uploadQueueID==event.queueID){$('.progress','#track-upload-notification').css({width:Math.round(event.data.percentage)+'%'});if(event.data.percentage>99){$('.progress-notification','#track-upload-notification').text('Sending to SoundCloud...').addClass('loading');}else{$('.progress-notification','#track-upload-notification').text('Uploading... '+event.data.percentage+'%');}}else{var updatedTrack=this.getTrackByUploadID(event.queueID);if(updatedTrack){debug('updatedTrack is '+updatedTrack.queueID);}else{debug('The queue ID could not be found '+event.queueID);}}
break;case'uploadcomplete':debug('COMPLETE');var selected=this.getSelectedTrack();debug(event.data.response);var responseData=eval('('+event.data.response+')');debug(responseData);var scId=0;if(selected.uploadQueueID==event.queueID){selected.sourceId=responseData.scId;selected.duration=responseData.duration;selected.downloadUrl=responseData.downloadUrl;selected.streamUrl=responseData.streamUrl;selected.uploadQueueID=false;this.storeTrack(selected);$('#track-upload-notification').fadeOut(function(){$('#track-editor-actions').fadeIn('fast');});this.updateTrackEditorUI();scId=selected.sourceId;}else{debug('not currently editing this track...')
var updatedTrack=this.getTrackByUploadID(event.queueID);if(updatedTrack){updatedTrack.sourceId=responseData.scId;updatedTrack.duration=responseData.duration;updatedTrack.downloadUrl=responseData.downloadUrl;updatedTrack.streamUrl=reseponseData.streamUrl;updatedTrack.uploadQueueID=false;this.storeTrack(updatedTrack);scId=updatedTrack.sourceId;}}
this.startSongUploadPoller(scId);this.unlockTrackEditor();this._needSCUpdate=true;this._uploading=false;break;case'uploadcancel':this.unlockTrackEditor();$('.progress-notification','#track-upload-notification').text('Song upload cancelled.');$('.progress','#track-upload-notification').addClass('cancelled').css({width:'100%'}).text('Song upload cancelled.');var _trackManager=this;setTimeout(function(){if(_trackManager.lastState){_trackManager.previousState();}else{_trackManager.deactivate();}},1500);break;case'uploaderror':debug(event.error);this.unlockTrackEditor();break;default:debug('songUploadHandler: got weird event type: '+event.type);break;}},artworkUploadHandler:function(event){debug('in artwork handler.');switch(event.type){case'uploadstart':debug('artwork upload started.');if($('.artwork-upload-progress',this._trackArtworkUploader._domTarget).length){$('.artwork-upload-progress',this._trackArtworkUploader._domTarget).children('.progress-bar').css({width:0}).end().fadeIn('fast');}else{debug('adding progress indicator...');$('<div class="artwork-upload-progress"><div class="progress-bar">&nbsp;</div></div>').appendTo(this._trackArtworkUploader._domTarget).children('.progress-bar').css({width:0});}
break;case'uploadprogress':$('.progress-bar',this._trackArtworkUploader._domTarget).css({width:event.data.percentage+'%'});break;case'uploadcomplete':$('.artwork-upload-progress',this._trackArtworkUploader._domTarget).fadeOut();debug('got complete event');var targetTrack=this.getTrack(this._trackArtworkUploader._scTrackId);if(event.data.response.artworkUrl&&event.data.response.artworkUrl!=targetTrack.artworkUrl){var newArtwork=event.data.response.artworkUrl;debug('got new artwork url, old = '+targetTrack.artworkUrl+', new='+newArtwork);debug('not so fast! image might not be available... >:(((((');$('img',this._trackArtworkUploader._domTarget).hide();$(this._trackArtworkUploader._domTarget).addClass('loading-artwork');var _trackManager=this;var pollRate=2000;var pollLimit=60;var pollCount=0;var artworkLoadInterval=setInterval(function(){var testImage=new Image();$(testImage).load(function(){$('img',_trackManager._trackArtworkUploader._domTarget).attr('src',newArtwork).fadeIn();$(_trackManager._trackArtworkUploader._domTarget).removeClass('loading-artwork');clearInterval(artworkLoadInterval);}).attr('src',newArtwork);pollCount++;if(pollCount>pollLimit){clearInterval(artworkLoadInterval);debug('Unable to load the new Artwork. Try a page reload to see if the image you just uploaded is now available.');}},2000);var currentTrack=this.getSelectedTrack();currentTrack.artworkUrl=newArtwork;if(currentTrack.onBandPage){this.saveTrackToPlaylist(currentTrack);}else{this.storeTrack(currentTrack);}
this.setSelectedTrack(currentTrack);}else{debug('wheres the artwork url? soundcloud... :(');$('img',this._trackArtworkUploader._domTarget).hide();this.startTrackArtworkPoller(this._trackArtworkUploader._scTrackId);}
break;case'uploadcancel':break;case'uploaderror':debug(event.error);break;default:debug('artworkUploadHandler: got weird event type: '+event.type);break;}},startTrackArtworkPoller:function(scTrackId){if(!this.isPollingArtwork(scTrackId)){var _trackManager=this;var intervalId=setInterval(function(){$.ajax({url:'/soundcloud/getTrack',type:'post',dataType:'json',data:{bandId:_trackManager._postData.bandId,scTrackId:scTrackId},success:function(data,response){debug(data);if(data&&data['artwork-url']){var track=_trackManager.getTrack(scTrackId);if(track){if(track.artworkUrl!=data['artwork-url']&&(typeof(data['artwork-url'])=='string')){track.artworkUrl=data['artwork-url'];if(track.onBandPage&&scTrackId!=_trackManager.getSelectedTrack().sourceId){_trackManager.saveTrackToPlaylist(track);}else{_trackManager.storeTrack(track);}
if(scTrackId==_trackManager.getSelectedTrack().sourceId){debug('refreshing artwork preview...');if(typeof(track.artworkUrl)!='string'){debug('not so fast! image might not be available... >:(((((');}
var pollRate=2000;var pollLimit=60;var pollCount=0;var artworkLoadInterval=setInterval(function(){var testImage=new Image();if(typeof(track.artworkUrl)=='string'){$(testImage).load(function(){if(typeof(track.artworkUrl)=='string'){$('img',_trackManager._trackArtworkUploader._domTarget).attr('src',track.artworkUrl).fadeIn();}
clearInterval(artworkLoadInterval);}).attr('src',track.artworkUrl);}else{pollCount++;if(pollCount>pollLimit){clearInterval(artworkLoadInterval);debug('SoundCloud api will not update the Artwork. Try a page reload to see if the image you just uploaded is now available.');}}},pollRate);_trackManager.setSelectedTrack(track);}
_trackManager.removeTrackArtworkPoller(scTrackId);}else{debug('artworkPoller['+scTrackId+']:: artwork cache not updated, trying again...');}}else{debug('artworkPoller['+scTrackId+']:: invalid (null) response from SoundCloud, trying again...');}}},error:function(error){}});},7500);this._artworkPollers.push({scTrackId:scTrackId,intervalId:intervalId});}},isPollingArtwork:function(scTrackId){for(var i=0;i<this._artworkPollers.length;i++){if(this._artworkPollers[i].scTrackId==scTrackId){return true;}}
return false;},removeTrackArtworkPoller:function(scTrackId){for(var i=0;i<this._artworkPollers.length;i++){if(this._artworkPollers[i].scTrackId==scTrackId){clearInterval(this._artworkPollers[i].intervalId);this._artworkPollers.splice(i,1);return true;}}
return false;},startSongUploadPoller:function(scTrackId){if(!this.isPollingSong(scTrackId)){var _trackManager=this;var intervalId=setInterval(function(){$.ajax({url:'/soundcloud/getTrack',type:'post',dataType:'json',data:{bandId:_trackManager._postData.bandId,scTrackId:scTrackId},success:function(data,response){debug(data);if(data&&data['duration']){var track=_trackManager.getTrack(scTrackId);if(track){if(track.duration!=data['duration']){track.duration=data['duration'];if(track.onBandPage){_trackManager.saveTrackToPlaylist(track);}else{_trackManager.storeTrack(track);}
_trackManager.removeSongUploadPoller(scTrackId);}else{debug('songPoller['+scTrackId+']:: track cache not updated, trying again...');}}else{debug('songPoller['+scTrackId+']:: invalid (null) response from SoundCloud, trying again...');}}},error:function(error){}});},7500);this._trackPollers.push({scTrackId:scTrackId,intervalId:intervalId});}},isPollingSong:function(scTrackId){for(var i=0;i<this._trackPollers.length;i++){if(this._trackPollers[i].scTrackId==scTrackId){return true;}}
return false;},removeSongUploadPoller:function(scTrackId){for(var i=0;i<this._trackPollers.length;i++){if(this._trackPollers[i].scTrackId==scTrackId){clearInterval(this._trackPollers[i].intervalId);this._trackPollers.splice(i,1);return true;}}
return false;},youTubeInputHandler:function(){var videoLink=this._ytInputter._inputField.val();var statusMsg=$('.instr','#yt-track-input');statusMsg.data('old_text',statusMsg.text());if(statusMsg.is(':hidden')){statusMsg.fadeIn();}
statusMsg.text('Getting YouTube info...').addClass('loading');var _trackManager=this;$.ajax({url:'/getajax/getYouTube',type:'post',dataType:'json',data:{link:videoLink},success:function(data,response){if(data&&!data.error){if(data.embed){debug(data);track={serviceType:_trackManager.SERVICE_TYPE_YOUTUBE,sourceId:data.id,streamUrl:data.streamUrl,title:data.title,description:data.description,duration:data.duration,downloadable:false,purchasable:false,artworkUrl:data.image,purchaseUrl:'',onBandPage:false,public:true};debug(track);_trackManager.storeTrack(track);_trackManager.openTrackInfo(track);}else{_trackManager.displayVideoEmbedError();}}else{_trackManager.displayVideoInvalidError();}
_trackManager._ytInputter.clear();statusMsg.removeClass('loading').hide().text(statusMsg.data('old_text'));}});},buttonHandler:function(event){var targetId=$(event.currentTarget).attr('id');debug(targetId);switch(targetId){case'add-file-track-button':$('.default-message').hide().siblings('.intro-message').show();event.data.widget.openSoundCloudManager();break;case'add-sc-track-button':$('.intro-message').hide().siblings('.default-message').show();event.data.widget.openSoundCloudManager();break;case'add-yt-track-button':event.data.widget.openYouTubeManager();break;case'save-to-bandpage-button':event.data.widget.saveCurrentToPlaylist();event.data.widget.deactivate();break;case'back-to-selector-button':event.data.widget.previousState();break;case'close-track-selector-button':case'cancel-track-changes-button':event.data.widget.deactivate();break;case'cancel-song-upload-button':if(event.data.widget.getSelectedTrack().uploadQueueID){event.data.widget._songUploader.cancel(event.data.widget.getSelectedTrack().uploadQueueID);event.data.widget._directSongUploader.cancel(event.data.widget.getSelectedTrack().uploadQueueID);}else{debug('Selected song isn\'t uploading! Can\'t cancel.');}
break;default:if(targetId.search(/remove-track/)>-1){if(confirm('Are you sure you want to remove the track from your playlist? You may have to re-enter its information if you want to add it again...')){var idTokens=targetId.split('-');event.data.widget.removeTrackFromPlaylist(idTokens[idTokens.length-1]);}}
break;}
event.stopPropagation();return false;},handleBuyLinkEvent:function(event){if($(event.target).closest('.rm-buy-link-input').length){event.stopPropagation();}else{event.data.elem.fadeOut();}},displayVideoInvalidError:function(){var message="<strong>Invalid link:</strong> Hmm... this video link doesn't seem valid. YouTube links generally look like this: http://www.youtube.com/watch?v=_______<br /><a class=\"close-button\">Click to close</a>";this.displayMessage(message);this._ytInputter.clear();},displayVideoEmbedError:function(){var message="<strong>Video not embeddable:</strong> This video doesn't seem to be embeddable. In order to get the video to play on BandPage, it needs to be public and embeddable.<br /><a class=\"close-button\">Click to close</a>";this.displayMessage(message);this._ytInputter.clear();},displayMessage:function(message){var dialog=$('.error-dialog','#yt-track-input');dialog.html(message).show().css({opacity:0}).animate({bottom:'+=20px',opacity:1},250);dialog.one('click',function(){dialog.fadeOut(function(){$(this).css({opacity:'',bottom:''});});});},clearMessages:function(){this._errDisplay.removeClass(this.MESSAGE_ERROR).removeClass(this.MESSAGE_INFO).removeClass(this.MESSAGE_WARNING);this._errDisplay.hide();},scrollToView:function(){var scrollPos=$(window).scrollTop();if(scrollPos>($('#content').height()-this._domTarget.height())){scrollPos=$('#content').height()-this._domTarget.height();}
if(scrollPos>this._scrollStartPos){this._domTarget.stop().animate({top:(scrollPos-this._scrollStartPos)+'px'},250);}else if(this._domTarget.position().top>0){this._domTarget.stop().animate({top:0},250);}},handleScroll:function(event){event.data.widget.scrollToView();return false;}});var InlineDateWidget=InlineEditWidget.extend({_name:"InlineDateWidget",_date:false,_display:{day:null,time:null},_numericDate:false,_granularity:0,_uiPanel:false,_autoSave:true,_prompt:'Please enter a date',_granularities:['year','month','day','hour','minute'],init:function(targetElement,options){this._dom.input="<input type='hidden' name='show-date' />";this._time={};this._display={day:null,time:null};this._granularity=this._granularities.length-1;this._date=false;this._autoSave=true;this._prompt='Please enter a date';this._format='D, M d';if(options){if(options.hasOwnProperty('date')){if(options.date&&typeof(options.date)==='object'){try{var timestamp=options.date.getTime();this._date=this.UTCToLocal(new Date(timestamp));}catch(err){debug(this._name+'::install, failed to parse input date: '+options.date);}}}else if(options.hasOwnProperty('timestamp')){var timestamp=parseInt(options.timestamp);if(!isNaN(timestamp)&&timestamp>0){this._date=this.UTCToLocal(new Date(timestamp));}}
if(options.hasOwnProperty('granularity')){this._granularity=this._granularities.indexOf(options.granularity);}
if(options.hasOwnProperty('autoSave')){this._autoSave=options.autoSave;}
if(options.hasOwnProperty('format')){this._format=options.format;}
if(options.hasOwnProperty('prompt')){this._prompt=options.prompt;}}
debug('granularity: '+this._granularity);this._super(targetElement,options);},formatTime:function(date){var ampm=(date.getHours()>=12)?"pm":"am";var min=(date.getMinutes()<10)?"0"+date.getMinutes():date.getMinutes();var hour=(date.getHours()%12==0)?12:date.getHours()%12;return hour+":"+min+" "+ampm;},hasGranularity:function(name){var index=this._granularities.indexOf(name);return(index>=0&&this._granularity>=index);},UTCToLocal:function(date){return new Date(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate(),date.getUTCHours(),date.getUTCMinutes(),0,0);},localToUTC:function(date){var utc_date=new Date(date);utc_date.setUTCFullYear(date.getFullYear());utc_date.setUTCMonth(date.getMonth(),date.getDate());utc_date.setUTCHours(date.getHours(),date.getMinutes(),0,0);return utc_date;},install:function(){debug('installing InlineDateWidget');this._super();this._inputField=this._inputArea.children('input');this._contentArea.empty().unbind('blur focus');if(this._date){this._inputField.val(this._date.getTime());}
this._display.day=$('<div class="day"></div>').appendTo(this._contentArea);this._display.day.text(this._date?$.datepicker.formatDate(this._format,this._date):this._prompt);if(this.hasGranularity('hour')){this._display.time=$('<div class="time"></div>').appendTo(this._contentArea);this._display.time.text(this._date?this.formatTime(this._date):'');}
if((this._uiPanel=$("#rm-inline-datepicker")).length<1){this._uiPanel=$("<div id='rm-inline-datepicker'></div>").data('InlineDateWidget',this);this._uiPanel.datepicker({dateFormat:this._format,showAnim:'fold',minDate:new Date()});this._uiPanel.prepend("<h3>Choose date</h3>");this._uiPanel.append("<h3>Choose time</h3>");this._uiPanel.append("<select name='h' id='rm-datepicker-time-h'>"+"<option selected value=1>1</option>"+"<option value=2>2</option>"+"<option value=3>3</option>"+"<option value=4>4</option>"+"<option value=5>5</option>"+"<option value=6>6</option>"+"<option value=7>7</option>"+"<option value=8>8</option>"+"<option value=9>9</option>"+"<option value=10>10</option>"+"<option value=11>11</option>"+"<option value=12>12</option>"+"</select>");this._uiPanel.append("<select name='m' id='rm-datepicker-time-m'>"+"<option selected label='00' value='0'>00</option>"+"<option label='15' value='15'>15</option>"+"<option label='30' value='30'>30</option>"+"<option label='45' value='45'>45</option>"+"</select>");this._uiPanel.append("<select name='pm' id='rm-datepicker-time-pm'>"+"<option selected label='pm' value='1'>pm</option>"+"<option label='am' value='0'>am</option>"+"</select>");$("#ui-datepicker-div").remove();$("<a href='#close-datepicker' id='rm-datepicker-close-button'>X</a>").appendTo(this._uiPanel);$("body").append(this._uiPanel);this._uiPanel.bind('click',function(e){e.stopPropagation();});}},activate:function(){if(!this._super())return false;var offset=this._domTarget.offset();this._uiPanel.data('InlineDateWidget',this).css({top:offset.top,left:offset.left}).show('fold');var datepicker_date=this._date?this._date:new Date();this._uiPanel.datepicker('setDate',new Date(datepicker_date)).datepicker('option','onSelect',function(dateText,datepicker){$(this).data('InlineDateWidget')._uiPanel.children('#rm-datepicker-time-h').focus();$('#rm-inline-datepicker').datepicker('hide',750);});var hours=(datepicker_date.getHours()!==12)?(datepicker_date.getHours()%12):12;this._uiPanel.children('#rm-datepicker-time-h').val(hours);this._uiPanel.children('#rm-datepicker-time-m').val(datepicker_date.getMinutes());var pm=(datepicker_date.getHours()>=12)?1:0;this._uiPanel.children('#rm-datepicker-time-pm').val(pm).data('original',pm);$('#rm-datepicker-close-button',this._uiPanel).bind('click',{widget:this},this.processUserEvent);return true;},deactivate:function(){if(!this._super()){return false;}
$('#rm-datepicker-close-button',this._uiPanel).unbind('click',this.processUserEvent);this._uiPanel.hide('fold');return true;},enable:function(){this._super();this._contentArea.unbind('blur focus');},changeMode:function(mode){this._super(mode);switch(mode){case'css':this.disable();break;case'content':this.enable();break;default:break;}},commit:function(){var day_ms=this._uiPanel.datepicker('getDate').getTime();var time_ms=0;if(this.hasGranularity('hour')){if(this._uiPanel.children("#rm-datepicker-time-h").val()!=12){time_ms+=parseInt(this._uiPanel.children("#rm-datepicker-time-h").val())*(60*60*1000);}
time_ms+=parseInt(this._uiPanel.children("#rm-datepicker-time-pm").val())*(12*60*60*1000);if(this.hasGranularity('minute')){time_ms+=parseInt(this._uiPanel.children("#rm-datepicker-time-m").val())*(60*1000);}}
this._date=new Date(day_ms+time_ms);this._inputField.val(this._date.getTime());this._display.day.text($.datepicker.formatDate(this._format,this._date));if(this.hasGranularity('hour')){this._display.time.text(this.formatTime(this._date));}
this._super();debug(this._date);if(this._autoSave){Saver.save(this._inputField.attr('name'),this.getDate(),{elem:this._inputField});}},getDate:function(formatted){debug('getting date, original = '+this._date);if(!this._date){return 0;}
var utc_date=this.localToUTC(this._date);return formatted?$.datepicker.formatDate(this._format,utc_date):utc_date.getTime();},needsUpdate:function(){var day_ms=this._uiPanel.datepicker('getDate').getTime();var time={hour_ms:parseInt(this._uiPanel.children("#rm-datepicker-time-h").val())*(60*60*1000),min_ms:parseInt(this._uiPanel.children("#rm-datepicker-time-m").val())*(60*1000),ampm_ms:parseInt(this._uiPanel.children("#rm-datepicker-time-pm").val())*(12*60*60*1000)};var time_ms=time.hour_ms+time.min_ms+time.ampm_ms;var time_difference=(!this._date||(this._date.getTime()!==(new Date(day_ms+time_ms)).getTime()));var $ampm=this._uiPanel.children('#rm-datepicker-time-pm');var ampm_shift=($ampm.val()!=$ampm.data('original'));return(time_difference||ampm_shift);},processUserEvent:function(event,doSuper){if(doSuper)return this._super(event);switch(event.type){case'focus':event.stopPropagation();return false;break;case'blur':event.stopPropagation();return false;break;case'click':if(event.currentTarget==$('#rm-datepicker-close-button').get(0)){debug('clicked on close button.');event.data.widget.deactivate();event.stopPropagation();return false;}
break;default:break;}
event.stopPropagation();if(event.data&&event.data.widget)return event.data.widget.processUserEvent(event,true);}});var AutocompleteWidget=TextInlineEditWidget.extend({_autoFilled:false,init:function(targetElement,options){this._apiID=options.api;this._super(targetElement,options);this._autoSave=false;this._autoFilled=false;},commit:function(usingAutocomplete){this._super();var _widget=this;var autocomplete=_widget._inputField.autocomplete('widget');debug(autocomplete.position().top);if(parseInt(autocomplete.position().top)==0){autocomplete.hide();debug('hid autocomplete window...');}else{autocomplete.slideUp('fast');}
setTimeout(function(){if(!usingAutocomplete||_widget._autoFilled){var showId=$(_widget._inputField).closest('li').attr("id");showId=showId.substr(showId.lastIndexOf("-")+1);var venue=_widget.getValue();debug('AutoCompleteWidget.commit:: no autocomplete, saving: '+venue+', for showId: '+showId);var venueData={value:venue,showId:showId};Saver.save('show-venue',venueData,{elem:_widget._inputField});if(!venue||venue==''||venue.length<1){debug('AutoCompleteWidget::commit: clearing the venue also erases the city');var _cityWidget=_widget._domTarget.siblings('[name="show-city"]').data('TextInlineEditWidget');var cityData={value:'',showId:showId};Saver.save('show-city',cityData,{elem:_cityWidget._inputField});}}},750);},install:function(targetElement){this._super(targetElement);switch(this._apiID){case'sonicliving':var _widget=this;if(getGlobal('vendor').toLowerCase()=='rootmusic'){this._inputField.autocomplete({source:function(request,response){$.ajax({url:'/sonicliving/venue/'+request.term,dataType:'json',data:{},success:function(data){if(!_widget._active){return false;}
response($.map(data.results,function(item){return{label:item.venueName+', '+item.location,value:item.venueName,venueName:item.venueName,sonicLivingId:item.sonicLivingId,address:item.address,phone:item.phone,latitude:item.latitude,longitude:item.longitude,location:item.location};}));},error:function(data){return false;}})},minLength:1,open:function(event,ui){_widget._inputField.parent().removeClass('loading');var autocomplete_window=_widget._inputField.autocomplete('widget');autocomplete_window.append('<a class="sonicliving-backlink" href="http://www.sonicliving.com/" title="SonicLiving" target="_blank">SonicLiving</a>');},search:function(event,ui){_widget._inputField.parent().addClass('loading');},select:function(event,ui){_widget._autoFilled=true;_widget._inputField.val(ui.item.venueName);_widget.commit(true);var _cityWidget=_widget.getWidget('TextInlineEditWidget',_widget._domTarget.siblings('[name="show-city"]'));if(_cityWidget){_cityWidget._inputField.val(ui.item.location);_cityWidget._contentArea.text(ui.item.location);}else{debug(_widget._name+'::autocomplete:focus: couldn\'t find city field');}
var showId=$(_widget._inputField).closest('li').attr("id");showId=showId.substr(showId.lastIndexOf("-")+1);debug('AutoCompleteWidget.select:: saving for showId = '+showId);var cityData={value:ui.item.location,showId:showId}
var venueData=$.extend({showId:showId},ui.item);debug(venueData);Saver.save('show-city',cityData,{elem:_cityWidget._inputField});Saver.save('show-venue-sonicliving',venueData,{elem:_widget._inputField});return false;},change:function(event,ui){_widget._autoFilled=false;}});}
break;default:break;}},closeAutocomplete:function(){this._inputField.autocomplete('close');}});var TouringScheduleWidget=RMUIWidget.extend({_name:"TouringScheduleWidget",_table:false,_rows:false,_adConnect:false,_editors:false,_prompts:{},_EXAMPLE_TABLE_ROW:$('<li class="rm-css-example-row rm-css-edit bg bgtrans fg fgtype">'+'<div class="tour-sched-when ts-col">'+'<div name="show-date"><span class="day">Mon, Jan 01</span><br/><span class="time">12:00 am</span></div>'+'</div>'+'<div class="tour-sched-where ts-col">'+'<div name="show-venue">[Example] Venue</div><div name="show-city">[Example] City</div>'+'</div>'+'<div class="tour-sched-price ts-col"><div name="show-price">free</div></div>'+'<div class="tour-sched-actions ts-col"></div>'+'<div class="tour-sched-more-info ts-col"><div class="tour-sched-who"><div name="show-supporting">[Example] {{ example-supporting }}</div></div></div>'+'</li>'),init:function(targetElement,options){this._currentTime=(new Date()).getTime();this._prompts={add:'Add Show','example-supporting':'Band Name 1, Band Name 2'};if(options){if(options.hasOwnProperty('date')){this._currentTime=options.date;}
if(options.hasOwnProperty('prompts')){$.extend(this._prompts,options.prompts);}
this._EXAMPLE_TABLE_ROW.html(this._EXAMPLE_TABLE_ROW.html().replace(/\{\{ example-supporting \}\}/g,this._prompts['example-supporting']));}
this._super(targetElement,options);},install:function(){this._super();this._table=this._domTarget;this._rows=this._table.children('li:not(#rm-tour-sched-header)');this._editors=new Array();var _tourSched=this;this._rows.each(function(){_tourSched.installRow(this);});$('#action-add-show').bind('click',$.proxy(function(e){this.addShow();return false;},this));if(this._prompts.hasOwnProperty('add')){$('#action-add-show').text(this._prompts.add);}
$('.rm-buy-link',this._domTarget).live('click',function(ce){var inputField=$(ce.currentTarget).siblings('.rm-buy-link-input');if(inputField.is(':hidden')){$('.rm-buy-link',_tourSched._domTarget).siblings('.rm-buy-link-input').hide();inputField.css({display:'block',opacity:0,bottom:function(indx,val){return(parseInt(val)-10);}}).animate({opacity:1,bottom:'+=10px'},250,function(){$(this).css({bottom:''});});$('body').bind('click',{widget:_tourSched,elem:inputField},_tourSched.handleBuyLinkEvent);}else{inputField.fadeOut();}
return false;});this.sortRows();this._adConnect=this._domTarget.hasClass('artistdata-connect');RMUIWidgetRelay.addCallback('artistdata-connect',this,this.handleArtistData);if(this._adConnect){for(var i=0;i<this._editors.length;i++){this._editors[i].disable();}
this._rows.find('.delete-show, .rm-buy-link').hide();$('#artistdata-overlay').fadeIn();}},installRow:function(row){var showId=$(row).attr('id').split('-').pop();$('.hidden',row).removeClass('hidden').hide();var _tourSched=this;$('.rm-inline-edit',row).each(function(){var $this=$(this);var widget;var options={enableGlobalCallbacks:false};if(_tourSched._prompts.hasOwnProperty($this.attr('name'))){$.extend(options,{prompt:_tourSched._prompts[$this.attr('name')]});}
if($this.hasClass('autocomplete')){if($this.hasClass('sonicliving')){options=$.extend(options,{api:'sonicliving'});}
widget=new AutocompleteWidget($(this),options);}else if($this.hasClass('date')){var timestamp=parseInt($this.text());widget=new InlineDateWidget($this,$.extend(options,{timestamp:timestamp,autoSave:false}));widget.addCallback('update',_tourSched,_tourSched.handleDateUpdated,showId);}else{widget=new TextInlineEditWidget($this,$.extend(options,{autoSave:false}));widget.addCallback('update',_tourSched,_tourSched.handleSave,showId);}
if(widget){_tourSched._editors.push(widget);}});$('.delete-show',row).each(function(){$(this).bind('click',{widget:_tourSched,showId:showId},_tourSched.deleteShow);});},changeMode:function(mode){switch(mode){case'css':this.disable();break;case'content':this.enable();break;default:break;}},enable:function(){this._super();if(this._adConnect){$('#action-artistdata-add-show, #artistdata-overlay').fadeIn();this._domTarget.css({opacity:''});}else{$('#action-add-show').fadeIn();for(var i=0;i<this._editors.length;i++){this._editors[i].enable();}
this._rows.find('.delete-show, .rm-buy-link').fadeIn();}
$('.rm-css-example-row','#rm-tour-sched').fadeOut(function(){$(this).remove();});},disable:function(fadeOut){this._super();for(var i=0;i<this._editors.length;i++){this._editors[i].disable();}
this._rows.find('.delete-show, .rm-buy-link').fadeOut();if(this._adConnect){$('#action-artistdata-add-show, #artistdata-overlay').fadeOut();this._domTarget.animate({opacity:1},250);}else{$('#action-add-show').fadeOut();}
var tourSchedRows=$('li','#rm-tour-sched').not('#rm-tour-sched-header');switch(tourSchedRows.length){case 0:var cloneEl=$(this._EXAMPLE_TABLE_ROW).clone();$('#rm-tour-sched').append(cloneEl.addClass('even').attr('rel','rm-css-ts-even'));cloneEl.data('css',{'font-family':cloneEl.css('fontFamily'),'font-size':cloneEl.css('fontSize'),'font-style':cloneEl.css('fontStyle'),'font-weight':cloneEl.css('fontWeight'),'letter-spacing':cloneEl.css('letterSpacing'),'text-transform':cloneEl.css('textTransform'),'background-color':cloneEl.css('backgroundColor')});case 1:var cloneEl=$(this._EXAMPLE_TABLE_ROW).clone();$('#rm-tour-sched').append(cloneEl.addClass('odd').attr('rel','rm-css-ts-odd'));cloneEl.data('css',{'font-family':cloneEl.css('fontFamily'),'font-size':cloneEl.css('fontSize'),'font-style':cloneEl.css('fontStyle'),'font-weight':cloneEl.css('fontWeight'),'letter-spacing':cloneEl.css('letterSpacing'),'text-transform':cloneEl.css('textTransform'),'background-color':cloneEl.css('backgroundColor')});break;default:break;}
if(fadeOut){this._domTarget.animate({opacity:0.2},250);}},addShow:function(show){var _tourSched=this;var showData={name:'',date:-1,price:'',venue:'',city:''};Saver.save('show-add',showData,{success:function(data){if(!data.hasOwnProperty('shows')||data.shows.length<1){debug(_tourSched._name+'::addShow, got empty show response.');return false;}
var showId=data.shows[0].id;var showRow=_tourSched.createShowDom(showId);showRow.insertAfter($('#rm-tour-sched-header'));_tourSched._rows=_tourSched._table.children('li:not(#rm-tour-sched-header)');_tourSched.installRow(showRow);_tourSched.activateRow(showId);_tourSched.sortRows();}});},createShowDom:function(showId){var showRow='<li id="rm-show-'+showId+'" class="added rm-css-edit fg fgtype bg bgtrans">';showRow+='<div class="tour-sched-when ts-col"><div name="show-date" class="rm-inline-edit date"></div></div>';showRow+='<div class="tour-sched-where ts-col"><div name="show-venue" class="rm-inline-edit autocomplete sonicliving"></div><div name="show-city" class="rm-inline-edit"></div></div>';showRow+='<div class="tour-sched-price ts-col"><div name="show-price" class="rm-inline-edit"></div></div>';showRow+='<div class="tour-sched-actions ts-col"><a href="#delete-show" title="delete this show?" class="delete-show" name="'+showId+'">remove</a><a id="edit-ticket-link-'+showId+'" class="rm-buy-link" href="#show-buy-'+showId+'" title="Change or add a ticket purchase link">Edit purchase url</a><em class="rm-buy-link-input hidden">URL: <span class="rm-inline-edit" name="show-purchase-url"></span></em></div>';showRow+='<div class="tour-sched-more-info ts-col"><div class="tour-sched-who"><div name="show-supporting" class="rm-inline-edit"></div></div></div>';showRow+='</li>';return $(showRow);},deleteShow:function(e){if(confirm("Are you sure you want to remove this show?")){var _tourSched=e.data.widget;var showId=e.data.showId;var targetRow=$('#rm-show-'+showId);Saver.save('show-remove',showId,{error:function(err){targetRow.addClass('error').fadeIn();}});targetRow.fadeOut(400,function(){targetRow=$(this).detach();_tourSched._rows=_tourSched._table.children('li:not(#rm-tour-sched-header)');_tourSched.sortRows();});}
return false;},sortRows:function(){var rowSelector='li:not(#rm-tour-sched-header)';if(!this._table){this._table=$('#rm-tour-sched');this._rows=this._table.children(rowSelector);}
var _tourSched=this;var sortedRows=this._rows.detach().get().sort($.proxy(function(a,b){var date_a=this.getWidget('InlineDateWidget',$(a).find('.rm-inline-edit.date')).getDate();var date_b=this.getWidget('InlineDateWidget',$(b).find('.rm-inline-edit.date')).getDate();debug('comparing '+date_a+' to '+date_b);if(date_a<date_b)return-1;else if(date_a>date_b)return 1;else return 0;},this));debug(sortedRows);this._table.append(sortedRows);this._rows=this._table.children(rowSelector);this._rows.removeClass('odd').attr('rel','rm-css-ts-even').filter(':odd').addClass('odd').attr('rel','rm-css-ts-odd');setTimeout($.proxy(function(){this._rows.filter('.active').each(function(){var $this=$(this);$this.css({zIndex:1}).children().animate({opacity:0.2},500).animate({opacity:1},500,function(){$this.removeClass('active');setTimeout(function(){$this.css({zIndex:''});},500);});});},this),500);},handleDateUpdated:function(showId,dateWidget){this.activateRow(showId);this.sortRows();Saver.save(dateWidget._inputField.attr('name'),{showId:showId,date:dateWidget.getDate()});},activateRow:function(showId){$('#rm-show-'+showId).addClass('active');},handleArtistData:function(artistdata_key){if(this._domTarget.height()<200){this._domTarget.data('old_height',this._domTarget.height()).animate({height:'200px'},350);}
var infoDom=$('.artistdata-key-info','#artistdata-overlay');$('.key-display',infoDom).text(artistdata_key);infoDom.siblings('h3').removeClass('loading').text('Your ArtistData key is:');for(var i=0;i<this._editors.length;i++){this._editors[i].disable();}
this._rows.find('.delete-show, .rm-buy-link').hide();$('#artistdata-overlay').fadeIn();this._domTarget.addClass('artistdata-connect');this._adConnect=true;$('#action-add-show').text('Add show on ArtistData').unbind('click').attr({href:'http://www.artistdata.com/dashboard/tour/shows/add',id:'action-artistdata-add-show',target:'_blank'});},handleBuyLinkEvent:function(event){if($(event.target).closest('.rm-buy-link-input').length&&!$(event.target).hasClass('rm-buy-link')){event.stopPropagation();}else{event.data.elem.fadeOut();$('body').unbind('click',event.data.widget.handleBuyLinkEvent);}},handleSave:function(showId,widget){var data={};var fieldName=widget._inputField.attr('name');data.showId=showId;data.value=widget.getValue();var options={elem:widget._inputField};switch(fieldName){case'show-purchase-url':options.success=function(data){if(!data.hasOwnProperty('shows')||data.shows.length<1){debug(this._name+'::handleSave, got empty response');return false;}
var purchaseUrl=data.shows[0].ticketPurchaseUrl;if(purchaseUrl.length>0){$('#edit-ticket-link-'+showId).addClass('active');}else{$('#edit-ticket-link-'+showId).removeClass('active');}};break;}
debug('TouringScheduleWidget.handleSave:: '+fieldName+' => '+data.value);Saver.save(fieldName,data,options);}});